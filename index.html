<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Reto del Diccionario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fondo gris claro */
            color: #1f2937;
        }
        .card {
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .rainbow-text {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: rainbow 2s ease-in-out infinite;
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .super-value-text {
            color: #ef4444; /* Rojo intenso */
            font-weight: bold;
        }
        #startupScreen, .modal-bg {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }
        
        #limboGramaticalBox {
            border: 4px solid;
            border-image-slice: 1;
            border-image-source: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            animation: rainbow-border-animation 2s linear infinite;
        }
        @keyframes rainbow-border-animation {
            to { border-image-source: linear-gradient(-45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3); }
        }

        .glitch-wrapper {
            position: relative;
        }

        .glitch-text::before,
        .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff; 
            overflow: hidden;
            clip-path: inset(50% 50% 50% 50%);
        }

        .glitch-text::before {
            left: -2px;
            text-shadow: 2px 0 blue;
            animation: glitch-anim-2 1.5s infinite linear alternate-reverse;
        }

        .glitch-text::after {
            left: 2px;
            text-shadow: -2px 0 red;
            animation: glitch-anim-1 2s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim-1 {
            0%, 100% { clip-path: inset(40% 0 61% 0); }
            25% { clip-path: inset(15% 0 75% 0); }
            50% { clip-path: inset(50% 0 45% 0); }
            75% { clip-path: inset(5% 0 85% 0); }
        }
        @keyframes glitch-anim-2 {
            0%, 100% { clip-path: inset(65% 0 30% 0); }
            25% { clip-path: inset(80% 0 15% 0); }
            50% { clip-path: inset(40% 0 50% 0); }
            75% { clip-path: inset(90% 0 5% 0); }
        }

        .flicker-anim {
            animation: flicker-animation 1s infinite;
        }

        @keyframes flicker-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .prestige-glow {
            box-shadow: 0 0 8px 2px rgba(251, 191, 36, 0.7); /* Amarillo-dorado para el brillo */
        }
        
        .luck-glow {
             box-shadow: 0 0 10px 3px rgba(34, 197, 94, 0.6); /* Verde para la suerte */
             animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 10px 3px rgba(34, 197, 94, 0.6); }
            50% { box-shadow: 0 0 14px 5px rgba(34, 197, 94, 0.8); }
            100% { box-shadow: 0 0 10px 3px rgba(34, 197, 94, 0.6); }
        }

    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal min-h-screen">
    <!-- Pantalla de Inicio -->
    <div id="startupScreen" class="fixed inset-0 modal-bg flex flex-col items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="text-center w-full max-w-4xl mx-auto">
            <h1 class="text-4xl sm:text-6xl font-black text-blue-900 mb-8">EL RETO DEL DICCIONARIO</h1>
            <div class="flex flex-col items-center gap-4">
                <div class="flex flex-col sm:flex-row justify-center items-stretch gap-4 w-full">
                    <button id="playGameButton" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 transform hover:scale-105 text-lg sm:text-xl">
                        JUGAR
                    </button>
                    <button id="tutorialButton" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 transform hover:scale-105 text-lg sm:text-xl">
                        Tutorial
                    </button>
                </div>
                <button id="resetProgressButton" class="text-sm text-gray-500 hover:text-red-500 hover:underline hidden">Reiniciar progreso</button>
            </div>
        </div>
        <p class="absolute bottom-4 text-xs text-gray-400 text-center">© 2025 El Reto del Diccionario | Desarrollado por Didac-Click Group.</p>
    </div>
    
    <!-- Tutorial Modal -->
    <div id="tutorialScreen" class="fixed inset-0 modal-bg hidden flex items-center justify-center p-4 z-[100]">
        <div class="w-full max-w-3xl bg-white p-6 rounded-xl shadow-2xl max-h-[90vh] hide-scrollbar overflow-y-auto border-4 border-blue-300">
            <div id="integratedTutorial" class="text-left text-gray-800">
                <h2 class="text-2xl font-extrabold text-blue-800 mb-3 text-center">¿Cómo se juega?</h2>
                <p class="text-md text-gray-700 mb-4 leading-relaxed text-center">
                    El objetivo es acumular <span class="font-bold text-blue-700">palabras</span> y <span class="font-bold text-green-700">dinero</span> para dominar la acentuación.<br>
                    <span class="text-sky-600 font-semibold">Ganas al conseguir la palabra <span class="underline decoration-sky-400">Sobreesdrújula</span>.</span>
                </p>
                <ol class="list-decimal pl-5 space-y-3 text-sm text-gray-600">
                    <li>
                        <span class="font-bold">Objetivo:</span> Compra palabras para ganar dinero pasivo. Reúne 30 de cada categoría para desbloquear y comprar la palabra <span class="font-bold text-purple-700">Sobreesdrújula</span> y ganar.
                    </li>
                    <li>
                        <span class="font-bold">El Desafío:</span> Ocasionalmente, se te pedirá escribir una palabra de una categoría en 30s. ¡Cuidado! 3 fallos reinician tu progreso.
                    </li>
                     <li>
                        <span class="font-bold">Bonus y Eventos:</span> Busca palabras <strong class="super-value-text">Super Value</strong> (rojas) para potenciar una categoría, o el <strong>Bonus <span class="rainbow-text">CHRISTOPHER</span></strong> para potenciar todo. ¡Mantente alerta a eventos raros como el <span class="glitch-wrapper"><strong class="rainbow-text glitch-text flicker-anim" data-text="Limbo Gramátical: ???">Limbo Gramátical: ???</strong></span>!
                    </li>
                    <li>
                        <span class="font-bold">Tienda y Prestigio:</span> Usa la <span class="font-bold">Tienda</span> para comprar Vidas y Escudos. Al ganar y <span class="font-bold text-purple-700">Formatear</span>, obtienes un multiplicador permanente y <span class="font-bold text-yellow-700">Puntos de Prestigio</span>, que puedes usar para mejoras haciendo clic en el botón del multiplicador.
                    </li>
                </ol>
            </div>
             <div class="text-center w-full">
                <button id="backToGameFromTutorial" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 mt-6">
                    Cerrar
                </button>
            </div>
        </div>
    </div>


    <!-- Game Container -->
    <div class="container mx-auto p-2 flex flex-col items-center min-h-screen">
        <div id="gameScreen" class="flex flex-col items-center w-full">
            <div class="flex flex-col lg:flex-row justify-center items-stretch w-full gap-4">
                
                <div class="flex flex-col items-center justify-center flex-1 text-center border p-4 rounded-xl shadow-lg card">
                    <h2 class="text-xl font-bold text-green-700">Tu Riqueza</h2>
                    <p id="playerMoney" class="text-2xl sm:text-3xl font-extrabold text-green-800 mt-2">0</p>
                    <p class="text-sm text-gray-500 mt-1">
                        Ingreso Pasivo: <span id="passiveIncome" class="font-bold">0.0</span>/seg
                        <span id="prestigeIncomeBonus" class="hidden text-yellow-500 font-bold text-xs ml-1"></span>
                    </p>
                </div>

                <div class="flex flex-col items-center flex-1 text-center border p-4 rounded-xl shadow-lg card">
                    <h3 class="text-xl font-bold mb-2">Palabra Actual</h3>
                    <p id="currentWord" class="text-3xl sm:text-5xl font-black mb-1">Cargando...</p>
                    <p id="wordCategory" class="text-md font-semibold text-gray-500 mb-1"></p>
                    <p id="wordValue" class="text-md font-extrabold text-blue-700"></p>
                    <div class="flex justify-center space-x-2 mt-2">
                        <button id="buyButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 text-sm">
                            Comprar
                        </button>
                    </div>
                    <div id="wordTimerBarContainer" class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div id="wordTimerBar" class="h-2.5 rounded-full" style="width: 100%; transition: width 0.05s linear, background-color 0.5s ease;"></div>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap lg:flex-nowrap w-full gap-4 mt-4 text-center border p-4 rounded-xl shadow-lg card">
                <div class="w-full">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Tu Colección de Palabras</h2>
                    <div id="inventoryContainer" class="flex flex-row overflow-x-auto whitespace-nowrap space-x-2 p-2">
                    </div>
                </div>
            </div>
            
            <div id="rulesContainer" class="w-full mt-4 text-center border p-4 rounded-xl shadow-lg hidden flex flex-col justify-center min-h-[110px] card">
                <div id="rulesDisplay" class="transition-opacity duration-500 ease-in-out">
                    <!-- Rules will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de estado y botones del juego -->
    <div id="gameControls" class="fixed bottom-0 left-0 right-0 w-full flex flex-wrap justify-center items-center gap-2 p-3 bg-white border-t-2 border-gray-200 z-10">
        <div class="bg-white p-2 px-4 rounded-full shadow-lg border-2 border-gray-200 text-black font-extrabold text-lg flex-shrink-0 w-24 text-center">
            <span id="lifeCounter">3/3</span>
        </div>
        <button id="prestigeButton" class="bg-white p-2 px-4 rounded-full shadow-lg border-2 border-gray-200 text-black font-extrabold text-lg transition duration-300 transform hover:scale-105 w-24 text-center">
            <span id="currentMultiplier">1x</span>
        </button>
        <div id="limboGramaticalTimerDisplay" class="bg-white p-2 px-4 rounded-full shadow-lg border-2 font-extrabold text-lg flex-shrink-0 hidden w-24 text-center glitch-wrapper">
            <span class="rainbow-text glitch-text" data-text="0s">0s</span>
        </div>
        <div id="christopherTimerDisplay" class="bg-white p-2 px-4 rounded-full shadow-lg border-2 border-gray-200 font-extrabold text-lg flex-shrink-0 hidden w-24 text-center">
            <span class="rainbow-text">0s</span>
        </div>
        <div id="superValueTimerDisplay" class="bg-white p-2 px-4 rounded-full shadow-lg border-2 font-extrabold text-lg flex-shrink-0 hidden w-24 text-center">
            <span class="super-value-text">0s</span>
        </div>
        <div id="shieldTimerDisplay" class="bg-white p-2 px-4 rounded-full shadow-lg border-2 border-indigo-300 font-extrabold text-lg flex-shrink-0 hidden w-24 text-center">
            <span class="text-indigo-600">0s</span>
        </div>
        <button id="shopButton" class="bg-white hover:bg-gray-100 p-2 px-4 rounded-full shadow-lg border-2 border-gray-200 text-black font-extrabold text-lg transition duration-300 transform hover:scale-105 w-24 text-center">
            Tienda
        </button>
        <button id="homeButton" class="bg-white hover:bg-gray-100 p-2 px-4 rounded-full shadow-lg border-2 border-gray-200 text-black font-extrabold text-lg transition duration-300 transform hover:scale-105 w-24 text-center">
            Inicio
        </button>
    </div>

    <!-- Modal for Shop -->
    <div id="shopScreen" class="fixed inset-0 modal-bg hidden items-center justify-center p-4 z-[100]">
        <div class="w-full max-w-lg bg-white p-6 rounded-2xl shadow-2xl max-h-[90vh] hide-scrollbar overflow-y-auto border-4 border-indigo-300">
            <div class="flex items-center justify-center mb-6">
                <svg class="w-8 h-8 text-indigo-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <h2 class="text-3xl font-black text-indigo-800">Tienda</h2>
            </div>
            <div class="grid grid-cols-1 gap-4">
                <!-- Item: Comprar Vida -->
                <div class="bg-rose-50 border-2 border-rose-200 rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="bg-rose-200 p-2 rounded-full">
                                <svg class="w-6 h-6 text-rose-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-rose-800">Comprar Vida</h3>
                                <p class="text-xs text-rose-700">Recupera una vida perdida.</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block text-md font-bold text-rose-900 mb-1" id="lifePrice"></span>
                            <button id="buyLifeButton" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-1 px-4 text-sm rounded-full transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                Comprar
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Item: Escudo Universal -->
                <div class="bg-indigo-50 border-2 border-indigo-200 rounded-xl p-4">
                     <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                             <div class="bg-indigo-200 p-2 rounded-full">
                                 <svg class="w-6 h-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.417l5.69-5.69a.5.5 0 01.707 0l3.792 3.792a.5.5 0 00.707 0l5.69-5.69A12.02 12.02 0 0021 8.984a11.955 11.955 0 01-2.382-3.028z" />
                                 </svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-indigo-800">Escudo Universal</h3>
                                <p class="text-xs text-indigo-700">Protege de retos por 60s. (<span id="universalCount">0</span>)</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block text-md font-bold text-indigo-900 mb-1" id="universalPrice"></span>
                            <button id="buyUniversalShield" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-4 text-sm rounded-full transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                Comprar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-6">
                <button id="backToGameFromShop" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition duration-300 transform hover:scale-105">
                    Cerrar Tienda
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Messages -->
    <div id="messageModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4">
        <div class="bg-white p-6 max-w-sm w-full text-center rounded-xl shadow-lg border border-blue-300">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="modalCloseButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal for Word List -->
    <div id="wordsModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4 z-[200]">
        <div class="bg-white p-6 max-w-sm w-full text-center rounded-xl shadow-lg border border-gray-300">
            <h3 id="wordsModalTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <ul id="wordsList" class="max-h-64 overflow-y-auto text-left mb-4 px-2">
            </ul>
            <button id="wordsModalCloseButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Cerrar</button>
        </div>
    </div>

    <!-- Modal for Dictionary Challenge -->
    <div id="dictionaryModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4">
        <div class="bg-white p-8 max-w-md w-full text-center rounded-xl shadow-2xl border-4 border-red-500">
            <h3 class="text-3xl font-extrabold text-red-700 mb-2">¡EL DICCIONARIO!</h3>
            <p class="text-md text-gray-600 mb-4">Escribe una palabra de la categoría:</p>
            <p id="challengeCategory" class="text-4xl font-black mb-4"></p>
            <p class="text-sm font-bold text-gray-500">Tiempo restante: <span id="timer" class="text-red-500">30</span>s</p>
            <input id="challengeInput" type="text" class="w-full mt-4 p-3 text-center text-lg font-semibold border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-500 text-gray-800">
        </div>
    </div>

    <!-- Modal for Loading -->
    <div id="loadingModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4">
        <div class="bg-white p-6 max-w-sm w-full text-center rounded-xl shadow-lg flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold text-gray-800 mt-4">Verificando palabra...</p>
        </div>
    </div>

    <!-- Modal for Game Over -->
    <div id="gameOverScreen" class="fixed inset-0 bg-red-900/80 backdrop-blur-sm hidden flex flex-col justify-center items-center p-0">
        <div class="bg-red-800 text-white p-8 w-full h-full text-center flex flex-col justify-center items-center">
            <h2 class="text-5xl font-extrabold mb-4">GAME OVER</h2>
            <p id="gameOverMessage" class="text-lg mb-6"></p>
            <button id="backToGameFromGameOver" class="bg-white text-red-800 font-bold py-3 px-6 rounded-full transition duration-300 transform hover:scale-105">
                Volver a intentarlo
            </button>
        </div>
    </div>

    <!-- Pantalla de Victoria -->
    <div id="winScreen" class="fixed inset-0 bg-green-900/80 backdrop-blur-sm hidden flex flex-col justify-center items-center p-0">
        <div class="bg-green-700 text-white p-8 w-full h-full text-center flex flex-col justify-center items-center">
            <h2 class="text-5xl font-extrabold mb-4">¡HAS GANADO!</h2>
            <p id="winMessage" class="text-lg mb-6"></p>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button id="seguirJugandoButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-full transition duration-300 transform hover:scale-105">
                    Seguir jugando (x<span id="nextMultiplier">2</span>)
                </button>
                <button id="reiniciarButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full transition duration-300 transform hover:scale-105">
                    Reiniciar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Limbo Gramatical -->
    <div id="limboGramaticalScreen" class="fixed inset-0 modal-bg hidden flex-col items-center justify-center p-8 z-[102]">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl text-center relative z-[102] border-4 border-purple-500">
            <div class="glitch-wrapper">
                <h2 class="text-3xl font-extrabold rainbow-text glitch-text mb-4" data-text="¡Limbo Gramátical!">¡Limbo Gramátical!</h2>
            </div>
            <p class="text-md text-gray-600 mb-6">
                 El Tío Christopher tiene un regalo para ti. Aprovéchalo.
            </p>
            <button id="startLimboGramatical" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full transition duration-300 transform hover:scale-105">
                Entendido
            </button>
        </div>
    </div>
    
    <!-- Modal for Prestige Upgrades -->
    <div id="prestigeScreen" class="fixed inset-0 modal-bg hidden items-center justify-center p-4 z-[100]">
        <div class="w-full max-w-4xl bg-white p-6 rounded-2xl shadow-2xl max-h-[90vh] hide-scrollbar overflow-y-auto border-4 border-yellow-400">
            <div class="flex items-center justify-center mb-4">
                 <svg class="w-8 h-8 text-yellow-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11l7-7 7 7M5 19l7-7 7 7" />
                 </svg>
                <h2 class="text-3xl font-black text-yellow-800">Mejoras de Prestigio</h2>
            </div>
            <p class="text-center text-gray-600 mb-4">Puntos de Prestigio disponibles: <span id="prestigePointsDisplay" class="font-bold text-yellow-600">0</span></p>
            <div id="prestigeUpgradesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <!-- Upgrades will be injected here by JS -->
            </div>
            <div class="text-center mt-6">
                <button id="backToGameFromPrestige" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition duration-300 transform hover:scale-105">
                    Cerrar
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Game State Variables ---
        let playerMoney = 100;
        let playerWords = {};
        let usedChallengeWords = {};
        let currentWord = {};
        let passiveIncome = 0;
        let gameMultiplier = 1;
        let initialCredits = 100;
        let consecutiveFailures = 0;
        let shields = { universal: 0 };
        let prestigePoints = 0;
        let prestigeUpgrades = {
            aumentoGeneracionRiqueza: 0,
            reduccionInflacion: 0,
            recompensasDesafio: 0,
            duracionPotenciadores: 0,
            suerteAumentada: 0,
            descuentoTienda: 0
        };
        
        // --- Timers and Intervals ---
        let animationFrameId = null;
        let lastUpdateTime = 0;
        let timeSinceLastIncomeUpdate = 0;
        let wordDisplayTimeout;
        let challengeInterval = null;
        let challengeTimerInterval;
        let isChallengeActive = false;
        
        // --- Bonus State ---
        let universalShieldEndTime = 0;
        let christopherBoostEndTime = 0;
        let superValueBoosts = {}; // Objeto para manejar los potenciadores por categoría
        let limboGramaticalEndTime = 0;
        let limboGramaticalTriggeredThisPartida = false;
        let christopherBonusCountDuringLimbo = 0;

        // --- UI & Game Flow ---
        let currentView = 'game';
        let gameStarted = false;
        let hasBoughtFirstWord = false;
        let gamePausedForFeedback = false;
        let activeChallengeOnLoad = false;
        let visibilityChangeHandler = null;
        
        // --- Game Constants ---
        const PRICE_PER_LETTER = 15;
        const SUPER_VALUE_MULTIPLIER = 2;
        const INFLATION_FACTOR = 100;
        const SHIELD_PRICE_UNIVERSAL = 1000000;
        const LIFE_PRICE = 2000000;
        const CHALLENGE_REWARDS = { "Agudas": 10000, "Llanas": 20000, "Esdrújulas": 40000 };
        
        const BASE_WORD_DATABASE = {
             "Monosílabos": {
                value: 10,
                words: ["Sol", "Mar", "Luz", "Voz", "Pan", "Sal", "Miel", "Tren", "Flor", "Rey", "Son", "Paz", "Bien", "Mal", "Gas", "No", "Sí", "Yo", "Él", "Tú", "Ve", "Da", "Sé", "Vi", "Di", "Pie", "Fe", "Ley", "Don", "Fin", "Mes", "Mil", "Res", "Ron", "Set", "Sur", "Tal", "Tez", "Zas", "Dar"],
                superValueWords: ["Flor", "Voz", "Rey", "Paz"],
                limit: 30
            },
            "Agudas": {
                value: 100,
                words: ["Acción", "Adicción", "Además", "Andén", "Balón", "Bebé", "Café", "Camión", "Canción", "Colibrí", "Corazón", "Después", "Emoción", "Interés", "Jabalí", "Jamás", "Jardín", "Jazmín", "Menú", "País", "París", "Pasión", "Perfección", "Portugués", "Revolución", "Sofá", "Solución", "También", "Visión", "Volcán", "Comió", "Estudió", "Habló", "Vivió", "Ganará"],
                superValueWords: ["Colibrí", "Jazmín", "Pasión", "Revolución"],
                limit: 30
            },
            "Llanas": {
                value: 250,
                words: ["Árbol", "Ángel", "Azúcar", "Cáncer", "Cárcel", "Carácter", "Césped", "Clímax", "Cráter", "Día", "Difícil", "Dólar", "Éter", "Fácil", "Fósil", "Fútbol", "Huésped", "Lápiz", "Líder", "Mártir", "Móvil", "Nácar", "Poesía", "Póker", "Río", "Tórax", "Trébol", "Túnel", "Geografía", "Biología", "Filosofía", "Tecnología", "Psicología", "Economía", "Anatomía", "Sandía", "Policía"],
                superValueWords: ["Carácter", "Cráter", "Poesía", "Geografía"],
                limit: 30
            },
            "Esdrújulas": {
                value: 500,
                words: ["Análisis", "Antártida", "Atmósfera", "Bolígrafo", "Brújula", "Cálculo", "Catástrofe", "Círculo", "Clínica", "Cómpralo", "Déficit", "Esdrújula", "Estómago", "Éxito", "Fábrica", "Fósforo", "Gramática", "Hígado", "Héroe", "Hipócrita", "Índice", "Lágrima", "Lógico", "Mágico", "Máquina", "Matemáticas", "Médico", "Miércoles", "Murciélago", "Músculo", "Música", "Número", "Oxígeno", "Página", "Pájaro", "Plátano", "Público", "Química", "Rápido", "Sábado", "Semáforo", "Sílaba", "Teléfono", "Término", "Tráfico", "Último", "Vértebra", "Víctima", "Aéreo", "Célula"],
                superValueWords: ["Atmósfera", "Murciélago", "Científico", "Matemáticas"],
                limit: 30
            },
            "Sobreesdrújulas": {
                value: 1000000,
                words: ["Agradéceselo", "Apréndetelo", "Averíguamelo", "Búscaselo", "Comprándomelo", "Dígamelo", "Díceselo", "Enciéndemelo", "Entrégaselo", "Explícaselo", "Guárdaselo", "Hágaselo", "Júraselo", "Llévaselo", "Pídemelo", "Pásaselo", "Repíteselo", "Tráigaselo", "Véndeselo", "Dedicándoselo", "Estudiándotelo", "Explicándoselo", "Repitiéndoselo", "Comiéndoselo", "Escribiéndotelo", "Mirándoselo", "Preparándomelo", "Comprándoselo", "Llamándoselo", "Encontrándoselo", "Recibiéndoselo", "Entregándoselo", "Aceptándoselo", "Aconsejándoselo", "Acompañándotelo", "Aprendiéndotelo", "Bendiciéndotelo", "Buscándoselo", "Celebrándoselo", "Comentándoselo"],
                superValueWords: [],
                limit: 1
            }
        };

        let WORD_DATABASE = JSON.parse(JSON.stringify(BASE_WORD_DATABASE));

        const categoryColors = { "Monosílabos": "text-gray-800", "Agudas": "text-green-800", "Llanas": "text-yellow-800", "Esdrújulas": "text-blue-800", "Sobreesdrújulas": "text-purple-800" };
        const categoryBackgrounds = { "Monosílabos": "bg-gray-200 hover:bg-gray-300", "Agudas": "bg-green-200 hover:bg-green-300", "Llanas": "bg-yellow-200 hover:bg-yellow-300", "Esdrújulas": "bg-blue-200 hover:bg-blue-300", "Sobreesdrújulas": "bg-purple-200 hover:bg-purple-300" };
        
        const prestigeUpgradeInfo = {
            aumentoGeneracionRiqueza: { title: "Aumento de Riqueza", desc: "Aumenta la generación de riqueza pasiva.", effect: level => `+${level}%`, icon: `<svg class="w-6 h-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2.01M12 14v4m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M12 14c1.657 0 3-.895 3-2s-1.343-2-3-2-3-.895-3-2 1.343-2 3-2m0 8c-1.11 0-2.08.402-2.599 1M12 14v-1m0 1v.01M12 16v-1m0 1V18" /></svg>`, colors: "bg-green-50 border-green-200 text-green-800" },
            reduccionInflacion: { title: "Reducción de Inflación", desc: "Reduce el efecto de la inflación.", effect: level => `-${(level * 0.5)}%`, icon: `<svg class="w-6 h-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>`, colors: "bg-red-50 border-red-200 text-red-800" },
            recompensasDesafio: { title: "Recompensas de Desafío", desc: "Aumenta el dinero ganado en los retos.", effect: level => `+${(level * 2)}%`, icon: `<svg class="w-6 h-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0a3 3 0 110 6H9l-2 2V8a2 2 0 012-2z" /></svg>`, colors: "bg-blue-50 border-blue-200 text-blue-800" },
            duracionPotenciadores: { title: "Duración de Potenciadores", desc: "Aumenta la duración de los bonus.", effect: level => `+${(level * 0.5)}s`, icon: `<svg class="w-6 h-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`, colors: "bg-purple-50 border-purple-200 text-purple-800" },
            suerteAumentada: { title: "Suerte Aumentada", desc: "Aumenta la probabilidad de eventos especiales.", effect: level => `+${(level * 0.05)}%`, icon: `<svg class="w-6 h-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`, colors: "bg-yellow-50 border-yellow-200 text-yellow-800" },
            descuentoTienda: { title: "Descuento en Tienda", desc: "Reduce el precio de los artículos de la tienda.", effect: level => `-${(level * 0.25)}%`, icon: `<svg class="w-6 h-6 text-pink-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>`, colors: "bg-pink-50 border-pink-200 text-pink-800" }
        };

        function applyScalingToWordDatabase(multiplier) {
            WORD_DATABASE = JSON.parse(JSON.stringify(BASE_WORD_DATABASE));
            Object.keys(WORD_DATABASE).forEach(category => {
                WORD_DATABASE[category].value = BASE_WORD_DATABASE[category].value * multiplier;
            });
        }

        function recalculatePassiveIncome() {
            passiveIncome = 0;
            const now = Date.now();
            Object.keys(playerWords).forEach(category => {
                if (playerWords[category] && WORD_DATABASE[category] && category !== "Sobreesdrújulas") {
                    const count = playerWords[category].count || 0;
                    const baseValue = WORD_DATABASE[category].value;
                    
                    let categoryIncome = count * baseValue;

                    if (superValueBoosts[category] && now < superValueBoosts[category]) {
                        categoryIncome *= SUPER_VALUE_MULTIPLIER;
                    }
                    passiveIncome += categoryIncome;
                }
            });
            
            // Aplicar bonus de prestigio de generación de riqueza
            if (prestigeUpgrades.aumentoGeneracionRiqueza > 0) {
                passiveIncome *= (1 + prestigeUpgrades.aumentoGeneracionRiqueza * 0.01);
            }
        }
        
        function resetGameData() {
            let baseCredits = 100;
            for(let i = 1; i < gameMultiplier; i++) {
                baseCredits *= 2;
            }
            initialCredits = baseCredits; // Riqueza inicial ya no se modifica aquí

            playerMoney = initialCredits;
            passiveIncome = 0;
            consecutiveFailures = 0;
            usedChallengeWords = {};
            shields = { universal: 0 };
            christopherBoostEndTime = 0;
            superValueBoosts = {};
            universalShieldEndTime = 0;
            limboGramaticalEndTime = 0;
            hasBoughtFirstWord = false;
            limboGramaticalTriggeredThisPartida = false;
            christopherBonusCountDuringLimbo = 0;

            Object.keys(WORD_DATABASE).forEach(category => {
                playerWords[category] = { count: 0, list: [] };
            });
        }
        
        function resetProgressButKeepLives() {
            passiveIncome = 0;
            Object.keys(playerWords).forEach(category => {
                if (playerWords[category]) {
                    playerWords[category].count = 0;
                    playerWords[category].list = [];
                }
            });
        }

        function formatearJuego() {
            gameMultiplier++;
            prestigePoints++;
            applyScalingToWordDatabase(gameMultiplier);
            resetGameData(); // This now correctly uses prestige upgrades
            savePlayerData(); 
            updateUI();
            changeView('game');
            startGameCommon(false);
            showModal(`¡Juego formateado! Multiplicador: ${gameMultiplier}x. Has ganado 1 Punto de Prestigio.`);
        }
        
        function reiniciarJuegoCompleto() {
            gameMultiplier = 1;
            prestigePoints = 1; // Empiezas con 1 punto de prestigio de regalo
            Object.keys(prestigeUpgrades).forEach(key => prestigeUpgrades[key] = 0);
            applyScalingToWordDatabase(1);
            resetGameData();
            savePlayerData();
        }

        function showModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').classList.remove('hidden');
            document.getElementById('messageModal').classList.add('flex');
        }

        function changeView(view) {
            currentView = view;
            ['gameScreen', 'startupScreen', 'shopScreen', 'gameOverScreen', 'winScreen', 'gameControls', 'tutorialScreen', 'limboGramaticalScreen', 'prestigeScreen'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            const screen = document.getElementById(`${view}Screen`);
            if (screen) screen.classList.remove('hidden');

            if (view === 'game') {
                const controls = document.getElementById('gameControls');
                if (controls) controls.classList.remove('hidden');
            } else if (view === 'shop' || view === 'prestige') {
                if (screen) screen.classList.add('flex');
                if (view === 'prestige') updatePrestigeUI();
                else updateShopUI();
            }
        }
        
        async function startNewGame() {
            proceedWithNewGame();
        }

        async function continueGame() {
            proceedWithContinueGame();
        }
        
        async function proceedWithNewGame() {
            localStorage.removeItem('dl_player_data');
            reiniciarJuegoCompleto();
            gameStarted = true;
            changeView('game');
            await startGameCommon(true); // 'true' means load, but data was just removed
        }
        
        async function proceedWithContinueGame() {
            gameStarted = true;
            changeView('game');
            await startGameCommon(true);
        }

        function updateShopUI() {
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            const limboDiscount = isLimboActive ? 0.79 : 1; // 21% discount
            const prestigeDiscount = 1 - (prestigeUpgrades.descuentoTienda * 0.0025);

            const shieldPrice = SHIELD_PRICE_UNIVERSAL * limboDiscount * prestigeDiscount;
            document.getElementById('universalPrice').textContent = `${shieldPrice.toLocaleString('en-US')}`;
            const buyUniversalShieldBtn = document.getElementById('buyUniversalShield');
            const canAffordShield = playerMoney >= shieldPrice;
            buyUniversalShieldBtn.disabled = !canAffordShield;
            buyUniversalShieldBtn.classList.toggle('opacity-50', !canAffordShield);
            buyUniversalShieldBtn.classList.toggle('cursor-not-allowed', !canAffordShield);
            document.getElementById('universalCount').textContent = shields.universal;

            const lifePrice = LIFE_PRICE * limboDiscount * prestigeDiscount;
            document.getElementById('lifePrice').textContent = `${lifePrice.toLocaleString('en-US')}`;
            const buyLifeBtn = document.getElementById('buyLifeButton');
            const canAffordLife = playerMoney >= lifePrice;
            const needsLife = consecutiveFailures > 0;
            const canBuyLife = canAffordLife && needsLife;
            buyLifeBtn.disabled = !canBuyLife;
            buyLifeBtn.classList.toggle('opacity-50', !canBuyLife);
            buyLifeBtn.classList.toggle('cursor-not-allowed', !canBuyLife);

            // Visual indicator for store discount
            const discountSpan = document.createElement('span');
            discountSpan.className = 'text-xs text-green-600 ml-2';
            if (prestigeUpgrades.descuentoTienda > 0) {
                const discountValue = (prestigeUpgrades.descuentoTienda * 0.25).toFixed(2);
                document.getElementById('universalPrice').innerHTML += ` <span class="text-xs text-green-600">(-${discountValue}%)</span>`;
                document.getElementById('lifePrice').innerHTML += ` <span class="text-xs text-green-600">(-${discountValue}%)</span>`;
            }
        }

        function buyShield() {
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            const price = SHIELD_PRICE_UNIVERSAL * (isLimboActive ? 0.79 : 1) * (1 - (prestigeUpgrades.descuentoTienda * 0.0025));
            if (playerMoney >= price) {
                playerMoney -= price;
                shields.universal++;
                updateUI();
                updateShopUI();
                savePlayerData();
                showModal(`¡Escudo Universal comprado! Tienes ${shields.universal}.`);
            } else {
                showModal(`¡No tienes suficiente dinero!`);
            }
        }
        
        function buyLife() {
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            const price = LIFE_PRICE * (isLimboActive ? 0.79 : 1) * (1 - (prestigeUpgrades.descuentoTienda * 0.0025));
            if (consecutiveFailures > 0 && playerMoney >= price) {
                playerMoney -= price;
                consecutiveFailures--;
                updateUI();
                updateShopUI();
                savePlayerData();
                showModal(`¡Has recuperado una vida!`);
            } else if (consecutiveFailures === 0) {
                 showModal(`Tienes todas tus vidas.`);
            } else {
                showModal(`¡No tienes suficiente dinero!`);
            }
        }

        function startWordDisplayTimer(duration) {
            clearTimeout(wordDisplayTimeout);
            wordDisplayTimeout = setTimeout(() => {
                if (!isChallengeActive) generateNewWord(true);
            }, duration);
        }

        function triggerLimboGramatical() {
            christopherBonusCountDuringLimbo = 0;
            savePlayerData(); 
            stopGameLoops();
            stopRulesRotator();
            
            const modal = document.getElementById('limboGramaticalScreen');
            if(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        async function generateNewWord(forceNew = false) {
            if (isChallengeActive) return;
            
            if (hasBoughtFirstWord && !limboGramaticalTriggeredThisPartida && Math.random() < (0.001 + prestigeUpgrades.suerteAumentada * 0.0005)) {
                limboGramaticalTriggeredThisPartida = true;
                triggerLimboGramatical();
                return;
            }
            
            if (forceNew) clearTimeout(wordDisplayTimeout);
            
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            
            let christopherChance = 0.03 + (prestigeUpgrades.suerteAumentada * 0.0005);
            if (isLimboActive && christopherBonusCountDuringLimbo < 3) {
                christopherChance += 0.21; 
            }

            if (Math.random() < christopherChance) {
                if (isLimboActive) christopherBonusCountDuringLimbo++;
                currentWord = { word: "CHRISTOPHER", category: "Bonus", value: 0, isBonus: true, startTime: Date.now() };
                updateUI();
                startWordDisplayTimer(1000 + (prestigeUpgrades.duracionPotenciadores * 500));
                return;
            }

            if (isLimboActive) {
                const allSuperValueWords = [];
                Object.keys(WORD_DATABASE).forEach(category => {
                    if (WORD_DATABASE[category].superValueWords && WORD_DATABASE[category].superValueWords.length > 0) {
                        const ownedWords = playerWords[category]?.list || [];
                        WORD_DATABASE[category].superValueWords.forEach(svWord => {
                            if (!ownedWords.includes(svWord)) {
                                allSuperValueWords.push({ word: svWord, category: category });
                            }
                        });
                    }
                });

                if (allSuperValueWords.length > 0) {
                    const randomSV = allSuperValueWords[Math.floor(Math.random() * allSuperValueWords.length)];
                    let dynamicValue = (WORD_DATABASE[randomSV.category].value + (randomSV.word.length * PRICE_PER_LETTER)) * SUPER_VALUE_MULTIPLIER * 0.79;
                    currentWord = { word: randomSV.word, category: randomSV.category, value: dynamicValue, isSuperValue: true, startTime: Date.now() };
                    updateUI();
                    startWordDisplayTimer(3000);
                    return;
                }
            }
            
            let categories = Object.keys(WORD_DATABASE);
            const nonFinalCategories = categories.filter(c => c !== "Sobreesdrújulas");
            const allCategoriesCompleted = nonFinalCategories.every(cat => playerWords[cat] && playerWords[cat].count >= WORD_DATABASE[cat].limit);
            let randomCategory = allCategoriesCompleted ? "Sobreesdrújulas" : nonFinalCategories[Math.floor(Math.random() * nonFinalCategories.length)];
            let ownedWords = playerWords[randomCategory]?.list || [];
            let availableWords = WORD_DATABASE[randomCategory].words.filter(word => !ownedWords.includes(word));
            
            if (availableWords.length === 0) { 
                setTimeout(() => generateNewWord(true), 50); 
                return;
            }
            
            let randomWord = availableWords[Math.floor(Math.random() * availableWords.length)];
            let isSuperValue = (WORD_DATABASE[randomCategory].superValueWords || []).includes(randomWord);
            
            let dynamicValue = WORD_DATABASE[randomCategory].value;
            if (randomCategory !== "Sobreesdrújulas") {
                const inflationReduction = 1 - (prestigeUpgrades.reduccionInflacion * 0.005);
                const inflationMultiplier = 1 + (passiveIncome / INFLATION_FACTOR) * inflationReduction;
                dynamicValue = (WORD_DATABASE[randomCategory].value + (randomWord.length * PRICE_PER_LETTER)) * inflationMultiplier;
                if (isSuperValue) dynamicValue *= SUPER_VALUE_MULTIPLIER;
            }

            currentWord = { word: randomWord, category: randomCategory, value: dynamicValue, isSuperValue, startTime: Date.now() };
            updateUI();
            startWordDisplayTimer(3000);
        }

        function updateUI() {
            document.getElementById('playerMoney').textContent = playerMoney.toLocaleString('en-US');
            recalculatePassiveIncome();
            let finalPassiveIncome = passiveIncome;
            if (Date.now() < christopherBoostEndTime) finalPassiveIncome *= 2;
            if (Date.now() < limboGramaticalEndTime) finalPassiveIncome *= 1.21;
            document.getElementById('passiveIncome').textContent = finalPassiveIncome.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 });

            // Indicador visual para bonus de Prestigio de riqueza
            const incomeBonusSpan = document.getElementById('prestigeIncomeBonus');
            if (prestigeUpgrades.aumentoGeneracionRiqueza > 0) {
                incomeBonusSpan.textContent = `(+${prestigeUpgrades.aumentoGeneracionRiqueza}%)`;
                incomeBonusSpan.classList.remove('hidden');
            } else {
                incomeBonusSpan.classList.add('hidden');
            }

            if (currentWord.word) {
                let wordClass = "";
                if (currentWord.isBonus) {
                    wordClass = "rainbow-text font-black";
                } else if (currentWord.isSuperValue) {
                    wordClass = "super-value-text font-black";
                } else {
                    wordClass = `${categoryColors[currentWord.category] || "text-gray-800"} font-black`;
                }
                
                document.getElementById('currentWord').innerHTML = `<span class="${wordClass}">${currentWord.word}</span>`;
                document.getElementById('wordCategory').textContent = currentWord.category;
                
                const buyButton = document.getElementById('buyButton');
                const canAfford = playerMoney >= currentWord.value;
                let isOwned = false;
                let isCategoryComplete = false;

                if (!currentWord.isBonus && currentWord.category && playerWords[currentWord.category]) {
                    const categoryData = playerWords[currentWord.category];
                    const limit = WORD_DATABASE[currentWord.category]?.limit;
                    isCategoryComplete = categoryData && limit && categoryData.count >= limit;
                    isOwned = (categoryData.list || []).includes(currentWord.word);
                }

                buyButton.disabled = !canAfford || isOwned || isCategoryComplete;
                buyButton.classList.toggle('opacity-50', buyButton.disabled);
                buyButton.classList.toggle('cursor-not-allowed', buyButton.disabled);

                if (isCategoryComplete) {
                    document.getElementById('wordValue').textContent = 'Categoría Completa';
                } else {
                    let valueHTML = `${currentWord.value.toLocaleString('en-US')}`;
                    if (prestigeUpgrades.reduccionInflacion > 0) {
                        const reductionValue = (prestigeUpgrades.reduccionInflacion * 0.5).toFixed(2);
                        valueHTML += ` <span class="text-xs text-green-600">(-${reductionValue}%)</span>`;
                    }
                    document.getElementById('wordValue').innerHTML = valueHTML;
                }
            }

            updateShopUI();
            const remainingLives = Math.max(0, 3 - consecutiveFailures);
            const lifeCounter = document.getElementById('lifeCounter');
            lifeCounter.textContent = `${remainingLives}/3`;
            lifeCounter.parentElement.classList.remove('border-green-300', 'border-yellow-400', 'border-red-500');
            if (remainingLives === 3) lifeCounter.parentElement.classList.add('border-green-300');
            else if (remainingLives === 2) lifeCounter.parentElement.classList.add('border-yellow-400');
            else lifeCounter.parentElement.classList.add('border-red-500');
            
            const prestigeButton = document.getElementById('prestigeButton');
            prestigeButton.disabled = false;
            prestigeButton.classList.add('cursor-pointer');
            prestigeButton.classList.remove('cursor-default');
             if (gameMultiplier > 1) {
                prestigeButton.classList.add('hover:bg-yellow-200', 'border-yellow-400');
            } else {
                prestigeButton.classList.remove('hover:bg-yellow-200', 'border-yellow-400');
            }
            prestigeButton.classList.toggle('luck-glow', prestigeUpgrades.suerteAumentada > 0);
            document.getElementById('currentMultiplier').textContent = `${gameMultiplier}x`;
            
            // Timers
            const limboTimer = document.getElementById('limboGramaticalTimerDisplay');
            const chrisTimer = document.getElementById('christopherTimerDisplay');
            const svTimer = document.getElementById('superValueTimerDisplay');
            const shieldTimer = document.getElementById('shieldTimerDisplay');
            const now = Date.now();

            Object.keys(superValueBoosts).forEach(cat => {
                if (now >= superValueBoosts[cat]) delete superValueBoosts[cat];
            });

            const limboTimeLeft = Math.ceil(Math.max(0, limboGramaticalEndTime - now) / 1000);
            limboTimer.style.display = limboTimeLeft > 0 ? 'block' : 'none';
            if(limboTimeLeft > 0) {
                limboTimer.querySelector('span').textContent = `${limboTimeLeft}s`;
                limboTimer.querySelector('span').dataset.text = `${limboTimeLeft}s`;
            }

            const chrisTimeLeft = Math.ceil(Math.max(0, (christopherBoostEndTime - now)) / 1000);
            chrisTimer.style.display = chrisTimeLeft > 0 ? 'block' : 'none';
            if(chrisTimeLeft > 0) {
                chrisTimer.querySelector('span').textContent = `${chrisTimeLeft}s`;
                chrisTimer.classList.toggle('prestige-glow', prestigeUpgrades.duracionPotenciadores > 0);
            }

            const maxSuperValueEndTime = Object.values(superValueBoosts).length > 0 ? Math.max(...Object.values(superValueBoosts)) : 0;
            const svTimeLeft = Math.ceil(Math.max(0, maxSuperValueEndTime - now) / 1000);
            svTimer.style.display = svTimeLeft > 0 ? 'block' : 'none';
            if(svTimeLeft > 0) {
                svTimer.querySelector('span').textContent = `${svTimeLeft}s`;
                svTimer.classList.toggle('prestige-glow', prestigeUpgrades.duracionPotenciadores > 0);
            }
            
            const shieldTimeLeft = Math.ceil(Math.max(0, universalShieldEndTime - now) / 1000);
            shieldTimer.style.display = shieldTimeLeft > 0 ? 'block' : 'none';
            if (shieldTimeLeft > 0) {
                shieldTimer.querySelector('span').textContent = `${shieldTimeLeft}s`;
            }


            // Inventory
            const inventoryContainer = document.getElementById('inventoryContainer');
            inventoryContainer.innerHTML = '';
            Object.keys(WORD_DATABASE).forEach(category => {
                const data = playerWords[category] || { count: 0, list: [] };
                const limit = WORD_DATABASE[category].limit;
                const isCompleted = data.count >= limit;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = `relative flex-1 flex-shrink-0 text-center flex flex-col items-center justify-between p-2 cursor-pointer transition duration-300 rounded-lg shadow-md ${isCompleted ? "bg-gray-300 text-gray-500" : categoryBackgrounds[category]}`;
                categoryDiv.onclick = () => {
                    const wordsModal = document.getElementById('wordsModal');
                    document.getElementById('wordsModalTitle').textContent = `Palabras ${category}`;
                    const wordsList = document.getElementById('wordsList');
                    wordsList.innerHTML = '';
                    if (data.list.length > 0) {
                        data.list.forEach((word, index) => {
                            const li = document.createElement('li');
                            li.textContent = `${index + 1}. ${word}`;
                            li.className = "p-1 border-b border-gray-200";
                            wordsList.appendChild(li);
                        });
                    } else {
                        wordsList.innerHTML = `<li class="p-1 italic text-gray-500">Aún no tienes palabras aquí.</li>`;
                    }
                    wordsModal.classList.remove('hidden');
                    wordsModal.classList.add('flex');
                };

                const isChrisActive = Date.now() < christopherBoostEndTime;
                const isSuperValueActiveForThisCategory = superValueBoosts[category] && Date.now() < superValueBoosts[category];

                let boostIconsHTML = '<div class="absolute top-0 right-1 flex flex-col items-end">';
                if (isChrisActive && category !== "Sobreesdrújulas") {
                    boostIconsHTML += `<span class="rainbow-text font-bold text-xs">x2</span>`;
                }
                if (isSuperValueActiveForThisCategory) {
                    boostIconsHTML += `<span class="super-value-text font-bold text-xs">x2</span>`;
                }
                boostIconsHTML += '</div>';

                categoryDiv.innerHTML = `
                    ${boostIconsHTML}
                    <p class="font-bold ${categoryColors[category] || 'text-gray-800'}">${category}</p>
                    <p class="text-2xl font-extrabold ${categoryColors[category] || 'text-gray-800'}">${data.count}/${limit}</p>
                `;
                inventoryContainer.appendChild(categoryDiv);
            });
        }

        function buyWord() {
            if (playerMoney < currentWord.value) return;
            
            let wordBought = false;

            if (currentWord.isBonus) {
                const now = Date.now();
                const baseDuration = 60000;
                const bonusDuration = prestigeUpgrades.duracionPotenciadores * 500;
                const remainingTime = (christopherBoostEndTime > now) ? (christopherBoostEndTime - now) : 0;
                christopherBoostEndTime = now + remainingTime + baseDuration + bonusDuration;
                wordBought = true;
            } else if (currentWord.isSuperValue) {
                const categoryData = playerWords[currentWord.category];
                if (categoryData.count < WORD_DATABASE[currentWord.category].limit && !categoryData.list.includes(currentWord.word)) {
                    playerMoney -= currentWord.value;
                    categoryData.count++;
                    categoryData.list.push(currentWord.word);
                    wordBought = true;
                    
                    const now = Date.now();
                    const category = currentWord.category;
                    const baseDuration = 10000;
                    const bonusDuration = prestigeUpgrades.duracionPotenciadores * 500;
                    const remainingTime = (superValueBoosts[category] > now) ? (superValueBoosts[category] - now) : 0;
                    superValueBoosts[category] = now + remainingTime + baseDuration + bonusDuration;
                }
            } else { // Normal Word
                const categoryData = playerWords[currentWord.category];
                if (categoryData.count < WORD_DATABASE[currentWord.category].limit && !categoryData.list.includes(currentWord.word)) {
                    playerMoney -= currentWord.value;
                    categoryData.count++;
                    categoryData.list.push(currentWord.word);
                    wordBought = true;
                }
            }
            
            if (currentWord.category === "Sobreesdrújulas" && wordBought) {
                const winMessage = document.getElementById('winMessage');
                winMessage.textContent = `¡VICTORIA! Has conseguido una palabra sobreesdrújula. Multiplicador actual: ${gameMultiplier}x.`;
                document.getElementById('nextMultiplier').textContent = gameMultiplier + 1;
                stopGameLoops();
                stopRulesRotator();
                savePlayerData();
                changeView('win');
                return;
            }


            if (wordBought) {
                if (!hasBoughtFirstWord) hasBoughtFirstWord = true;
                document.getElementById('buyButton').disabled = true;
                savePlayerData();
                
                clearTimeout(wordDisplayTimeout);
                const elapsedTime = Date.now() - currentWord.startTime;
                const duration = currentWord.isBonus ? 1000 : 3000;
                const newRemainingTime = Math.max(0, (duration - elapsedTime) - 1000);
                startWordDisplayTimer(newRemainingTime);
                
                updateUI();
            }
        }
        
        function startDictionaryChallenge() {
            stopGameLoops();
            isChallengeActive = true;
            savePlayerData(); // Guardar inmediatamente que el reto está activo

            const universalShieldActive = Date.now() < universalShieldEndTime;
            if (universalShieldActive) {
                showModal(`¡Protegido por el Escudo Universal! Reto evitado.`);
                startGameLoops();
                isChallengeActive = false;
                generateNewWord(true);
                return;
            }
            if (shields.universal > 0) {
                shields.universal--;
                universalShieldEndTime = Date.now() + 60000;
                savePlayerData();
                showModal("¡Escudo Universal activado por 60 segundos! Reto evitado.");
                startGameLoops();
                isChallengeActive = false;
                generateNewWord(true);
                return;
            }
            
            visibilityChangeHandler = () => {
                if (document.hidden && isChallengeActive) {
                    endDictionaryChallenge('cheat', document.getElementById('challengeCategory').textContent);
                }
            };
            document.addEventListener('visibilitychange', visibilityChangeHandler);

            const categories = ["Agudas", "Llanas", "Esdrújulas"];
            const challengeCategory = categories[Math.floor(Math.random() * categories.length)];
            
            const modal = document.getElementById('dictionaryModal');
            document.getElementById('challengeCategory').textContent = challengeCategory;
            const timerDisplay = document.getElementById('timer');
            timerDisplay.textContent = 30;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            const input = document.getElementById('challengeInput');
            input.value = '';
            input.focus();
            
            let timeLeft = 30;
            challengeTimerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) endDictionaryChallenge(null, challengeCategory);
            }, 1000);

            input.onkeyup = (event) => {
                if (event.key === 'Enter') endDictionaryChallenge(input.value, challengeCategory);
            };
        }
        
        async function endDictionaryChallenge(word, category) {
            if (visibilityChangeHandler) {
                document.removeEventListener('visibilitychange', visibilityChangeHandler);
                visibilityChangeHandler = null;
            }
    
            clearInterval(challengeTimerInterval);
            document.getElementById('dictionaryModal').classList.add('hidden');
            isChallengeActive = false;
            gamePausedForFeedback = true;
            stopGameLoops();

            if (word === 'cheat') {
                handleChallengeFailure("Reto fallido por cambiar de pestaña.");
                return;
            }

            if (!word || !/^[A-ZÁÉÍÓÚÜÑ][a-záéíóúüñ¡!]+$/.test(word.trim())) {
                handleChallengeFailure("Formato de palabra inválido. Debe empezar con mayúscula y contener solo letras.");
                return;
            }
            word = word.trim();

            if ((usedChallengeWords[category] || []).includes(word.toLowerCase())) {
                handleChallengeFailure("Palabra ya usada en un reto.");
                return;
            }
            
            const { category: detectedCategory, reason } = getAccentCategory(word);

            if (detectedCategory === category) {
                if (!usedChallengeWords[category]) usedChallengeWords[category] = [];
                usedChallengeWords[category].push(word.toLowerCase());
                
                const rewardBonus = 1 + (prestigeUpgrades.recompensasDesafio * 0.02);
                const reward = CHALLENGE_REWARDS[category] * rewardBonus;
                playerMoney += reward;
                let successMessage = `¡Correcto! ${reason} Ganas ${reward.toLocaleString('en-US')}.`;
                if (prestigeUpgrades.recompensasDesafio > 0) {
                    successMessage += ` (+${prestigeUpgrades.recompensasDesafio * 2}%)`;
                }
                showModal(successMessage);
            } else {
                handleChallengeFailure(reason);
            }
        }

        function handleChallengeFailure(reason) {
            consecutiveFailures++;
            if (consecutiveFailures >= 3) {
                document.getElementById('gameOverMessage').textContent = `Fallaste 3 veces. Razón final: ${reason}`;
                stopGameLoops();
                stopRulesRotator();
                changeView('gameOver');
            } else {
                resetProgressButKeepLives();
                showModal(`¡Fallo! ${reason}. Has perdido tus palabras. Te quedan ${3 - consecutiveFailures} intentos.`);
            }
        }
        
        function savePlayerData() {
            try {
                const data = {
                    money: playerMoney, words: playerWords, used: usedChallengeWords,
                    failures: consecutiveFailures, multiplier: gameMultiplier,
                    credits: initialCredits, shields: shields, shieldEnd: universalShieldEndTime,
                    chrisEnd: christopherBoostEndTime, svBoosts: superValueBoosts,
                    limboTriggered: limboGramaticalTriggeredThisPartida,
                    chrisBonusCount: christopherBonusCountDuringLimbo,
                    prestigePoints: prestigePoints,
                    prestigeUpgrades: prestigeUpgrades,
                    isChallengeActive: isChallengeActive // Guardar el estado del reto
                };
                localStorage.setItem('dl_player_data', JSON.stringify(data));
            } catch (e) { console.error('Error saving data:', e); }
        }

        function loadPlayerData() {
            try {
                const raw = localStorage.getItem('dl_player_data');
                if (!raw) return;
                const data = JSON.parse(raw);
                playerMoney = data.money || 100;
                playerWords = data.words || {};
                usedChallengeWords = data.used || {};
                consecutiveFailures = data.failures || 0;
                gameMultiplier = data.multiplier || 1;
                
                shields = data.shields || { universal: 0 };
                universalShieldEndTime = data.shieldEnd || 0;
                christopherBoostEndTime = data.chrisEnd || 0;
                superValueBoosts = data.svBoosts || {};
                limboGramaticalTriggeredThisPartida = data.limboTriggered || false;
                christopherBonusCountDuringLimbo = data.chrisBonusCount || 0;
                prestigePoints = data.prestigePoints || 0;
                prestigeUpgrades = data.prestigeUpgrades || { aumentoGeneracionRiqueza: 0, reduccionInflacion: 0, recompensasDesafio: 0, duracionPotenciadores: 0, suerteAumentada: 0, descuentoTienda: 0 };

                if (data.isChallengeActive) {
                    activeChallengeOnLoad = true;
                }

                // Recalculate initialCredits based on loaded prestige data
                let baseCredits = 100;
                for(let i = 1; i < gameMultiplier; i++) {
                    baseCredits *= 2;
                }
                initialCredits = baseCredits;
                // Note: We don't reset playerMoney here, just recalculate what the base should be.

                if (gameMultiplier > 1) applyScalingToWordDatabase(gameMultiplier);
                
                let totalWords = 0;
                Object.keys(WORD_DATABASE).forEach(category => {
                    if (!playerWords[category]) {
                        playerWords[category] = { count: 0, list: [] };
                    }
                    totalWords += playerWords[category].count || 0;
                });
                hasBoughtFirstWord = totalWords > 0;

            } catch (e) { console.error('Error loading data:', e); }
        }
        
        function mainGameLoop(timestamp) {
            if (!lastUpdateTime) lastUpdateTime = timestamp;
            const deltaTime = timestamp - lastUpdateTime;
            lastUpdateTime = timestamp;
            
            timeSinceLastIncomeUpdate += deltaTime;
            if (timeSinceLastIncomeUpdate >= 1000) {
                let incomeThisSecond = passiveIncome;
                if (Date.now() < christopherBoostEndTime) incomeThisSecond *= 2;
                if(Date.now() < limboGramaticalEndTime) incomeThisSecond *= 1.21;
                playerMoney += incomeThisSecond;
                timeSinceLastIncomeUpdate = 0;
                updateUI();
            }
            
            updateTimerBarUI();
            animationFrameId = requestAnimationFrame(mainGameLoop);
        }
        
        function updateTimerBarUI() {
            if (!gameStarted || currentView !== 'game' || !currentWord.startTime) return;
            const bar = document.getElementById('wordTimerBar');
            if (!bar) return;

            const now = Date.now();
            const duration = currentWord.isBonus ? 1000 : 3000;
            const elapsedTime = now - currentWord.startTime;
            const timeLeft = Math.max(0, duration - elapsedTime);
            const percentage = (timeLeft / duration) * 100;
            
            bar.style.width = `${percentage}%`;

            if (timeLeft > (duration * 2/3)) bar.style.backgroundColor = '#ef4444'; // red-500
            else if (timeLeft > (duration * 1/3)) bar.style.backgroundColor = '#eab308'; // yellow-500
            else bar.style.backgroundColor = '#22c55e'; // green-500
        }

        const accentuationRules = [
            { title: "Monosílabos", text: "Por regla general, no llevan tilde, salvo en casos de tilde diacrítica.", color: "text-gray-800"},
            { title: "Palabras Agudas", text: "Llevan tilde cuando terminan en 'n', 's' o vocal. La sílaba tónica es la última.", color: "text-green-700" },
            { title: "Palabras Llanas (o Graves)", text: "Llevan tilde cuando NO terminan en 'n', 's' o vocal. La sílaba tónica es la penúltima.", color: "text-yellow-700" },
            { title: "Palabras Esdrújulas", text: "Siempre llevan tilde. La sílaba tónica es la antepenúltima.", color: "text-blue-700" },
            { title: "Palabras Sobreesdrújulas", text: "Siempre llevan tilde. La sílaba tónica es anterior a la antepenúltima.", color: "text-purple-700" }
        ];
        let currentRuleIndex = 0;
        let rulesInterval = null;

        function startRulesRotator() {
            stopRulesRotator(); 
            const rulesContainer = document.getElementById('rulesContainer');
            const rulesDisplay = document.getElementById('rulesDisplay');
            if (!rulesContainer || !rulesDisplay) return;

            rulesContainer.classList.remove('hidden');

            const updateRule = () => {
                rulesDisplay.style.opacity = 0;
                setTimeout(() => {
                    const rule = accentuationRules[currentRuleIndex];
                    rulesDisplay.innerHTML = `<h3 class="text-lg font-bold ${rule.color}">${rule.title}</h3><p class="text-gray-700">${rule.text}</p>`;
                    rulesDisplay.style.opacity = 1;
                    currentRuleIndex = (currentRuleIndex + 1) % accentuationRules.length;
                }, 500); 
            };
            
            updateRule(); 
            rulesInterval = setInterval(updateRule, 15000);
        }

        function stopRulesRotator() {
            if (rulesInterval) {
                clearInterval(rulesInterval);
                rulesInterval = null;
            }
            const rulesContainer = document.getElementById('rulesContainer');
            if(rulesContainer) rulesContainer.classList.add('hidden');
        }

        function startGameLoops() {
            if (animationFrameId) return; // Prevent multiple loops
            stopGameLoops();
            startRulesRotator();
            animationFrameId = requestAnimationFrame(mainGameLoop);

            challengeInterval = setInterval(() => {
                if (hasBoughtFirstWord && Math.random() < 0.15 && !isChallengeActive && gameStarted) {
                    startDictionaryChallenge();
                }
            }, 5000);
        }

        function stopGameLoops() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            clearInterval(challengeInterval);
            clearTimeout(wordDisplayTimeout);
            challengeInterval = null;
            lastUpdateTime = 0;
        }
        
        async function startGameCommon(shouldLoad = true) {
            if (shouldLoad) {
                loadPlayerData();
            }
            
            if (activeChallengeOnLoad) {
                handleChallengeFailure("Reto abandonado.");
                activeChallengeOnLoad = false; // Reset the flag
                isChallengeActive = false;
                savePlayerData(); // Save the cleared state
            }

            startGameLoops();
            generateNewWord(true);
            setInterval(savePlayerData, 5000); // Guardado automático cada 5 segundos
        }
        
        function syllabify(word) {
            const originalWord = word;
            word = word.toLowerCase();

            if (word.length <= 3) return [originalWord];

            let syllables = word.match(/[^aeiouáéíóúü]*[aeiouáéíóúü]+(?:[^aeiouáéíóúü](?![aeiouáéíóúü]))?/gi);

            if (syllables) {
                const restored = syllables.join('');
                if (restored !== word) {
                    syllables = word.match(/[^aeiouáéíóúü]*[aeiouáéíóúü]+(?:[bcdfghjklmnpqrstvwxyz](?![lr]))?/gi);
                }
            }
            
            if (!syllables) return [originalWord];

            let restoredSyllables = [];
            let originalIndex = 0;
            for (const syll of syllables) {
                if(syll) {
                    restoredSyllables.push(originalWord.substr(originalIndex, syll.length));
                    originalIndex += syll.length;
                }
            }
            return restoredSyllables;
        }

        function getAccentCategory(word) {
            const originalWord = word;
            const cleanedWord = word.toLowerCase().trim();
            const syllables = syllabify(originalWord);
            const numSyllables = syllables.length;

            if (numSyllables <= 1) {
                return { category: "Agudas", reason: `La palabra '${originalWord}' es un monosílabo. Gramaticalmente, los monosílabos se consideran palabras agudas ya que la fuerza de voz recae en su única (y última) sílaba.` };
            }

            let stressedSyllableIndex = -1;
            const accentedVowels = "áéíóú";
            
            for (let i = 0; i < numSyllables; i++) {
                if (syllables[i].split('').some(char => accentedVowels.includes(char.toLowerCase()))) {
                    stressedSyllableIndex = i;
                    break;
                }
            }

            let category = "Desconocida";
            
            if (stressedSyllableIndex !== -1) {
                const positionFromEnd = numSyllables - 1 - stressedSyllableIndex;
                if (positionFromEnd === 0) category = "Agudas";
                else if (positionFromEnd === 1) category = "Llanas";
                else if (positionFromEnd === 2) category = "Esdrújulas";
                else if (positionFromEnd >= 3) category = "Sobreesdrújulas";
            } else {
                const lastChar = cleanedWord.slice(-1);
                if ('ns'.includes(lastChar) || 'aeiou'.includes(lastChar)) {
                    stressedSyllableIndex = numSyllables - 2;
                    category = "Llanas";
                } else {
                    stressedSyllableIndex = numSyllables - 1;
                    category = "Agudas";
                }
            }
            
            const positionText = ['última', 'penúltima', 'antepenúltima'][numSyllables - 1 - stressedSyllableIndex] || 'anterior a la antepenúltima';
            const stressedSyllableText = `'${syllables[stressedSyllableIndex]}'`;
            let reason = `'${originalWord}' es ${category} porque su sílaba tónica es la ${positionText} (${stressedSyllableText}). `;
            
            switch (category) {
                case "Agudas":
                    if (cleanedWord.split('').some(char => accentedVowels.includes(char))) reason += "Lleva tilde porque las palabras agudas la llevan cuando terminan en 'n', 's' o vocal.";
                    else reason += `No lleva tilde porque las palabras agudas solo la llevan si terminan en 'n', 's' o vocal.`;
                    break;
                case "Llanas":
                     if (cleanedWord.split('').some(char => accentedVowels.includes(char))) reason += `Lleva tilde porque las palabras llanas la llevan cuando NO terminan en 'n', 's' o vocal.`;
                     else reason += `No lleva tilde porque las palabras llanas solo la llevan si NO terminan en 'n', 's' o vocal.`;
                    break;
                case "Esdrújulas":
                case "Sobreesdrújulas":
                     reason += `Las palabras ${category.toLowerCase()}s siempre llevan tilde.`;
                     break;
            }

            return { category, reason };
        }
        
        function updatePrestigeUI() {
            document.getElementById('prestigePointsDisplay').textContent = prestigePoints;
            const container = document.getElementById('prestigeUpgradesContainer');
            container.innerHTML = '';

            Object.keys(prestigeUpgrades).forEach(key => {
                const info = prestigeUpgradeInfo[key];
                const level = prestigeUpgrades[key];
                
                const upgradeCard = document.createElement('div');
                upgradeCard.className = `border-2 rounded-xl p-3 flex items-center justify-between space-x-2 ${info.colors}`;
                
                upgradeCard.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="p-2 rounded-full ${info.colors.split(' ')[0].replace('-50', '-200')}">
                             ${info.icon}
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800" title="${info.desc}">${info.title}</h3>
                            <p class="text-sm font-semibold text-blue-600">Nivel ${level} | ${info.effect(level)}</p>
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <button id="upgrade-${key}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 text-sm rounded-full transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            Mejorar
                        </button>
                    </div>
                `;
                container.appendChild(upgradeCard);
            });
            
            Object.keys(prestigeUpgrades).forEach(key => {
                const button = document.getElementById(`upgrade-${key}`);
                button.disabled = prestigePoints < 1;
                button.onclick = () => upgradePrestige(key);
            });
        }
        
        function upgradePrestige(key) {
            if (prestigePoints > 0) {
                prestigePoints--;
                prestigeUpgrades[key]++;
                updatePrestigeUI();
                savePlayerData();
            }
        }

        function setupEventListeners() {
            document.getElementById('playGameButton').addEventListener('click', continueGame);
            document.getElementById('resetProgressButton').addEventListener('click', startNewGame);
            document.getElementById('tutorialButton').addEventListener('click', () => changeView('tutorial'));
            document.getElementById('buyButton').addEventListener('click', buyWord);
            document.getElementById('shopButton').addEventListener('click', () => changeView('shop'));
            document.getElementById('prestigeButton').addEventListener('click', () => changeView('prestige'));
            document.getElementById('homeButton').addEventListener('click', () => {
                stopGameLoops();
                stopRulesRotator();
                savePlayerData();
                const resetBtn = document.getElementById('resetProgressButton');
                const hasSaveData = localStorage.getItem('dl_player_data');
                if (hasSaveData) {
                    const data = JSON.parse(hasSaveData);
                    const hasProgress = data.words && Object.values(data.words).some(cat => cat.count > 0);
                    resetBtn.style.display = hasProgress ? 'block' : 'none';
                } else {
                    resetBtn.style.display = 'none';
                }
                changeView('startup');
            });
            document.getElementById('backToGameFromTutorial').addEventListener('click', () => changeView('startup'));
            document.getElementById('backToGameFromShop').addEventListener('click', () => changeView('game'));
            document.getElementById('backToGameFromPrestige').addEventListener('click', () => changeView('game'));
            document.getElementById('buyUniversalShield').addEventListener('click', () => buyShield('universal'));
            document.getElementById('buyLifeButton').addEventListener('click', buyLife);
            document.getElementById('modalCloseButton').addEventListener('click', () => {
                document.getElementById('messageModal').classList.add('hidden');
                if (gamePausedForFeedback) {
                    gamePausedForFeedback = false;
                    if (consecutiveFailures < 3) {
                       startGameLoops();
                       generateNewWord(true);
                       savePlayerData();
                    }
                }
            });
            document.getElementById('wordsModalCloseButton').addEventListener('click', () => document.getElementById('wordsModal').classList.add('hidden'));
            document.getElementById('backToGameFromGameOver').addEventListener('click', () => {
                reiniciarJuegoCompleto();
                changeView('game');
                startGameCommon();
            });
            document.getElementById('seguirJugandoButton').addEventListener('click', formatearJuego);
            document.getElementById('reiniciarButton').addEventListener('click', () => {
                reiniciarJuegoCompleto();
                changeView('game');
                startGameCommon();
            });

            document.getElementById('startLimboGramatical').addEventListener('click', () => {
                const modal = document.getElementById('limboGramaticalScreen');
                modal.classList.add('hidden');
                modal.classList.remove('flex');

                limboGramaticalEndTime = Date.now() + 60000;
                startGameLoops(); 
                generateNewWord(true);
            });

            // Guardar el juego automáticamente al cerrar la pestaña/navegador
            window.addEventListener('beforeunload', savePlayerData);
        }

        async function initGame() {
            const resetBtn = document.getElementById('resetProgressButton');
            const hasSaveData = localStorage.getItem('dl_player_data');
            if (hasSaveData) {
                 const data = JSON.parse(hasSaveData);
                 const hasProgress = data.words && Object.values(data.words).some(cat => cat.count > 0);
                 resetBtn.style.display = hasProgress ? 'block' : 'none';
            } else {
                resetBtn.style.display = 'none';
            }
            changeView('startup');
            setupEventListeners();
        }
        
        window.onload = initGame;
    </script>
</body>
</html>
