<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Reto del Diccionario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Fondo oscuro para el tema Halloween */
            color: #e0e0e0;
        }
        .card {
            background-color: #2c2c2c;
            border-color: #444;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .rainbow-text {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: rainbow 2s ease-in-out infinite;
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .halloween-text {
            color: #ff8c00;
            text-shadow:
                -0.5px -0.5px 0 #000,  
                 0.5px -0.5px 0 #000,
                -0.5px  0.5px 0 #000,
                 0.5px  0.5px 0 #000,
                 0 0 2px #ff4500, 0 0 5px #ff4500, 0 0 8px #ffA500, 0 0 10px #ffA500;
            animation: flicker 1.5s infinite alternate;
        }
        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% {
                text-shadow:
                -0.5px -0.5px 0 #000, 0.5px -0.5px 0 #000, -0.5px 0.5px 0 #000, 0.5px 0.5px 0 #000,
                0 0 2px #ff4500,
                0 0 5px #ff4500,
                0 0 10px #ffA500,
                0 0 20px #ffA500,
                0 0 40px #ffA500;
                color: #ffA500;
            }
            20%, 24%, 55% {
                text-shadow: -0.5px -0.5px 0 #000, 0.5px -0.5px 0 #000, -0.5px 0.5px 0 #000, 0.5px 0.5px 0 #000;
                color: #4a2d0c;
            }
        }
        .super-value-text {
            color: #ff5555; /* Rojo claro y brillante */
            font-weight: bold;
            text-shadow: 0 0 5px #ff5555, 0 0 10px #ff2222, 0 0 15px #ff0000; /* Efecto de resplandor rojo */
        }
        #startupScreen, .modal-bg {
            background-color: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(4px);
        }
        
        #limboLexicalBox {
            border: 4px solid;
            border-image-slice: 1;
            border-image-source: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            animation: rainbow-border-animation 2s linear infinite;
        }
        @keyframes rainbow-border-animation {
            to { border-image-source: linear-gradient(-45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3); }
        }

        .glitch-wrapper {
            position: relative;
        }

        .glitch-text::before,
        .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a; /* Match card background */
            overflow: hidden;
            clip-path: inset(50% 50% 50% 50%);
        }

        .glitch-text::before {
            left: -5px;
            text-shadow: 5px 0 magenta;
            animation: glitch-anim-2 0.5s infinite linear alternate-reverse;
        }

        .glitch-text::after {
            left: 5px;
            text-shadow: -5px 0 cyan;
            animation: glitch-anim-1 0.75s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim-1 {
            0% { clip-path: inset(42% 0 55% 0); }
            10% { clip-path: inset(17% 0 75% 0); }
            20% { clip-path: inset(83% 0 1% 0); }
            30% { clip-path: inset(52% 0 40% 0); }
            40% { clip-path: inset(8% 0 85% 0); }
            50% { clip-path: inset(65% 0 25% 0); }
            60% { clip-path: inset(45% 0 50% 0); }
            70% { clip-path: inset(15% 0 80% 0); }
            80% { clip-path: inset(90% 0 2% 0); }
            90% { clip-path: inset(35% 0 58% 0); }
            100% { clip-path: inset(1% 0 95% 0); }
        }
        @keyframes glitch-anim-2 {
            0% { clip-path: inset(95% 0 2% 0); }
            10% { clip-path: inset(25% 0 70% 0); }
            20% { clip-path: inset(5% 0 88% 0); }
            30% { clip-path: inset(68% 0 22% 0); }
            40% { clip-path: inset(88% 0 8% 0); }
            50% { clip-path: inset(48% 0 48% 0); }
            60% { clip-path: inset(18% 0 78% 0); }
            70% { clip-path: inset(82% 0 12% 0); }
            80% { clip-path: inset(22% 0 72% 0); }
            90% { clip-path: inset(62% 0 32% 0); }
            100% { clip-path: inset(92% 0 4% 0); }
        }

        .flicker-anim {
            animation: flicker-animation 1s infinite;
        }

        @keyframes flicker-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #lightning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 255, 255, 0);
            z-index: -1; /* DetrÃ¡s de todo */
            animation: lightning-flash 7s infinite ease-out;
        }

        @keyframes lightning-flash {
            0% { background: rgba(255, 255, 255, 0); }
            90% { background: rgba(255, 255, 255, 0); }
            90.1% { background: rgba(255, 255, 255, 0.8); }
            90.3% { background: rgba(255, 255, 255, 0); }
            93% { background: rgba(255, 255, 255, 0); }
            93.1% { background: rgba(255, 255, 255, 0.6); }
            93.4% { background: rgba(255, 255, 255, 0); }
            100% { background: rgba(255, 255, 255, 0); }
        }

    </style>
</head>
<body class="bg-black font-sans leading-normal tracking-normal min-h-screen">
    <div id="lightning"></div>
    <!-- Pantalla de Inicio -->
    <div id="startupScreen" class="fixed inset-0 modal-bg flex flex-col items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="text-center w-full max-w-4xl mx-auto">
            <h1 class="text-4xl sm:text-6xl font-black halloween-text mb-2">EL RETO DEL DICCIONARIO</h1>
            <h2 class="text-xl sm:text-2xl font-bold halloween-text mb-8">TEMPORADA DE HALLOWEEN</h2>
            <div class="flex flex-col sm:flex-row justify-center items-stretch gap-4">
                <button id="newGameButton" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 transform hover:scale-105 text-lg sm:text-xl">
                    NUEVA PARTIDA
                </button>
                <button id="continueGameButton" class="flex-1 bg-purple-700 hover:bg-purple-800 text-white font-bold py-3 px-8 rounded-lg transition duration-300 transform text-lg sm:text-xl">
                    SEGUIR JUGANDO
                </button>
                 <button id="tutorialButton" class="flex-1 bg-gray-800 hover:bg-black text-white font-bold py-3 px-8 rounded-lg transition duration-300 transform hover:scale-105 text-lg sm:text-xl">
                    Tutorial
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-8 text-center">El Reto del Diccionario - Un juego creado por el TÃ­o Christopher.</p>
        </div>
    </div>
    
    <!-- Tutorial Modal -->
    <div id="tutorialScreen" class="fixed inset-0 modal-bg hidden flex items-center justify-center p-4 z-[100]">
        <div class="w-full max-w-3xl bg-[#1a1a1a] p-6 rounded-xl shadow-2xl max-h-[90vh] hide-scrollbar overflow-y-auto border-4 border-orange-500">
            <div id="integratedTutorial" class="text-left">
                <h2 class="text-2xl font-extrabold text-orange-400 mb-3 text-center">Â¿CÃ³mo se juega?</h2>
                <p class="text-md text-gray-300 mb-4 leading-relaxed text-center">
                    El objetivo es acumular <span class="font-bold text-orange-400">palabras</span> y <span class="font-bold text-green-400">dinero</span> para dominar la acentuaciÃ³n.<br>
                    <span class="text-sky-400 font-semibold">Ganas al conseguir la palabra <span class="underline decoration-sky-400">SobreesdrÃºjula</span>.</span>
                </p>
                <ol class="list-decimal pl-5 space-y-4 text-sm text-gray-300">
                    <li>
                        <span class="font-bold text-green-400">Jugar y Ganar:</span> Compra palabras para tu colecciÃ³n y gana dinero automÃ¡ticamente. A mÃ¡s riqueza, mayor <span class="font-bold text-yellow-400">inflaciÃ³n</span>. Para ganar, necesitas <span class="font-bold">30 palabras</span> de cada una de las categorÃ­as principales y <span class="font-bold text-purple-400">mucho dinero</span> para la palabra final.
                    </li>
                    <li>
                        <span class="font-bold text-rose-400">El DesafÃ­o:</span> Â¡Cuidado! El Diccionario te examinarÃ¡. Escribe una palabra de una categorÃ­a especÃ­fica en <span class="font-bold">30 segundos</span>. La palabra debe ser perfecta (mayÃºscula inicial, tildes) y no usada antes en retos. Si fallas, pierdes todo. Si aciertas, ganas dinero. Â¡Tras <span class="font-bold">3 fallos seguidos</span>, pierdes todo tu progreso!
                    </li>
                    <li>
                        <span class="font-bold text-sky-400">Protege tu Riqueza:</span> Usa la Tienda para comprar el <span class="font-bold text-blue-400">Escudo Universal</span> y <span class="font-bold text-green-400">Vidas</span>. Los precios de la tienda <span class="font-bold">NUNCA</span> cambian. <span class="font-bold text-red-500">Importante:</span> La tienda estÃ¡ deshabilitada en tu primera partida (Multiplicador x1).
                    </li>
                    <li>
                        <span class="font-bold text-fuchsia-400">Palabras Especiales y Bonus:</span>
                        <ul class="list-disc pl-5 mt-2 space-y-2">
                            <li>
                                <strong class="super-value-text">Super Value:</strong> Palabras en <span class="super-value-text">rojo</span>. Cuestan el doble pero activan un <span class="font-bold">potenciador x2</span> por 10s en su categorÃ­a.
                            </li>
                            <li>
                                <strong class="font-extrabold">Bonus <span class="rainbow-text">CHRISTOPHER</span>:</strong> Gratis y con 3% de probabilidad. Activa un <span class="font-bold">Potenciador Global x2</span> por 60s en todo (excepto SobreesdrÃºjulas). Â¡Es acumulable!
                            </li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-bold text-gray-200">Eventos especiales:</span>
                        <ul class="list-disc pl-5 mt-2 space-y-2">
                             <li>
                                <span class="glitch-wrapper">
                                    <strong class="rainbow-text glitch-text flicker-anim" data-text="Limbo GramÃ¡tical: ???">Limbo GramÃ¡tical: ???</strong>
                                </span>
                            </li>
                            <li>
                                <strong class="text-gray-200">Eventos de temporada (temporada actual):</strong> <span class="halloween-text font-bold">Halloween</span> (finaliza el 31 de Octubre).
                            </li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-bold text-purple-400">Formatear el Juego:</span> Al ganar, puedes "<span class="font-bold">formatear</span>". Reinicias con un multiplicador permanente que aumenta tu dinero inicial y el valor de las palabras, Â¡haciendo el juego mÃ¡s intenso!
                    </li>
                </ol>
            </div>
             <div class="text-center w-full">
                <button id="backToGameFromTutorial" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 mt-6">
                    Cerrar
                </button>
            </div>
        </div>
    </div>


    <!-- Game Container -->
    <div class="container mx-auto p-2 flex flex-col items-center min-h-screen">
        <div id="gameScreen" class="flex flex-col items-center w-full">
            <div class="flex flex-col lg:flex-row justify-center items-stretch w-full gap-4">
                
                <div class="flex flex-col items-center justify-center flex-1 text-center border p-4 rounded-xl shadow-lg card">
                    <h2 class="text-xl font-bold text-green-400">Tu Riqueza</h2>
                    <p id="playerMoney" class="text-2xl sm:text-3xl font-extrabold text-green-300 mt-2">0</p>
                    <p class="text-sm text-gray-400 mt-1">Ingreso Pasivo: <span id="passiveIncome" class="font-bold">0.0</span>/seg</p>
                </div>

                <div class="flex flex-col items-center flex-1 text-center border p-4 rounded-xl shadow-lg card">
                    <h3 class="text-xl font-bold mb-2">Palabra Actual</h3>
                    <p id="currentWord" class="text-3xl sm:text-5xl font-black mb-1">Cargando...</p>
                    <p id="wordCategory" class="text-md font-semibold text-gray-400 mb-1"></p>
                    <p id="wordValue" class="text-md font-extrabold text-blue-400"></p>
                    <div class="flex justify-center space-x-2 mt-2">
                        <button id="buyButton" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 text-sm">
                            Comprar
                        </button>
                    </div>
                    <div id="wordTimerBarContainer" class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                        <div id="wordTimerBar" class="h-2.5 rounded-full" style="width: 100%; transition: width 0.05s linear, background-color 0.5s ease;"></div>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap lg:flex-nowrap w-full gap-4 mt-4 text-center border p-4 rounded-xl shadow-lg card">
                <div class="w-full">
                    <h2 class="text-xl font-bold text-gray-200 mb-4 text-center">Tu ColecciÃ³n de Palabras</h2>
                    <div id="inventoryContainer" class="flex flex-row overflow-x-auto whitespace-nowrap space-x-2 p-2">
                    </div>
                </div>
            </div>
            
            <div id="rulesContainer" class="w-full mt-4 text-center border p-4 rounded-xl shadow-lg hidden flex flex-col justify-center min-h-[110px] card">
                <div id="rulesDisplay" class="transition-opacity duration-500 ease-in-out">
                    <!-- Rules will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de estado y botones del juego -->
    <div id="gameControls" class="fixed bottom-0 left-0 right-0 w-full flex flex-wrap justify-center items-center gap-2 p-3 bg-black border-t-2 border-gray-700 z-10">
        <div class="bg-gray-800 p-2 px-4 rounded-full shadow-lg border-2 text-white font-extrabold text-lg flex-shrink-0 w-24 text-center">
            <span id="lifeCounter">3/3</span>
        </div>
        <div class="bg-gray-800 p-2 px-4 rounded-full shadow-lg border-2 border-gray-700 text-white font-extrabold text-lg flex-shrink-0 w-24 text-center">
            <span id="currentMultiplier">1x</span>
        </div>
        <div id="limboGramaticalTimerDisplay" class="bg-gray-800 p-2 px-4 rounded-full shadow-lg border-2 font-extrabold text-lg flex-shrink-0 hidden w-24 text-center glitch-wrapper">
            <span class="rainbow-text glitch-text" data-text="0s">0s</span>
        </div>
        <div id="christopherTimerDisplay" class="bg-gray-800 p-2 px-4 rounded-full shadow-lg border-2 border-gray-700 font-extrabold text-lg flex-shrink-0 hidden w-24 text-center">
            <span class="rainbow-text">0s</span>
        </div>
        <div id="superValueTimerDisplay" class="bg-gray-800 p-2 px-4 rounded-full shadow-lg border-2 font-extrabold text-lg flex-shrink-0 hidden w-24 text-center">
            <span class="super-value-text">0s</span>
        </div>
        <button id="shopButton" class="bg-purple-700 hover:bg-purple-800 p-2 px-4 rounded-full shadow-lg border-2 border-gray-700 text-white font-extrabold text-lg transition duration-300 transform hover:scale-105 w-24 text-center">
            Tienda
        </button>
        <button id="homeButton" class="bg-gray-800 hover:bg-black p-2 px-4 rounded-full shadow-lg border-2 border-gray-700 text-white font-extrabold text-lg transition duration-300 transform hover:scale-105 w-24 text-center">
            Inicio
        </button>
    </div>

    <!-- Modal for Shop -->
    <div id="shopScreen" class="fixed inset-0 modal-bg hidden items-center justify-center p-4 z-[100]">
        <div class="w-full max-w-4xl bg-[#1a1a1a] p-4 sm:p-8 rounded-xl shadow-lg max-h-[90vh] hide-scrollbar overflow-y-auto border-4 border-purple-500">
            <h2 class="text-2xl font-bold text-gray-200 mb-6 text-center">Tienda</h2>
            <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                 <!-- Agua Bendita -->
                <div class="flex-1 bg-yellow-900/50 border-2 border-yellow-700 rounded-xl p-4">
                    <h3 class="text-lg font-bold text-yellow-300 mb-2">Agua Bendita</h3>
                    <p class="text-sm text-yellow-400 mb-3">Elimina una maldiciÃ³n de Halloween de una categorÃ­a al azar.</p>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold text-yellow-200" id="aguaBenditaPrice">100,000 ðŸ’°</span>
                        <button id="buyAguaBenditaButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105">
                            Comprar
                        </button>
                    </div>
                </div>
                <!-- Comprar Vida -->
                <div class="flex-1 bg-red-900/50 border-2 border-red-700 rounded-xl p-4">
                    <h3 class="text-lg font-bold text-red-300 mb-2">Comprar Vida</h3>
                    <p class="text-sm text-red-400 mb-3">Recupera una vida perdida. Â¡Solo en emergencias!</p>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold text-red-200" id="lifePrice">2,000,000 ðŸ’°</span>
                        <button id="buyLifeButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105">
                            Comprar
                        </button>
                    </div>
                </div>
                <!-- Escudo Universal -->
                <div class="flex-1 bg-purple-900/50 border-2 border-purple-700 rounded-xl p-4">
                    <h3 class="text-lg font-bold text-purple-300 mb-2">Escudo Universal</h3>
                    <p class="text-sm text-purple-400 mb-3">Protege contra TODOS los retos por 60 segundos</p>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold text-purple-200" id="universalPrice">800,000 ðŸ’°</span>
                        <button id="buyUniversalShield" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105">
                            Comprar
                        </button>
                    </div>
                    <p class="text-xs text-purple-400 mt-2">Cantidad: <span id="universalCount">0</span></p>
                </div>
            </div>
            <div class="text-center mt-6">
                <button id="backToGameFromShop" class="bg-gray-800 hover:bg-black text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105">
                    Cerrar Tienda
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Messages -->
    <div id="messageModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4">
        <div class="bg-[#1a1a1a] p-6 max-w-sm w-full text-center rounded-xl shadow-lg border border-orange-500">
            <p id="modalMessage" class="text-lg font-semibold text-gray-200 mb-4"></p>
            <button id="modalCloseButton" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-full">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal for Word List -->
    <div id="wordsModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4">
        <div class="bg-[#1a1a1a] p-6 max-w-sm w-full text-center rounded-xl shadow-lg border border-gray-700">
            <h3 id="wordsModalTitle" class="text-xl font-bold text-gray-200 mb-4"></h3>
            <ul id="wordsList" class="max-h-64 overflow-y-auto text-left mb-4 px-2">
            </ul>
            <button id="wordsModalCloseButton" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-full">Cerrar</button>
        </div>
    </div>

    <!-- Modal for Dictionary Challenge -->
    <div id="dictionaryModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4">
        <div class="bg-[#1a1a1a] p-8 max-w-md w-full text-center rounded-xl shadow-2xl border-4 border-red-500">
            <h3 class="text-3xl font-extrabold text-red-500 mb-2">Â¡EL DICCIONARIO!</h3>
            <p class="text-md text-gray-300 mb-4">Escribe una palabra de la categorÃ­a:</p>
            <p id="challengeCategory" class="text-4xl font-black mb-4"></p>
            <p class="text-sm font-bold text-gray-400">Tiempo restante: <span id="timer" class="text-red-500">30</span>s</p>
            <input id="challengeInput" type="text" class="w-full mt-4 p-3 text-center text-lg font-semibold border-2 border-gray-600 rounded-lg focus:outline-none focus:border-red-500 bg-gray-800 text-white">
        </div>
    </div>

    <!-- Modal for Loading -->
    <div id="loadingModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4">
        <div class="bg-[#1a1a1a] p-6 max-w-sm w-full text-center rounded-xl shadow-lg flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold text-gray-200 mt-4">Verificando palabra...</p>
        </div>
    </div>

    <!-- Modal for Game Over -->
    <div id="gameOverScreen" class="fixed inset-0 bg-red-900/80 backdrop-blur-sm hidden flex flex-col justify-center items-center p-0">
        <div class="bg-red-800 text-white p-8 w-full h-full text-center flex flex-col justify-center items-center">
            <h2 class="text-5xl font-extrabold mb-4">GAME OVER</h2>
            <p id="gameOverMessage" class="text-lg mb-6"></p>
            <button id="backToGameFromGameOver" class="bg-white text-red-800 font-bold py-3 px-6 rounded-full transition duration-300 transform hover:scale-105">
                Volver a intentarlo
            </button>
        </div>
    </div>

    <!-- Pantalla de Victoria -->
    <div id="winScreen" class="fixed inset-0 bg-green-900/80 backdrop-blur-sm hidden flex flex-col justify-center items-center p-0">
        <div class="bg-green-700 text-white p-8 w-full h-full text-center flex flex-col justify-center items-center">
            <h2 class="text-5xl font-extrabold mb-4">Â¡HAS GANADO!</h2>
            <p id="winMessage" class="text-lg mb-6"></p>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button id="seguirJugandoButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-full transition duration-300 transform hover:scale-105">
                    Seguir jugando (x<span id="nextMultiplier">2</span>)
                </button>
                <button id="reiniciarButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full transition duration-300 transform hover:scale-105">
                    Reiniciar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Halloween Notice -->
    <div id="halloweenNoticeScreen" class="fixed inset-0 modal-bg hidden flex-col items-center justify-center p-8 z-[101]">
        <div class="w-full max-w-md bg-[#1a1a1a] p-8 rounded-xl shadow-2xl border-4 border-orange-500 text-center">
            <h2 class="text-3xl font-extrabold halloween-text mb-4">Â¡Evento de Temporada!</h2>
            <p class="text-md text-gray-300 mb-6">
                Ha llegado la <strong class="halloween-text">MaldiciÃ³n de Halloween</strong>. Ten cuidado con las palabras embrujadas que aparecen, Â¡podrÃ­an afectar tus ganancias!
            </p>
            <button id="closeHalloweenNotice" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-full transition duration-300 transform hover:scale-105">
                Entendido
            </button>
        </div>
    </div>

    <!-- Modal for Limbo Gramatical -->
    <div id="limboGramaticalScreen" class="fixed inset-0 modal-bg hidden flex-col items-center justify-center p-8 z-[102]">
        <div class="w-full max-w-md bg-[#1a1a1a] p-8 rounded-xl shadow-2xl text-center relative z-[102] border-4 border-purple-500">
            <div class="glitch-wrapper">
                <h2 class="text-3xl font-extrabold rainbow-text glitch-text mb-4" data-text="Â¡Limbo GramÃ¡tical!">Â¡Limbo GramÃ¡tical!</h2>
            </div>
            <p class="text-md text-gray-300 mb-6">
                 El TÃ­o Christopher tiene un regalo para ti. AprovÃ©chalo.
            </p>
            <button id="startLimboGramatical" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full transition duration-300 transform hover:scale-105">
                Entendido
            </button>
        </div>
    </div>


    <script type="module">
        // --- Firebase (Offline Mode) ---
        const appId = 'github-pages-app';
        let db = null;
        let auth = null;
        let userId;
        let offlineMode = true;

        // --- Game State Variables ---
        let playerMoney = 100;
        let playerWords = {};
        let usedChallengeWords = {};
        let currentWord = {};
        let passiveIncome = 0;
        let gameMultiplier = 1;
        let initialCredits = 100;
        let consecutiveFailures = 0;
        let shields = { universal: 0 };
        
        // --- Timers and Intervals ---
        let gameLoopInterval = null;
        let uiUpdateInterval;
        let wordDisplayTimeout;
        let challengeInterval = null;
        let challengeTimerInterval;
        let isChallengeActive = false;
        
        // --- Bonus State ---
        let universalShieldEndTime = 0;
        let christopherBoostEndTime = 0;
        let superValueBoosts = {}; // Objeto para manejar los potenciadores por categorÃ­a
        let limboGramaticalEndTime = 0;
        let limboGramaticalTriggeredThisPartida = false;
        let christopherBonusCountDuringLimbo = 0;

        // --- UI & Game Flow ---
        let currentView = 'game';
        let gameStarted = false;
        let hasBoughtFirstWord = false;
        let gamePausedForFeedback = false;
        let actionAfterNotice = null;
        
        // --- Game Constants ---
        const PRICE_PER_LETTER = 15;
        const SUPER_VALUE_MULTIPLIER = 2;
        const INFLATION_FACTOR = 100;
        const SHIELD_PRICE_UNIVERSAL = 800000;
        const LIFE_PRICE = 2000000;
        const AGUA_BENDITA_BASE_PRICE = 100000;
        const CHALLENGE_REWARDS = { "Agudas": 10000, "Llanas": 20000, "EsdrÃºjulas": 40000 };
        
        const BASE_WORD_DATABASE = {
             "MonosÃ­labos": {
                value: 10,
                words: ["Sol", "Mar", "Luz", "Voz", "Pan", "Sal", "Miel", "Tren", "Flor", "Rey", "Son", "Paz", "Bien", "Mal", "Gas", "No", "SÃ­", "Yo", "Ã‰l", "TÃº", "Ve", "Da", "SÃ©", "Vi", "Di", "Pie", "Fe", "Ley", "Don", "Fin", "Mes", "Mil", "Res", "Ron", "Set", "Sur", "Tal", "Tez", "Zas", "Dar"],
                superValueWords: ["Flor", "Voz", "Rey", "Paz"],
                halloweenWords: ["Â¡Bu!", "Â¡Uuuuu!", "Â¡Miau!"],
                limit: 30
            },
            "Agudas": {
                value: 100,
                words: ["AcciÃ³n", "AdicciÃ³n", "AdemÃ¡s", "AndÃ©n", "BalÃ³n", "BebÃ©", "CafÃ©", "CamiÃ³n", "CanciÃ³n", "ColibrÃ­", "CorazÃ³n", "DespuÃ©s", "EmociÃ³n", "InterÃ©s", "JabalÃ­", "JamÃ¡s", "JardÃ­n", "JazmÃ­n", "MenÃº", "PaÃ­s", "ParÃ­s", "PasiÃ³n", "PerfecciÃ³n", "PortuguÃ©s", "RevoluciÃ³n", "SofÃ¡", "SoluciÃ³n", "TambiÃ©n", "VisiÃ³n", "VolcÃ¡n", "ComiÃ³", "EstudiÃ³", "HablÃ³", "ViviÃ³", "GanarÃ¡"],
                superValueWords: ["ColibrÃ­", "JazmÃ­n", "PasiÃ³n", "RevoluciÃ³n"],
                halloweenWords: ["AtaÃºd", "Terror", "ComÃºn"],
                limit: 30
            },
            "Llanas": {
                value: 250,
                words: ["Ãrbol", "Ãngel", "AzÃºcar", "CÃ¡ncer", "CÃ¡rcel", "CarÃ¡cter", "CÃ©sped", "ClÃ­max", "CrÃ¡ter", "DÃ­a", "DifÃ­cil", "DÃ³lar", "Ã‰ter", "FÃ¡cil", "FÃ³sil", "FÃºtbol", "HuÃ©sped", "LÃ¡piz", "LÃ­der", "MÃ¡rtir", "MÃ³vil", "NÃ¡car", "PoesÃ­a", "PÃ³ker", "RÃ­o", "TÃ³rax", "TrÃ©bol", "TÃºnel", "GeografÃ­a", "BiologÃ­a", "FilosofÃ­a", "TecnologÃ­a", "PsicologÃ­a", "EconomÃ­a", "AnatomÃ­a", "SandÃ­a", "PolicÃ­a"],
                superValueWords: ["CarÃ¡cter", "CrÃ¡ter", "PoesÃ­a", "GeografÃ­a"],
                halloweenWords: ["Bruja", "MÃ¡scara", "Momia"],
                limit: 30
            },
            "EsdrÃºjulas": {
                value: 500,
                words: ["AnÃ¡lisis", "AntÃ¡rtida", "AtmÃ³sfera", "BolÃ­grafo", "BrÃºjula", "CÃ¡lculo", "CatÃ¡strofe", "CÃ­rculo", "ClÃ­nica", "CÃ³mpralo", "DÃ©ficit", "EsdrÃºjula", "EstÃ³mago", "Ã‰xito", "FÃ¡brica", "FÃ³sforo", "GramÃ¡tica", "HÃ­gado", "HÃ©roe", "HipÃ³crita", "Ãndice", "LÃ¡grima", "LÃ³gico", "MÃ¡gico", "MÃ¡quina", "MatemÃ¡ticas", "MÃ©dico", "MiÃ©rcoles", "MurciÃ©lago", "MÃºsculo", "MÃºsica", "NÃºmero", "OxÃ­geno", "PÃ¡gina", "PÃ¡jaro", "PlÃ¡tano", "PÃºblico", "QuÃ­mica", "RÃ¡pido", "SÃ¡bado", "SemÃ¡foro", "SÃ­laba", "TelÃ©fono", "TÃ©rmino", "TrÃ¡fico", "Ãšltimo", "VÃ©rtebra", "VÃ­ctima", "AÃ©reo", "CÃ©lula"],
                superValueWords: ["AtmÃ³sfera", "MurciÃ©lago", "CientÃ­fico", "MatemÃ¡ticas"],
                halloweenWords: ["CrÃ¡neo", "MurciÃ©lago", "MÃ¡gico"],
                limit: 30
            },
            "SobreesdrÃºjulas": {
                value: 1000000,
                words: ["AgradÃ©ceselo", "AprÃ©ndetelo", "AverÃ­guamelo", "BÃºscaselo", "ComprÃ¡ndomelo", "DÃ­gamelo", "DÃ­ceselo", "EnciÃ©ndemelo", "EntrÃ©gaselo", "ExplÃ­caselo", "GuÃ¡rdaselo", "HÃ¡gaselo", "JÃºraselo", "LlÃ©vaselo", "PÃ­demelo", "PÃ¡saselo", "RepÃ­teselo", "TrÃ¡igaselo", "VÃ©ndeselo", "DedicÃ¡ndoselo", "EstudiÃ¡ndotelo", "ExplicÃ¡ndoselo", "RepitiÃ©ndoselo", "ComiÃ©ndoselo", "EscribiÃ©ndotelo", "MirÃ¡ndoselo", "PreparÃ¡ndomelo", "ComprÃ¡ndoselo", "LlamÃ¡ndoselo", "EncontrÃ¡ndoselo", "RecibiÃ©ndoselo", "EntregÃ¡ndoselo", "AceptÃ¡ndoselo", "AconsejÃ¡ndoselo", "AcompaÃ±Ã¡ndotelo", "AprendiÃ©ndotelo", "BendiciÃ©ndotelo", "BuscÃ¡ndoselo", "CelebrÃ¡ndoselo", "ComentÃ¡ndoselo"],
                superValueWords: [],
                halloweenWords: [],
                limit: 1
            }
        };

        let WORD_DATABASE = JSON.parse(JSON.stringify(BASE_WORD_DATABASE));

        const categoryColors = { "MonosÃ­labos": "text-gray-400", "Agudas": "text-green-400", "Llanas": "text-yellow-400", "EsdrÃºjulas": "text-blue-400", "SobreesdrÃºjulas": "text-purple-400" };
        const categoryBackgrounds = { "MonosÃ­labos": "bg-gray-700/50 hover:bg-gray-600/50", "Agudas": "bg-green-800/50 hover:bg-green-700/50", "Llanas": "bg-yellow-800/50 hover:bg-yellow-700/50", "EsdrÃºjulas": "bg-blue-800/50 hover:bg-blue-700/50", "SobreesdrÃºjulas": "bg-purple-800/50 hover:bg-purple-700/50" };
        const superValueColor = "super-value-text";
        
        let audioCtx;
        function playBellSound() {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(987.77, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.5);
        }

        function playHalloweenSound() {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.type = 'sawtooth';
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);

            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(220, audioCtx.currentTime + 0.7);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.7);

            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.7);
        }

        function playWinSound() {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const gainNode = audioCtx.createGain();
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0.3, now);

            const freqs = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
            freqs.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                osc.connect(gainNode);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(freq, now + i * 0.1);
                osc.start(now + i * 0.1);
                osc.stop(now + i * 0.1 + 0.1);
            });
            gainNode.gain.exponentialRampToValueAtTime(0.00001, now + 0.8);
        }

        function playGameOverSound() {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const gainNode = audioCtx.createGain();
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0.4, now);

            const freqs = [110.00, 103.83, 98.00, 92.50]; // A2, G#2, G2, F#2
             freqs.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                osc.connect(gainNode);
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(freq, now + i * 0.15);
                osc.start(now + i * 0.15);
                osc.stop(now + i * 0.15 + 0.15);
            });
            gainNode.gain.exponentialRampToValueAtTime(0.00001, now + 1.2);
        }


        function applyScalingToWordDatabase(multiplier) {
            WORD_DATABASE = JSON.parse(JSON.stringify(BASE_WORD_DATABASE));
            Object.keys(WORD_DATABASE).forEach(category => {
                WORD_DATABASE[category].value = BASE_WORD_DATABASE[category].value * multiplier;
            });
        }

        function recalculatePassiveIncome() {
            passiveIncome = 0;
            const now = Date.now();
            Object.keys(playerWords).forEach(category => {
                if (playerWords[category] && WORD_DATABASE[category] && category !== "SobreesdrÃºjulas") {
                    const count = playerWords[category].count || 0;
                    const baseValue = WORD_DATABASE[category].value;
                    const halloweenDebuff = playerWords[category].halloweenDebuff || 1;
                    
                    let categoryIncome = count * baseValue * halloweenDebuff;

                    // Comprueba si hay un potenciador Super Value activo para ESTA categorÃ­a
                    if (superValueBoosts[category] && now < superValueBoosts[category]) {
                        categoryIncome *= SUPER_VALUE_MULTIPLIER;
                    }
                    passiveIncome += categoryIncome;
                }
            });
        }
        
        function resetGameData() {
            playerMoney = initialCredits;
            passiveIncome = 0;
            consecutiveFailures = 0;
            usedChallengeWords = {};
            shields = { universal: 0 };
            christopherBoostEndTime = 0;
            superValueBoosts = {};
            universalShieldEndTime = 0;
            limboGramaticalEndTime = 0;
            hasBoughtFirstWord = false;
            limboGramaticalTriggeredThisPartida = false;
            christopherBonusCountDuringLimbo = 0;

            Object.keys(WORD_DATABASE).forEach(category => {
                playerWords[category] = { count: 0, list: [], halloweenDebuff: 1, halloweenWordsCollected: 0, halloweenList: [] };
            });
        }
        
        function resetProgressButKeepLives() {
            playerMoney = 0;
            passiveIncome = 0;
            Object.keys(playerWords).forEach(category => {
                if (playerWords[category]) {
                    playerWords[category].count = 0;
                    playerWords[category].list = [];
                    // Al no tocar halloweenDebuff o halloweenWordsCollected, la maldiciÃ³n persiste.
                }
            });
        }

        function formatearJuego() {
            gameMultiplier++;
            initialCredits *= 2;
            applyScalingToWordDatabase(gameMultiplier);
            resetGameData();
            playerMoney = initialCredits;
            savePlayerData(); // Guardar el estado reseteado inmediatamente
            updateUI();
            changeView('game');
            startGameCommon(false); // Iniciar loops sin recargar los datos guardados
            showModal(`Â¡Juego formateado! Multiplicador: ${gameMultiplier}x. CrÃ©ditos iniciales: ${initialCredits}`);
        }
        
        function reiniciarJuegoCompleto() {
            gameMultiplier = 1;
            initialCredits = 100;
            applyScalingToWordDatabase(1);
            resetGameData();
            playerMoney = initialCredits;
            savePlayerData();
        }

        function showModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').classList.remove('hidden');
            document.getElementById('messageModal').classList.add('flex');
        }

        function changeView(view) {
            currentView = view;
            ['gameScreen', 'startupScreen', 'shopScreen', 'gameOverScreen', 'winScreen', 'gameControls', 'tutorialScreen', 'limboGramaticalScreen'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            const screen = document.getElementById(`${view}Screen`);
            if (screen) screen.classList.remove('hidden');

            if (view === 'game') {
                const controls = document.getElementById('gameControls');
                if (controls) controls.classList.remove('hidden');
            } else if (view === 'shop') {
                if (screen) screen.classList.add('flex'); // Ensure shop is flex for centering
                updateShopUI();
            }
        }
        
        async function startNewGame() {
            actionAfterNotice = proceedWithNewGame;
            document.getElementById('halloweenNoticeScreen').classList.remove('hidden');
            document.getElementById('halloweenNoticeScreen').classList.add('flex');
        }

        async function continueGame() {
            actionAfterNotice = proceedWithContinueGame;
            document.getElementById('halloweenNoticeScreen').classList.remove('hidden');
            document.getElementById('halloweenNoticeScreen').classList.add('flex');
        }
        
        async function proceedWithNewGame() {
            localStorage.removeItem('dl_player_data');
            reiniciarJuegoCompleto();
            gameStarted = true;
            changeView('game');
            await startGameCommon(true);
        }
        
        async function proceedWithContinueGame() {
            gameStarted = true;
            changeView('game');
            await startGameCommon(true);
        }

        function updateShopUI() {
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            const discount = isLimboActive ? 0.79 : 1;

             // Shop Button itself
            const shopButton = document.getElementById('shopButton');
            const isShopDisabled = gameMultiplier === 1;
            shopButton.disabled = isShopDisabled;
            shopButton.classList.toggle('opacity-50', isShopDisabled);
            shopButton.classList.toggle('cursor-not-allowed', isShopDisabled);

            // Agua Bendita
            const aguaBenditaPrice = (AGUA_BENDITA_BASE_PRICE * gameMultiplier) * discount;
            document.getElementById('aguaBenditaPrice').textContent = `${aguaBenditaPrice.toLocaleString('es')} ðŸ’°`;
            const buyAguaBenditaBtn = document.getElementById('buyAguaBenditaButton');
            const hasCurses = Object.values(playerWords).some(cat => cat.halloweenDebuff < 1);
            const canAffordAgua = playerMoney >= aguaBenditaPrice;
            buyAguaBenditaBtn.disabled = !hasCurses || !canAffordAgua;
            buyAguaBenditaBtn.classList.toggle('opacity-50', !hasCurses || !canAffordAgua);
            buyAguaBenditaBtn.classList.toggle('cursor-not-allowed', !hasCurses || !canAffordAgua);
            
            // Universal Shield
            const shieldPrice = SHIELD_PRICE_UNIVERSAL * discount;
            document.getElementById('universalPrice').textContent = `${shieldPrice.toLocaleString('es')} ðŸ’°`;
            const buyUniversalShieldBtn = document.getElementById('buyUniversalShield');
            const canAffordShield = playerMoney >= shieldPrice;
            buyUniversalShieldBtn.disabled = !canAffordShield;
            buyUniversalShieldBtn.classList.toggle('opacity-50', !canAffordShield);
            buyUniversalShieldBtn.classList.toggle('cursor-not-allowed', !canAffordShield);
            document.getElementById('universalCount').textContent = shields.universal;

            // Buy Life
            const lifePrice = LIFE_PRICE * discount;
            document.getElementById('lifePrice').textContent = `${lifePrice.toLocaleString('es')} ðŸ’°`;
            const buyLifeBtn = document.getElementById('buyLifeButton');
            const canAffordLife = playerMoney >= lifePrice;
            const needsLife = consecutiveFailures > 0;
            const canBuyLife = canAffordLife && needsLife;
            buyLifeBtn.disabled = !canBuyLife;
            buyLifeBtn.classList.toggle('opacity-50', !canBuyLife);
            buyLifeBtn.classList.toggle('cursor-not-allowed', !canBuyLife);
        }

        function buyShield() {
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            const price = SHIELD_PRICE_UNIVERSAL * (isLimboActive ? 0.79 : 1);
            if (playerMoney >= price) {
                playerMoney -= price;
                shields.universal++;
                updateUI();
                updateShopUI();
                savePlayerData();
                showModal(`Â¡Escudo Universal comprado! Tienes ${shields.universal}.`);
            } else {
                showModal(`Â¡No tienes suficiente dinero!`);
            }
        }
        
        function buyLife() {
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            const price = LIFE_PRICE * (isLimboActive ? 0.79 : 1);
            if (consecutiveFailures > 0 && playerMoney >= price) {
                playerMoney -= price;
                consecutiveFailures--;
                updateUI();
                updateShopUI();
                savePlayerData();
                showModal(`Â¡Has recuperado una vida!`);
            } else if (consecutiveFailures === 0) {
                 showModal(`Tienes todas tus vidas.`);
            } else {
                showModal(`Â¡No tienes suficiente dinero!`);
            }
        }

        function buyAguaBendita() {
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            const price = (AGUA_BENDITA_BASE_PRICE * gameMultiplier) * (isLimboActive ? 0.79 : 1);
            const cursedCategories = Object.keys(playerWords).filter(cat => playerWords[cat].halloweenDebuff < 1);

            if (cursedCategories.length > 0 && playerMoney >= price) {
                playerMoney -= price;
                const randomCursedCategory = cursedCategories[Math.floor(Math.random() * cursedCategories.length)];
                const categoryData = playerWords[randomCursedCategory];
                
                if (categoryData.halloweenWordsCollected > 0) {
                    categoryData.halloweenWordsCollected--;
                    categoryData.halloweenDebuff = Math.pow(0.985, categoryData.halloweenWordsCollected);
                }

                updateUI();
                updateShopUI();
                savePlayerData();
                showModal(`Â¡Una maldiciÃ³n ha sido eliminada de la categorÃ­a ${randomCursedCategory}!`);
            } else {
                showModal('Â¡No tienes suficiente dinero o no hay maldiciones que eliminar!');
            }
        }
        
        function startWordDisplayTimer(duration) {
            clearTimeout(wordDisplayTimeout);
            wordDisplayTimeout = setTimeout(() => {
                if (!isChallengeActive) generateNewWord(true);
            }, duration);
        }

        function triggerLimboGramatical() {
            christopherBonusCountDuringLimbo = 0; // Reset counter when event starts
            savePlayerData(); 
            stopGameLoops();
            stopRulesRotator();
            
            const modal = document.getElementById('limboGramaticalScreen');
            if(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        async function generateNewWord(forceNew = false) {
            if (isChallengeActive) return;
            
            // Trigger for Limbo Gramatical event (1.5% chance, once per game)
            if (hasBoughtFirstWord && !limboGramaticalTriggeredThisPartida && Math.random() < 0.015) {
                limboGramaticalTriggeredThisPartida = true;
                triggerLimboGramatical();
                return; // Stop function to show the modal
            }
            
            if (forceNew) clearTimeout(wordDisplayTimeout);
            
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            let christopherChance = 0.03; // Base chance
            if (isLimboActive && christopherBonusCountDuringLimbo < 3) {
                christopherChance += 0.21; // Increased chance during Limbo
            }

            let wordTypeChance = Math.random();
            
            // Bonus CHRISTOPHER
            if (wordTypeChance < christopherChance) {
                if (isLimboActive) {
                    christopherBonusCountDuringLimbo++;
                }
                currentWord = { word: "CHRISTOPHER", category: "Bonus", value: 0, isBonus: true, startTime: Date.now() };
                playBellSound();
                updateUI();
                startWordDisplayTimer(1000); // 1 segundo
                return;
            }
            // Adjust the chance for Halloween words based on Christopher's chance
            if (wordTypeChance < christopherChance + 0.30) {
                const availableCategories = Object.keys(WORD_DATABASE).filter(c => c !== "SobreesdrÃºjulas" && (playerWords[c]?.halloweenWordsCollected || 0) < 2);
                if (availableCategories.length > 0) {
                    const category = availableCategories[Math.floor(Math.random() * availableCategories.length)];
                    const halloweenWords = WORD_DATABASE[category].halloweenWords;
                    if (halloweenWords.length > 0) {
                        currentWord = { word: halloweenWords[Math.floor(Math.random() * halloweenWords.length)], category: category, value: 0, isHalloween: true, startTime: Date.now() };
                        updateUI();
                        startWordDisplayTimer(3000);
                        return;
                    }
                }
            }

            // Palabra Normal
            let categories = Object.keys(WORD_DATABASE);
            const nonFinalCategories = categories.filter(c => c !== "SobreesdrÃºjulas");
            
            const allCategoriesCompleted = nonFinalCategories.every(cat => playerWords[cat] && playerWords[cat].count >= WORD_DATABASE[cat].limit);
            
            let randomCategory = allCategoriesCompleted ? "SobreesdrÃºjulas" : nonFinalCategories[Math.floor(Math.random() * nonFinalCategories.length)];
            
            let ownedWords = playerWords[randomCategory]?.list || [];
            let availableWords = WORD_DATABASE[randomCategory].words.filter(word => !ownedWords.includes(word));
            
            if (availableWords.length === 0 && !allCategoriesCompleted) { // Retry if a category runs out of words but not all are complete
                setTimeout(() => generateNewWord(true), 50); 
                return;
            } else if (availableWords.length === 0 && allCategoriesCompleted){
                 randomCategory = "SobreesdrÃºjulas";
                 availableWords = WORD_DATABASE[randomCategory].words.filter(word => !ownedWords.includes(word));
            }
            
            let randomWord = availableWords[Math.floor(Math.random() * availableWords.length)];
            let isSuperValue = (WORD_DATABASE[randomCategory].superValueWords || []).includes(randomWord);

            if (isLimboActive && !isSuperValue && (WORD_DATABASE[randomCategory].superValueWords || []).length > 0 && Math.random() < (0.05 + 0.21)) {
                const availableSuperValue = (WORD_DATABASE[randomCategory].superValueWords || []).filter(svw => !ownedWords.includes(svw));
                if (availableSuperValue.length > 0) {
                    randomWord = availableSuperValue[Math.floor(Math.random() * availableSuperValue.length)];
                    isSuperValue = true;
                }
            }
            
            let dynamicValue = WORD_DATABASE[randomCategory].value;
            if (randomCategory !== "SobreesdrÃºjulas") {
                const inflationMultiplier = 1 + (passiveIncome / INFLATION_FACTOR);
                dynamicValue = (WORD_DATABASE[randomCategory].value + (randomWord.length * PRICE_PER_LETTER)) * inflationMultiplier;
                if (isSuperValue) dynamicValue *= SUPER_VALUE_MULTIPLIER;
            }

            if (isLimboActive) {
                dynamicValue *= 0.79;
            }

            currentWord = { word: randomWord, category: randomCategory, value: dynamicValue, isSuperValue, startTime: Date.now() };
            updateUI();
            startWordDisplayTimer(3000); // 3 segundos
        }

        function updateUI() {
            // Player Money and Passive Income
            document.getElementById('playerMoney').textContent = playerMoney.toLocaleString('es');
            recalculatePassiveIncome();
            let finalPassiveIncome = passiveIncome;
            if (Date.now() < christopherBoostEndTime) finalPassiveIncome *= 2;
            if (Date.now() < limboGramaticalEndTime) finalPassiveIncome *= 1.21;
            document.getElementById('passiveIncome').textContent = finalPassiveIncome.toLocaleString('es', { minimumFractionDigits: 1, maximumFractionDigits: 1 });

            // Current Word
            if (currentWord.word) {
                let wordClass = categoryColors[currentWord.category] || "text-gray-500";
                let displayWord = currentWord.word;
                let displayCategory = currentWord.category;
                
                if (currentWord.isBonus) {
                    wordClass = "rainbow-text";
                    displayCategory = "Bonus";
                } else if (currentWord.isHalloween) {
                    wordClass = "halloween-text";
                    displayCategory = "MaldiciÃ³n Halloween";
                } else if (currentWord.isSuperValue) {
                    wordClass = superValueColor;
                }
                
                document.getElementById('currentWord').innerHTML = `<span class="${wordClass}">${displayWord}</span>`;
                document.getElementById('wordCategory').textContent = displayCategory;
                
                const buyButton = document.getElementById('buyButton');
                const canAfford = playerMoney >= currentWord.value;
                let isOwned = false;
                let isCategoryComplete = false;

                if (currentWord.isBonus) {
                    // Bonus words can always be bought and don't belong to a completable category.
                    isOwned = false;
                    isCategoryComplete = false;
                } else if (currentWord.category && playerWords[currentWord.category]) {
                    // For regular and seasonal words
                    const categoryData = playerWords[currentWord.category];
                    const limit = WORD_DATABASE[currentWord.category]?.limit;

                    isCategoryComplete = categoryData && limit && categoryData.count >= limit;

                    if (currentWord.isHalloween) {
                        isOwned = (categoryData.halloweenList || []).includes(currentWord.word);
                    } else {
                        isOwned = (categoryData.list || []).includes(currentWord.word);
                    }
                }

                // Button should be disabled if you can't afford, already own it, or the category is full (unless it's a halloween word)
                const disableForCompletion = isCategoryComplete && !currentWord.isHalloween;
                buyButton.disabled = !canAfford || isOwned || disableForCompletion;
                buyButton.classList.toggle('opacity-50', buyButton.disabled);
                buyButton.classList.toggle('cursor-not-allowed', buyButton.disabled);

                if (isCategoryComplete && !currentWord.isHalloween) {
                    document.getElementById('wordValue').textContent = 'CategorÃ­a Completa';
                } else {
                    document.getElementById('wordValue').textContent = `Costo: ${currentWord.value.toLocaleString('es')}`;
                }
            }

            // Game Controls Bar
            updateShopUI(); // Updates shop button state
            const remainingLives = Math.max(0, 3 - consecutiveFailures);
            const lifeCounter = document.getElementById('lifeCounter');
            lifeCounter.textContent = `${remainingLives}/3`;
            lifeCounter.parentElement.classList.remove('border-green-300', 'border-yellow-400', 'border-red-500');
            if (remainingLives === 3) lifeCounter.parentElement.classList.add('border-green-300');
            else if (remainingLives === 2) lifeCounter.parentElement.classList.add('border-yellow-400');
            else lifeCounter.parentElement.classList.add('border-red-500');
            
            document.getElementById('currentMultiplier').textContent = `${gameMultiplier}x`;
            
            // Timers
            const limboTimer = document.getElementById('limboGramaticalTimerDisplay');
            const chrisTimer = document.getElementById('christopherTimerDisplay');
            const svTimer = document.getElementById('superValueTimerDisplay');
            const now = Date.now();

            // Limpia los potenciadores expirados
            Object.keys(superValueBoosts).forEach(cat => {
                if (now >= superValueBoosts[cat]) {
                    delete superValueBoosts[cat];
                }
            });

            const limboTimeLeft = Math.ceil(Math.max(0, limboGramaticalEndTime - now) / 1000);
            if (limboTimeLeft > 0) {
                limboTimer.classList.remove('hidden');
                const span = limboTimer.querySelector('span');
                span.textContent = `${limboTimeLeft}s`;
                span.dataset.text = `${limboTimeLeft}s`;
            } else {
                limboTimer.classList.add('hidden');
            }
            
            const chrisTimeLeft = Math.ceil(Math.max(0, christopherBoostEndTime - now) / 1000);
            if (chrisTimeLeft > 0) {
                chrisTimer.classList.remove('hidden');
                chrisTimer.querySelector('span').textContent = `${chrisTimeLeft}s`;
            } else {
                chrisTimer.classList.add('hidden');
            }

            // El temporizador global de Super Value muestra el tiempo del que mÃ¡s tarde expira
            const maxSuperValueEndTime = Object.values(superValueBoosts).length > 0 ? Math.max(...Object.values(superValueBoosts)) : 0;
            const svTimeLeft = Math.ceil(Math.max(0, maxSuperValueEndTime - now) / 1000);
             if (svTimeLeft > 0) {
                svTimer.classList.remove('hidden');
                const timerSpan = svTimer.querySelector('span');
                timerSpan.textContent = `${svTimeLeft}s`;
            } else {
                svTimer.classList.add('hidden');
            }


            // Inventory
            const inventoryContainer = document.getElementById('inventoryContainer');
            inventoryContainer.innerHTML = '';
            Object.keys(WORD_DATABASE).forEach(category => {
                const data = playerWords[category] || { count: 0, list: [], halloweenDebuff: 1 };
                const limit = WORD_DATABASE[category].limit;
                const isCompleted = data.count >= limit;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = `relative flex-1 flex-shrink-0 text-center flex flex-col items-center justify-between p-2 cursor-pointer transition duration-300 rounded-lg shadow-md ${isCompleted ? "bg-gray-600 text-gray-400" : categoryBackgrounds[category]} ${categoryColors[category] || 'text-gray-200'}`;
                categoryDiv.onclick = () => {
                    const wordsModal = document.getElementById('wordsModal');
                    document.getElementById('wordsModalTitle').textContent = `Palabras ${category}`;
                    const wordsList = document.getElementById('wordsList');
                    wordsList.innerHTML = '';
                    if (data.list.length > 0) {
                        data.list.forEach((word, index) => {
                            const li = document.createElement('li');
                            li.textContent = `${index + 1}. ${word}`;
                            li.className = "p-1 border-b border-gray-700";
                            wordsList.appendChild(li);
                        });
                    } else {
                        wordsList.innerHTML = `<li class="p-1 italic text-gray-500">AÃºn no tienes palabras aquÃ­.</li>`;
                    }
                    wordsModal.classList.remove('hidden');
                    wordsModal.classList.add('flex');
                };

                let debuffText = '';
                if (data.halloweenDebuff < 1) {
                    const percentage = ((1 - data.halloweenDebuff) * 100).toFixed(1);
                    debuffText = `<span class="font-bold halloween-text ml-2">-${percentage}%</span>`;
                }
                
                const isChrisActive = Date.now() < christopherBoostEndTime;
                const isSuperValueActiveForThisCategory = superValueBoosts[category] && Date.now() < superValueBoosts[category];

                let boostIconsHTML = '<div class="absolute top-0 right-1 flex flex-col items-end">';
                if (isChrisActive && category !== "SobreesdrÃºjulas") {
                    boostIconsHTML += `<span class="rainbow-text font-bold text-xs">x2</span>`;
                }
                if (isSuperValueActiveForThisCategory) {
                    boostIconsHTML += `<span class="${superValueColor} font-bold text-xs">x2</span>`;
                }
                boostIconsHTML += '</div>';

                categoryDiv.innerHTML = `
                    ${boostIconsHTML}
                    <p class="text-sm font-bold">${category}${debuffText}</p>
                    <p class="text-2xl font-extrabold">${data.count}/${limit}</p>
                `;
                inventoryContainer.appendChild(categoryDiv);
            });
        }

        function buyWord() {
            if (playerMoney < currentWord.value) return;
            
            let wordBought = false;

            if (currentWord.isBonus) {
                const now = Date.now();
                const remainingTime = (christopherBoostEndTime > now) ? (christopherBoostEndTime - now) : 0;
                christopherBoostEndTime = now + remainingTime + 60000;
                wordBought = true;
            } else if (currentWord.isSuperValue) {
                const categoryData = playerWords[currentWord.category];
                if (categoryData.count < WORD_DATABASE[currentWord.category].limit && !categoryData.list.includes(currentWord.word)) {
                    playerMoney -= currentWord.value;
                    categoryData.count++;
                    categoryData.list.push(currentWord.word);
                    wordBought = true;
                    
                    const now = Date.now();
                    const category = currentWord.category;
                    const remainingTime = (superValueBoosts[category] > now) ? (superValueBoosts[category] - now) : 0;
                    superValueBoosts[category] = now + remainingTime + 10000;
                }
            } else if (currentWord.isHalloween) {
                playHalloweenSound();
                const categoryData = playerWords[currentWord.category];
                if(categoryData.halloweenWordsCollected < 2 && !categoryData.halloweenList.includes(currentWord.word)) {
                    categoryData.halloweenWordsCollected++;
                    categoryData.halloweenList.push(currentWord.word);
                    categoryData.halloweenDebuff *= 0.985; // Apply 1.5% reduction
                    wordBought = true;
                }
            } else { // Normal Word
                const categoryData = playerWords[currentWord.category];
                if (categoryData.count < WORD_DATABASE[currentWord.category].limit && !categoryData.list.includes(currentWord.word)) {
                    playerMoney -= currentWord.value;
                    categoryData.count++;
                    categoryData.list.push(currentWord.word);
                    wordBought = true;
                }
            }
            
            if (currentWord.category === "SobreesdrÃºjulas" && wordBought) {
                const winMessage = document.getElementById('winMessage');
                winMessage.textContent = `Â¡VICTORIA! Has conseguido una palabra sobreesdrÃºjula. Multiplicador actual: ${gameMultiplier}x.`;
                document.getElementById('nextMultiplier').textContent = gameMultiplier + 1;
                playWinSound();
                changeView('win');
                stopGameLoops();
                stopRulesRotator();
                savePlayerData();
                return;
            }


            if (wordBought) {
                if (!hasBoughtFirstWord) {
                    hasBoughtFirstWord = true;
                }
                                
                document.getElementById('buyButton').disabled = true;
                savePlayerData();
                
                clearTimeout(wordDisplayTimeout);
                const elapsedTime = Date.now() - currentWord.startTime;
                const duration = currentWord.isBonus ? 1000 : 3000;
                const newRemainingTime = Math.max(0, (duration - elapsedTime) - 1000);
                startWordDisplayTimer(newRemainingTime);
                
                updateUI();
            }
        }
        
        function startDictionaryChallenge() {
            stopGameLoops();
            isChallengeActive = true;
            
            const universalShieldActive = Date.now() < universalShieldEndTime;
            if (universalShieldActive) {
                showModal(`Â¡Protegido por el Escudo Universal! Reto evitado.`);
                startGameLoops();
                isChallengeActive = false;
                return;
            }
            if (shields.universal > 0) {
                shields.universal--;
                universalShieldEndTime = Date.now() + 60000;
                savePlayerData();
                showModal("Â¡Escudo Universal activado por 60 segundos! Reto evitado.");
                startGameLoops();
                isChallengeActive = false;
                return;
            }

            const categories = ["Agudas", "Llanas", "EsdrÃºjulas"];
            const challengeCategory = categories[Math.floor(Math.random() * categories.length)];
            
            const modal = document.getElementById('dictionaryModal');
            document.getElementById('challengeCategory').textContent = challengeCategory;
            const timerDisplay = document.getElementById('timer');
            timerDisplay.textContent = 30;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            const input = document.getElementById('challengeInput');
            input.value = '';
            input.focus();
            
            let timeLeft = 30;
            challengeTimerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) endDictionaryChallenge(null, challengeCategory);
            }, 1000);

            input.onkeyup = (event) => {
                if (event.key === 'Enter') endDictionaryChallenge(input.value, challengeCategory);
            };
        }
        
        async function endDictionaryChallenge(word, category) {
            clearInterval(challengeTimerInterval);
            document.getElementById('dictionaryModal').classList.add('hidden');
            isChallengeActive = false;
            gamePausedForFeedback = true;
            stopGameLoops();

            if (!word || !/^[A-ZÃÃ‰ÃÃ“ÃšÃœÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ¼Ã±Â¡!]+$/.test(word.trim())) {
                handleChallengeFailure("Formato de palabra invÃ¡lido. Debe empezar con mayÃºscula y contener solo letras.");
                return;
            }
            word = word.trim();

            if ((usedChallengeWords[category] || []).includes(word.toLowerCase())) {
                handleChallengeFailure("Palabra ya usada en un reto.");
                return;
            }
            
            const { category: detectedCategory, reason } = getAccentCategory(word);

            if (detectedCategory === category) {
                if (!usedChallengeWords[category]) usedChallengeWords[category] = [];
                usedChallengeWords[category].push(word.toLowerCase());
                
                const reward = CHALLENGE_REWARDS[category];
                playerMoney += reward;
                showModal(`Â¡Correcto! ${reason} Ganas ${reward.toLocaleString('es')} ðŸ’°`);
            } else {
                handleChallengeFailure(reason);
            }
        }

        function handleChallengeFailure(reason) {
            consecutiveFailures++;
            if (consecutiveFailures >= 3) {
                document.getElementById('gameOverMessage').textContent = `Fallaste 3 veces. RazÃ³n final: ${reason}`;
                playGameOverSound();
                changeView('gameOver');
                stopGameLoops();
                stopRulesRotator();
            } else {
                resetProgressButKeepLives();
                showModal(`Â¡Fallo! ${reason}. Has perdido todo. Te quedan ${3 - consecutiveFailures} intentos.`);
            }
        }
        
        function savePlayerData() {
            try {
                const data = {
                    money: playerMoney, words: playerWords, used: usedChallengeWords,
                    failures: consecutiveFailures, multiplier: gameMultiplier,
                    credits: initialCredits, shields: shields, shieldEnd: universalShieldEndTime,
                    chrisEnd: christopherBoostEndTime, svBoosts: superValueBoosts,
                    limboTriggered: limboGramaticalTriggeredThisPartida,
                    chrisBonusCount: christopherBonusCountDuringLimbo
                };
                localStorage.setItem('dl_player_data', JSON.stringify(data));
            } catch (e) { console.error('Error saving data:', e); }
        }

        function loadPlayerData() {
            try {
                const raw = localStorage.getItem('dl_player_data');
                if (!raw) return;
                const data = JSON.parse(raw);
                playerMoney = data.money || 100;
                playerWords = data.words || {};
                usedChallengeWords = data.used || {};
                consecutiveFailures = data.failures || 0;
                gameMultiplier = data.multiplier || 1;
                initialCredits = data.credits || 100;
                shields = data.shields || { universal: 0 };
                universalShieldEndTime = data.shieldEnd || 0;
                christopherBoostEndTime = data.chrisEnd || 0;
                superValueBoosts = data.svBoosts || {};
                limboGramaticalTriggeredThisPartida = data.limboTriggered || false;
                christopherBonusCountDuringLimbo = data.chrisBonusCount || 0;

                if (gameMultiplier > 1) applyScalingToWordDatabase(gameMultiplier);
                
                let totalWords = 0;
                Object.keys(WORD_DATABASE).forEach(category => {
                    if (!playerWords[category]) {
                        playerWords[category] = { count: 0, list: [], halloweenDebuff: 1, halloweenWordsCollected: 0, halloweenList: [] };
                    } else if (!playerWords[category].halloweenList) {
                        playerWords[category].halloweenList = []; // Compatibilidad con guardados antiguos
                    }
                    totalWords += playerWords[category].count || 0;
                });
                hasBoughtFirstWord = totalWords > 0;

            } catch (e) { console.error('Error loading data:', e); }
        }
        
        function gameLoop() {
            let incomeThisSecond = passiveIncome;
            if (Date.now() < christopherBoostEndTime) {
                incomeThisSecond *= 2;
            }
            if(Date.now() < limboGramaticalEndTime) {
                incomeThisSecond *= 1.21;
            }

            playerMoney += incomeThisSecond;
            updateUI();
        }
        
        function updateTimerBarUI() {
            if (!gameStarted || currentView !== 'game' || !currentWord.startTime) {
                return;
            }
            const bar = document.getElementById('wordTimerBar');
            if (!bar) return;

            const now = Date.now();
            const duration = currentWord.isBonus ? 1000 : 3000;
            const elapsedTime = now - currentWord.startTime;
            const timeLeft = Math.max(0, duration - elapsedTime);
            const percentage = (timeLeft / duration) * 100;
            
            bar.style.width = `${percentage}%`;

            if (timeLeft > (duration * 2/3)) bar.style.backgroundColor = '#ef4444'; // red-500
            else if (timeLeft > (duration * 1/3)) bar.style.backgroundColor = '#eab308'; // yellow-500
            else bar.style.backgroundColor = '#22c55e'; // green-500
        }

        const accentuationRules = [
            { title: "MonosÃ­labos", text: "Por regla general, no llevan tilde, salvo en casos de tilde diacrÃ­tica.", color: categoryColors.MonosÃ­labos},
            { title: "Palabras Agudas", text: "Llevan tilde cuando terminan en 'n', 's' o vocal. La sÃ­laba tÃ³nica es la Ãºltima.", color: categoryColors.Agudas },
            { title: "Palabras Llanas (o Graves)", text: "Llevan tilde cuando NO terminan en 'n', 's' o vocal. La sÃ­laba tÃ³nica es la penÃºltima.", color: categoryColors.Llanas },
            { title: "Palabras EsdrÃºjulas", text: "Siempre llevan tilde. La sÃ­laba tÃ³nica es la antepenÃºltima.", color: categoryColors.EsdrÃºjulas },
            { title: "Palabras SobreesdrÃºjulas", text: "Siempre llevan tilde. La sÃ­laba tÃ³nica es anterior a la antepenÃºltima.", color: categoryColors.SobreesdrÃºjulas }
        ];
        let currentRuleIndex = 0;
        let rulesInterval = null;

        function startRulesRotator() {
            stopRulesRotator(); 
            const rulesContainer = document.getElementById('rulesContainer');
            const rulesDisplay = document.getElementById('rulesDisplay');
            if (!rulesContainer || !rulesDisplay) return;

            rulesContainer.classList.remove('hidden');

            const updateRule = () => {
                rulesDisplay.style.opacity = 0;
                setTimeout(() => {
                    const rule = accentuationRules[currentRuleIndex];
                    rulesDisplay.innerHTML = `<h3 class="text-lg font-bold ${rule.color}">${rule.title}</h3><p class="text-gray-300">${rule.text}</p>`;
                    rulesDisplay.style.opacity = 1;
                    currentRuleIndex = (currentRuleIndex + 1) % accentuationRules.length;
                }, 500); 
            };
            
            updateRule(); 
            rulesInterval = setInterval(updateRule, 15000);
        }

        function stopRulesRotator() {
            if (rulesInterval) {
                clearInterval(rulesInterval);
                rulesInterval = null;
            }
            const rulesContainer = document.getElementById('rulesContainer');
            if(rulesContainer) rulesContainer.classList.add('hidden');
        }

        function startGameLoops() {
            if (gameLoopInterval) return; // Prevent multiple loops
            stopGameLoops();
            startRulesRotator();
            gameLoopInterval = setInterval(gameLoop, 1000);
            uiUpdateInterval = setInterval(updateTimerBarUI, 50);
            challengeInterval = setInterval(() => {
                if (hasBoughtFirstWord && Math.random() < 0.15 && !isChallengeActive && gameStarted) {
                    startDictionaryChallenge();
                }
            }, 5000);
        }

        function stopGameLoops() {
            clearInterval(gameLoopInterval);
            clearInterval(uiUpdateInterval);
            clearInterval(challengeInterval);
            clearTimeout(wordDisplayTimeout);
            gameLoopInterval = null;
            uiUpdateInterval = null;
            challengeInterval = null;
        }
        
        async function startGameCommon(shouldLoad = true) {
            if (shouldLoad) {
                loadPlayerData();
            }
            // Limbo Gramatical is now triggered inside generateNewWord
            startGameLoops();
            generateNewWord(true);
            setInterval(savePlayerData, 30000);
        }
        
        // Definitive Syllabification Engine
        function syllabify(word) {
            let cleanedWord = word.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            const patterns = [
                // Four consonants
                { regex: /([bcdfghjklmnpqrstvwxyz])([bcdfghjklmnpqrstvwxyz])(l|r)([^aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼]|$)/, split: 2 }, 
                // Three consonants
                { regex: /([bcdfghjklmnpqrstvwxyz])(p|t|c|b|d|g|f)(l|r)/, split: 1 }, 
                // Two consonants
                { regex: /[aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼]([bcdfghjklmnpqrstvwxyz])\1[aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼]/, split: 1 }, 
                { regex: /[aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼]([bcdfghjklmnpqrstvwxyz][^aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼lr])[aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼]/, split: 1 }, 
                 // Hiatus
                { regex: /([aeoÃ¡Ã©Ã³])([aeoÃ¡Ã©Ã³])/, split: 1 },
                { regex: /([aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼])([Ã­Ãº])/, split: 1 },
                { regex: /([Ã­Ãº])([aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼])/, split: 1 },
            ];

            let str = cleanedWord;
            patterns.forEach(pattern => {
                let match = str.match(pattern.regex);
                if (match) {
                    let index = match.index + pattern.split;
                    str = str.slice(0, index) + '-' + str.slice(index);
                }
            });

            // Final split by vowel groups
            let syllables = str.match(/[^aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼]*[aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼]+(?:[^aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼](?![aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼lr]))?/gi);

            if (!syllables) return [word];

            // Re-apply original casing
            let originalIndex = 0;
            return syllables.map(syll => {
                const originalPart = word.substring(originalIndex, originalIndex + syll.length);
                originalIndex += syll.length;
                return originalPart;
            });
        }


        function getAccentCategory(word) {
            const originalWord = word;
            const cleanedWord = word.toLowerCase().trim();
            const syllables = syllabify(originalWord);
            const numSyllables = syllables.length;

            if (numSyllables <= 1) {
                return { category: "MonosÃ­labos", reason: `La palabra '${originalWord}' es un monosÃ­labo.` };
            }

            let stressedSyllableIndex = -1;
            const accentedVowels = "Ã¡Ã©Ã­Ã³Ãº";
            
            for (let i = 0; i < numSyllables; i++) {
                if (syllables[i].split('').some(char => accentedVowels.includes(char.toLowerCase()))) {
                    stressedSyllableIndex = i;
                    break;
                }
            }

            let category = "Desconocida";
            
            if (stressedSyllableIndex !== -1) { // Rule for words WITH tilde
                const positionFromEnd = numSyllables - 1 - stressedSyllableIndex;
                if (positionFromEnd === 0) category = "Agudas";
                else if (positionFromEnd === 1) category = "Llanas";
                else if (positionFromEnd === 2) category = "EsdrÃºjulas";
                else if (positionFromEnd >= 3) category = "SobreesdrÃºjulas";
            } else { // Rule for words WITHOUT tilde
                const lastChar = cleanedWord.slice(-1);
                if ('ns'.includes(lastChar) || 'aeiou'.includes(lastChar)) {
                    stressedSyllableIndex = numSyllables - 2;
                    category = "Llanas";
                } else {
                    stressedSyllableIndex = numSyllables - 1;
                    category = "Agudas";
                }
            }
            
            const positionText = ['Ãºltima', 'penÃºltima', 'antepenÃºltima'][numSyllables - 1 - stressedSyllableIndex] || 'anterior a la antepenÃºltima';
            const stressedSyllableText = `'${syllables[stressedSyllableIndex]}'`;
            let reason = `'${originalWord}' es ${category} porque su sÃ­laba tÃ³nica es la ${positionText} (${stressedSyllableText}). `;
            
            switch (category) {
                case "Agudas":
                    if (cleanedWord.split('').some(char => accentedVowels.includes(char))) {
                        reason += "Lleva tilde porque las palabras agudas la llevan cuando terminan en 'n', 's' o vocal.";
                    } else {
                        reason += `No lleva tilde porque las palabras agudas solo la llevan si terminan en 'n', 's' o vocal.`;
                    }
                    break;
                case "Llanas":
                     if (cleanedWord.split('').some(char => accentedVowels.includes(char))) {
                        reason += `Lleva tilde porque las palabras llanas la llevan cuando NO terminan en 'n', 's' o vocal.`;
                    } else {
                        reason += `No lleva tilde porque las palabras llanas solo la llevan si NO terminan en 'n', 's' o vocal.`;
                    }
                    break;
                case "EsdrÃºjulas":
                case "SobreesdrÃºjulas":
                     reason += `Las palabras ${category.toLowerCase()}s siempre llevan tilde.`;
                     break;
            }

            return { category, reason };
        }

        function updateContinueButtonState() {
            const continueBtn = document.getElementById('continueGameButton');
            const hasSaveData = localStorage.getItem('dl_player_data');

            if (hasSaveData) {
                const data = JSON.parse(hasSaveData);
                const hasProgress = Object.values(data.words).some(cat => cat.count > 0);
                if (hasProgress) {
                    continueBtn.disabled = false;
                    continueBtn.classList.add('hover:bg-green-700', 'hover:bg-purple-800');
                    continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    return;
                }
            }
            
            continueBtn.disabled = true;
            continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
            continueBtn.classList.remove('hover:bg-green-700', 'hover:bg-purple-800');
        }

        function setupEventListeners() {
            const initAudio = () => {
                if (!audioCtx) {
                    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
                    catch(e) { console.error("Could not create AudioContext", e); }
                }
            };
            document.getElementById('newGameButton').addEventListener('click', () => { initAudio(); startNewGame(); });
            document.getElementById('continueGameButton').addEventListener('click', () => { initAudio(); continueGame(); });
            document.getElementById('tutorialButton').addEventListener('click', () => changeView('tutorial'));
            document.getElementById('buyButton').addEventListener('click', buyWord);
            document.getElementById('shopButton').addEventListener('click', () => changeView('shop'));
            document.getElementById('homeButton').addEventListener('click', () => {
                stopGameLoops();
                stopRulesRotator();
                savePlayerData();
                updateContinueButtonState();
                changeView('startup');
            });
            document.getElementById('backToGameFromTutorial').addEventListener('click', () => changeView('startup'));
            document.getElementById('backToGameFromShop').addEventListener('click', () => changeView('game'));
            document.getElementById('buyUniversalShield').addEventListener('click', () => buyShield('universal'));
            document.getElementById('buyLifeButton').addEventListener('click', buyLife);
            document.getElementById('buyAguaBenditaButton').addEventListener('click', buyAguaBendita);
            document.getElementById('modalCloseButton').addEventListener('click', () => {
                document.getElementById('messageModal').classList.add('hidden');
                if (gamePausedForFeedback) {
                    gamePausedForFeedback = false;
                    if (consecutiveFailures < 3) {
                       startGameLoops();
                       generateNewWord(true);
                       savePlayerData();
                    }
                }
            });
            document.getElementById('wordsModalCloseButton').addEventListener('click', () => document.getElementById('wordsModal').classList.add('hidden'));
            document.getElementById('backToGameFromGameOver').addEventListener('click', () => {
                reiniciarJuegoCompleto();
                changeView('game');
                startGameCommon();
            });
            document.getElementById('seguirJugandoButton').addEventListener('click', formatearJuego);
            document.getElementById('reiniciarButton').addEventListener('click', () => {
                reiniciarJuegoCompleto();
                changeView('game');
                startGameCommon();
            });
            document.getElementById('closeHalloweenNotice').addEventListener('click', () => {
                document.getElementById('halloweenNoticeScreen').classList.add('hidden');
                if (typeof actionAfterNotice === 'function') {
                    actionAfterNotice();
                    actionAfterNotice = null; // Reset for next time
                }
            });
            document.getElementById('startLimboGramatical').addEventListener('click', () => {
                const modal = document.getElementById('limboGramaticalScreen');
                modal.classList.add('hidden');
                modal.classList.remove('flex');

                limboGramaticalEndTime = Date.now() + 60000;
                startGameLoops(); 
                generateNewWord(true);
            });
        }

        async function initGame() {
            updateContinueButtonState();
            changeView('startup');
            setupEventListeners();
        }
        
        window.onload = initGame;
    </script>
</body>
</html>

