<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Reto del Diccionario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fondo gris claro */
            color: #1f2937;
        }
        .card {
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .rainbow-text {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: rainbow 2s ease-in-out infinite;
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .super-value-text {
            color: #ef4444; /* Rojo intenso */
            font-weight: bold;
        }
        #startupScreen, .modal-bg {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .rainbow-border {
            border: 4px solid;
            border-image-slice: 1;
            border-image-source: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            animation: rainbow-border-animation 2s linear infinite;
        }
        @keyframes rainbow-border-animation {
            0% { border-image-source: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3); }
            50% { border-image-source: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3); }
            100% { border-image-source: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3); }
        }

        .glitch-wrapper {
            position: relative;
        }

        .glitch-text::before,
        .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f3f4f6; 
            overflow: hidden;
            clip-path: inset(50% 50% 50% 50%);
        }

        .glitch-text::before {
            left: -2px;
            text-shadow: 2px 0 blue;
            animation: glitch-anim-2 1.5s infinite linear alternate-reverse;
        }

        .glitch-text::after {
            left: 2px;
            text-shadow: -2px 0 red;
            animation: glitch-anim-1 2s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim-1 {
            0%, 100% { clip-path: inset(40% 0 61% 0); }
            25% { clip-path: inset(15% 0 75% 0); }
            50% { clip-path: inset(50% 0 45% 0); }
            75% { clip-path: inset(5% 0 85% 0); }
        }
        @keyframes glitch-anim-2 {
            0%, 100% { clip-path: inset(65% 0 30% 0); }
            25% { clip-path: inset(80% 0 15% 0); }
            50% { clip-path: inset(40% 0 50% 0); }
            75% { clip-path: inset(90% 0 5% 0); }
        }

        .flicker-anim {
            animation: flicker-animation 1s infinite;
        }

        @keyframes flicker-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .prestige-glow {
            box-shadow: 0 0 8px 2px rgba(251, 191, 36, 0.7); /* Amarillo-dorado para el brillo */
        }
        
        .luck-glow {
             box-shadow: 0 0 10px 3px rgba(34, 197, 94, 0.6); /* Verde para la suerte */
             animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 10px 3px rgba(34, 197, 94, 0.6); }
            50% { box-shadow: 0 0 14px 5px rgba(34, 197, 94, 0.8); }
            100% { box-shadow: 0 0 10px 3px rgba(34, 197, 94, 0.6); }
        }

        .shield-glow {
            box-shadow: 0 0 12px 4px rgba(79, 70, 229, 0.7); /* Indigo */
            animation: pulse-indigo 2s infinite;
        }
        @keyframes pulse-indigo {
            50% { box-shadow: 0 0 16px 6px rgba(79, 70, 229, 0.9); }
        }

        .limbo-glow {
            box-shadow: 0 0 12px 4px rgba(139, 92, 246, 0.7); /* Purple */
            animation: pulse-purple 2s infinite;
        }
        @keyframes pulse-purple {
            50% { box-shadow: 0 0 16px 6px rgba(139, 92, 246, 0.9); }
        }

        .boss-modal-bg {
            background-color: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(8px);
        }

        .christopher-modal-bg {
            background-color: rgba(224, 231, 255, 0.9);
            backdrop-filter: blur(8px);
        }

        .whisper-text {
            font-size: 1.5rem; /* Increased size */
            font-weight: 900; /* Bolder */
            color: #111827; /* Darker gray */
            animation: flicker-dark 2s infinite;
            text-align: center;
        }
        
        @keyframes flicker-dark {
            0%, 100% {
                text-shadow: 0 0 5px rgba(220, 38, 38, 0.4), 0 0 2px rgba(0,0,0,0.5);
                opacity: 0.8;
            }
            50% {
                text-shadow: 0 0 15px rgba(220, 38, 38, 0.8), 0 0 5px rgba(0,0,0,0.7);
                opacity: 1;
            }
        }

        .corrupted-text-effect {
            animation: flicker-dark 2s infinite;
            font-weight: bold;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f59e0b;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .bg-gradient-bronze { background-image: linear-gradient(to top right, #f3e9d2, #c6a49a); }
        .bg-gradient-plata { background-image: linear-gradient(to top right, #e0e0e0, #bdbdbd); }
        .bg-gradient-oro { background-image: linear-gradient(to top right, #fff176, #ffd54f); }
        .bg-gradient-platino { background-image: linear-gradient(to top right, #e0f7fa, #b2ebf2); }
        .bg-gradient-diamante { background-image: linear-gradient(to top right, #e1f5fe, #81d4fa); }
        .bg-gradient-maestro { background-image: linear-gradient(to top right, #f3e5f5, #e1bee7); }
        .bg-gradient-leyenda { background-image: linear-gradient(to top right, #ffebee, #ffcdd2); }

    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal min-h-screen">
    <!-- Pantalla de Inicio -->
    <div id="startupScreen" class="fixed inset-0 modal-bg flex flex-col items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="text-center w-full max-w-4xl mx-auto">
            <h1 class="text-4xl sm:text-6xl font-black text-blue-900 mb-8">EL RETO DEL DICCIONARIO</h1>

            <!-- Vista para usuarios NO logueados -->
            <div id="loginView" class="flex flex-col items-center gap-4">
                <div id="registerSection">
                    <div class="w-full max-w-sm">
                        <input type="text" id="playerNameInput" placeholder="Escribe tu nombre para empezar" class="w-full text-center p-3 text-lg font-semibold border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-gray-800 mb-2">
                        <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-150 transform hover:scale-105 text-lg sm:text-xl">
                            Empezar Aventura
                        </button>
                    </div>
                    <p class="mt-4 text-sm">
                        <a href="#" id="showLoginWithId" class="text-blue-600 hover:underline">¿Ya tienes una cuenta? Inicia sesión con tu ID.</a>
                    </p>
                </div>

                <div id="loginWithIdSection" class="hidden">
                    <div class="w-full max-w-sm">
                        <input type="text" id="playerIDInput" placeholder="Pega tu ID de Jugador" class="w-full text-center p-3 text-lg font-semibold border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-gray-800 mb-2">
                        <button id="loginWithIdButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-150 transform hover:scale-105 text-lg sm:text-xl">
                            Cargar Partida
                        </button>
                    </div>
                    <p class="mt-4 text-sm">
                        <a href="#" id="showRegister" class="text-blue-600 hover:underline">¿Eres nuevo? Crea una cuenta.</a>
                    </p>
                </div>
            </div>

            <!-- Vista para usuarios SÍ logueados -->
            <div id="loggedInView" class="hidden flex flex-col items-center gap-4">
                 <p class="text-2xl font-bold text-gray-700 mb-2">Bienvenido, <span id="playerNameDisplay" class="text-blue-700"></span></p>
                <div class="flex flex-col sm:flex-row justify-center items-stretch gap-4 w-full max-w-2xl">
                    <button id="playGameButton" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-150 transform hover:scale-105 text-lg sm:text-xl">
                        JUGAR
                    </button>
                    <button id="tutorialButton" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg transition duration-150 transform hover:scale-105 text-lg sm:text-xl">
                        Tutorial
                    </button>
                </div>
                <!-- Div contenedor de botones dentro de loggedInView -->
                <div class="flex flex-col sm:flex-row justify-center items-stretch gap-4 w-full max-w-md">
                    <button id="profileButton" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg transition">Ver mi Perfil</button>
                    <!-- Inserta este botón aquí -->
                    <button id="rankingButton" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg transition">Ranking</button>
                </div>
                 <div class="flex gap-4 mt-4">
                    <!-- Botón de Administrador para eliminar jugadores -->
                    <button id="adminDeleteButton" class="hidden text-sm text-red-600 hover:text-red-800 hover:underline font-bold">Eliminar Jugador del Ranking</button>
                </div>
            </div>

        </div>
        <p class="absolute bottom-4 text-xs text-gray-400 text-center">© 2025 El Reto del Diccionario | Desarrollado por Didac-Click Group.</p>
    </div>
    
    <!-- Tutorial Modal -->
    <div id="tutorialScreen" class="fixed inset-0 modal-bg hidden flex items-center justify-center p-4 z-[100]">
        <div class="w-full max-w-3xl bg-white p-6 rounded-xl shadow-2xl max-h-[90vh] hide-scrollbar overflow-y-auto border-4 border-blue-300">
            <div id="integratedTutorial" class="text-left text-gray-800">
                <h2 class="text-2xl font-extrabold text-blue-800 mb-3 text-center">Guía Rápida</h2>
                <ol class="list-decimal pl-5 space-y-4 text-gray-700">
                    <li>
                        <span class="font-bold">Objetivo:</span> Compra palabras para ganar dinero y colecciona 30 de cada tipo para desbloquear la <span class="font-bold text-purple-700">Sobreesdrújula</span> y ganar la partida.
                    </li>
                    <li>
                        <span class="font-bold">El Ladrón de Tildes:</span> Es un enemigo impredecible.
                        <ul class="list-disc pl-5 mt-2 text-sm space-y-1">
                            <li><span class="font-semibold text-red-600">Ataques Sorpresa:</span> Puede robarte dinero, palabras o incluso una vida. A veces, te confundirá llenando el juego de palabras corruptas.</li>
                             <li><span class="font-semibold text-red-600">Mini-Retos:</span> Ocasionalmente, te someterá a pruebas rápidas de ortografía. Si fallas 3 veces, la partida se reinicia (pero conservas el prestigio).</li>
                             <li><span class="font-semibold text-red-600">El Trato:</span> Si te queda una sola vida, podría ofrecerte un trato para recuperarla... a un alto precio.</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-bold">Bonus y Ayuda:</span> Aprovecha las palabras <span class="super-value-text font-bold">rojas</span> y el bonus <span class="rainbow-text font-bold">CHRISTOPHER</span>. A veces, si te opones al Ladrón, un <span class="rainbow-text font-bold">LIMBO GRAMATICAL</span> podría abrirse para ayudarte.
                    </li>
                     <li>
                        <span class="font-bold">Prestigio:</span> Al ganar, puedes <span class="font-bold text-yellow-600">Formatear</span> para aumentar tu multiplicador de ganancias y obtener <span class="font-bold text-yellow-700">Puntos de Prestigio</span> para mejoras permanentes.
                    </li>
                </ol>
            </div>
             <div class="text-center w-full">
                <button id="backToGameFromTutorial" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition duration-150 transform hover:scale-105 mt-6">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Ranking Modal -->
    <div id="rankingScreen" class="fixed inset-0 modal-bg hidden flex items-center justify-center p-4 z-[100]">
        <div class="w-full max-w-md bg-white p-6 rounded-xl shadow-2xl max-h-[90vh] border-4 border-yellow-400 flex flex-col">
            <h2 class="text-3xl font-extrabold text-yellow-800 mb-4 text-center flex-shrink-0">Clasificación Global</h2>
            <div id="rankingList" class="flex-grow overflow-y-auto hide-scrollbar space-y-2">
                <!-- El contenido se generará con JavaScript -->
            </div>
            <div class="text-center w-full mt-6 flex-shrink-0">
                <button id="backToHomeFromRanking" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full transition duration-150 transform hover:scale-105">
                    Cerrar
                </button>
            </div>
        </div>
    </div>


    <!-- Modal for Player Profile -->
    <div id="profileScreen" class="fixed inset-0 modal-bg hidden items-center justify-center p-4 z-[100]">
        <div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-2xl max-h-[90vh] hide-scrollbar overflow-y-auto border-4 border-indigo-400">
            <div id="profileContent">
                <!-- Loading state -->
                <div id="profileLoading" class="flex justify-center items-center p-8">
                    <div class="loading-spinner"></div>
                </div>

                <!-- Loaded state -->
                <div id="profileData" class="hidden">
                     <div id="profileCard" class="rounded-lg p-4 mb-6 transition-colors duration-200 shadow-lg">
                        <div class="flex items-center justify-center gap-2">
                             <h3 id="profilePlayerName" class="text-2xl font-bold text-gray-800"></h3>
                             <button id="editPlayerNameButton" class="p-1 rounded-full hover:bg-black/10 transition">
                                 <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                             </button>
                         </div>
                         <p id="profileLeague" class="text-lg font-bold"></p>
                         <p class="text-sm text-gray-700 mt-1">Multiplicador: <span id="profileMultiplier" class="font-bold"></span> | Ranking: <span id="profileRank" class="font-bold">#---</span></p>
                     </div>
                     
                     <div class="mb-6 p-3 bg-gray-100 rounded-lg">
                        <p class="text-xs font-bold text-gray-500 mb-1">Tu ID de Jugador:</p>
                        <div class="flex items-center justify-center gap-2">
                            <input id="playerIDCopyInput" type="text" class="text-center bg-gray-200 text-gray-700 font-mono text-xs p-1 rounded w-full" readonly>
                            <button id="copyPlayerIDButton" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full">Copiar</button>
                        </div>
                    </div>

                     <div class="border-t border-gray-200 pt-4 space-y-3 flex flex-col items-center">
                         <button id="profileResetProgressButton" class="bg-red-100 text-red-700 font-semibold py-2 px-5 rounded-lg hover:bg-red-200 transition text-sm w-full max-w-xs">Reiniciar Progreso</button>
                         <button id="profileLogoutButton" class="bg-gray-100 text-gray-700 font-semibold py-2 px-5 rounded-lg hover:bg-gray-200 transition text-sm w-full max-w-xs">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-6">
                <button id="backToHomeFromProfile" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition duration-150 transform hover:scale-105">
                    Cerrar
                </button>
            </div>
        </div>
    </div>


    <!-- Game Container -->
    <div class="container mx-auto p-2 flex flex-col items-center min-h-screen">
        <div id="gameScreen" class="flex flex-col items-center w-full">
            <div class="flex flex-col lg:flex-row justify-center items-stretch w-full gap-4">
                
                <div id="playerMoneyCard" class="flex flex-col items-center justify-center flex-1 text-center border p-4 rounded-xl shadow-lg card transition-shadow duration-200">
                    <h2 class="text-xl font-bold text-green-700">Tu Riqueza</h2>
                    <p id="playerMoney" class="text-2xl sm:text-3xl font-extrabold text-green-800 mt-2">0</p>
                    <p class="text-sm text-gray-500 mt-1">
                        Ingreso Pasivo: <span id="passiveIncome" class="font-bold">0.0</span>/seg
                        <span id="prestigeIncomeBonus" class="hidden text-yellow-500 font-bold text-xs ml-1"></span>
                    </p>
                </div>

                <div id="currentWordCard" class="flex flex-col items-center flex-1 text-center border p-4 rounded-xl shadow-lg card transition-shadow duration-200">
                    <h3 class="text-xl font-bold mb-2">Palabra Actual</h3>
                    <p id="currentWord" class="text-3xl sm:text-5xl font-black mb-1">Cargando...</p>
                    <p id="wordCategory" class="text-md font-semibold text-gray-500 mb-1"></p>
                    <p id="wordValue" class="text-md font-extrabold text-blue-700"></p>
                    <div class="flex justify-center space-x-2 mt-2">
                        <button id="buyButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition duration-150 transform hover:scale-105 text-sm">
                            Comprar
                        </button>
                    </div>
                    <div id="wordTimerBarContainer" class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div id="wordTimerBar" class="h-2.5 rounded-full" style="width: 100%; transition: width 0.05s linear, background-color: 0.5s ease;"></div>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap lg:flex-nowrap w-full gap-4 mt-4 text-center border p-4 rounded-xl shadow-lg card">
                <div class="w-full">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Tu Colección de Palabras</h2>
                    <div id="inventoryContainer" class="flex flex-row overflow-x-auto whitespace-nowrap space-x-2 p-2">
                    </div>
                </div>
            </div>
            
            <div id="rulesContainer" class="w-full mt-4 text-center border p-4 rounded-xl shadow-lg hidden flex flex-col justify-center min-h-[110px] card">
                <div id="rulesDisplay" class="transition-opacity duration-200 ease-in-out">
                    <!-- Rules will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de estado y botones del juego -->
    <div id="gameControls" class="fixed bottom-0 left-0 right-0 w-full flex flex-wrap justify-center items-center gap-2 p-3 bg-white border-t-2 border-gray-200 z-10">
        <div id="lifeCounterContainer" class="bg-white p-2 px-4 rounded-full shadow-lg border-2 border-gray-200 text-black font-extrabold text-lg flex-shrink-0 w-24 text-center transition-shadow duration-200">
            <span id="lifeCounter">3/3</span>
        </div>
        <button id="prestigeButton" class="bg-white p-2 px-4 rounded-full shadow-lg border-2 border-gray-200 text-black font-extrabold text-lg transition duration-150 transform hover:scale-105 w-24 text-center">
            <span id="currentMultiplier">1x</span>
        </button>
        <button id="shopButton" class="bg-white hover:bg-gray-100 p-2 px-4 rounded-full shadow-lg border-2 border-gray-200 text-black font-extrabold text-lg transition-shadow duration-200 transform hover:scale-105 w-24 text-center">
            Tienda
        </button>
        <button id="homeButton" class="bg-white hover:bg-gray-100 p-2 px-4 rounded-full shadow-lg border-2 border-gray-200 text-black font-extrabold text-lg transition duration-150 transform hover:scale-105 w-24 text-center">
            Inicio
        </button>
    </div>

    <!-- Modal for Shop -->
    <div id="shopScreen" class="fixed inset-0 modal-bg hidden items-center justify-center p-4 z-[100]">
        <div class="w-full max-w-lg bg-white p-6 rounded-2xl shadow-2xl max-h-[90vh] hide-scrollbar overflow-y-auto border-4 border-indigo-300">
            <div class="flex items-center justify-center mb-6">
                <svg class="w-8 h-8 text-indigo-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <h2 class="text-3xl font-black text-indigo-800">Tienda</h2>
            </div>
            <ul class="space-y-3">
                <!-- Item: Comprar Vida -->
                <li class="bg-gray-50 p-3 rounded-lg flex items-center justify-between transition duration-200 hover:bg-gray-100">
                    <div>
                        <h3 class="font-bold text-gray-800">Comprar Vida</h3>
                        <p class="text-xs text-gray-600">Recupera una vida perdida.</p>
                    </div>
                    <div class="flex-shrink-0 ml-4">
                        <button id="buyLifeButton" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-1 px-4 text-sm rounded-full transition duration-150 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            {precio}
                        </button>
                    </div>
                </li>
                <!-- Item: Escudo Universal -->
                <li class="bg-gray-50 p-3 rounded-lg flex items-center justify-between transition duration-200 hover:bg-gray-100">
                    <div>
                        <h3 class="font-bold text-gray-800">Escudo Universal</h3>
                        <p class="text-xs text-gray-600">Protege de retos por 60s. (Tienes: <span id="universalCount">0</span>)</p>
                    </div>
                    <div class="flex-shrink-0 ml-4">
                        <button id="buyUniversalShield" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-4 text-sm rounded-full transition duration-150 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            {precio}
                        </button>
                    </div>
                </li>
            </ul>
            <div class="text-center mt-6">
                <button id="backToGameFromShop" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition duration-150 transform hover:scale-105">
                    Cerrar Tienda
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Messages -->
    <div id="messageModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4 z-[250]">
        <div class="bg-white p-6 max-w-sm w-full text-center rounded-xl shadow-lg border border-blue-300">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="modalCloseButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal for Confirmation -->
    <div id="confirmationModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4 z-[260]">
        <div class="bg-white p-6 max-w-sm w-full text-center rounded-xl shadow-lg border border-yellow-400">
            <p id="confirmationMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div class="flex justify-center gap-4">
                <button id="confirmYesButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full">Sí</button>
                <button id="confirmNoButton" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full">No</button>
            </div>
        </div>
    </div>

    <!-- Modal for Word List -->
    <div id="wordsModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4 z-[200]">
        <div class="bg-white p-6 max-w-sm w-full text-center rounded-xl shadow-lg border border-gray-300">
            <h3 id="wordsModalTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <ul id="wordsList" class="max-h-64 overflow-y-auto text-left mb-4 px-2">
            </ul>
            <button id="wordsModalCloseButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Cerrar</button>
        </div>
    </div>

    <!-- Modal for Mini-Challenge -->
    <div id="thiefMiniChallengeModal" class="fixed inset-0 boss-modal-bg hidden justify-center items-center p-4 z-[200]">
        <div class="bg-gray-800 p-8 max-w-md w-full text-center rounded-xl shadow-2xl border-4 border-red-500 text-white">
            <div id="thiefMiniChallengeIcon" class="w-12 h-12 mx-auto mb-3 text-red-500"></div>
            <h3 class="text-3xl font-extrabold text-red-500 mb-2">¡MINI-RETO!</h3>
            <p id="challengeDescription" class="text-md text-gray-300 mb-4"></p>
            <p id="challengeQuestion" class="text-4xl font-black mb-4 font-mono"></p>
            <p class="text-sm font-bold text-gray-400">Tiempo restante: <span id="challengeTimer" class="text-red-500">30</span>s</p>
            
            <div id="challengeInputContainer">
                 <input id="challengeInput" type="text" class="w-full mt-4 p-3 text-center text-lg font-semibold border-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:border-red-500 text-white">
            </div>

            <div id="challengeButtonsContainer" class="hidden justify-center gap-4 mt-4">
                <button id="trueButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Verdadero</button>
                <button id="falseButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Falso</button>
            </div>
        </div>
    </div>

    <!-- Modal for Online Verification -->
    <div id="loadingModal" class="fixed inset-0 modal-bg hidden justify-center items-center p-4 z-[300]">
        <div class="bg-white p-6 max-w-sm w-full text-center rounded-xl shadow-lg flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold text-gray-800 mt-4">Verificando en línea...</p>
        </div>
    </div>
    
    <!-- Modal for Boss Challenge -->
    <div id="bossModal" class="fixed inset-0 boss-modal-bg flex justify-center items-center p-4 z-[200] hidden opacity-0 transition-opacity duration-200">
        <div id="bossModalContent" class="bg-gray-800 text-white p-8 max-w-2xl w-full text-center rounded-xl shadow-2xl border-4 border-red-700 transform transition-all duration-150 scale-95 opacity-0">
            <div id="bossIconContainer" class="w-16 h-16 mx-auto mb-4 text-red-500"></div>
            <h3 class="text-3xl font-extrabold text-red-500 mb-2">EL LADRÓN DE TILDES</h3>
            <p id="bossDialogue" class="text-md text-gray-300 mb-4 h-10"></p>
            <div id="bossChallengeContent" class="hidden">
                <p class="text-md text-gray-400 mb-2">Reescribe la oración con las tildes correctas:</p>
                <p id="bossChallengeSentence" class="text-2xl font-mono bg-gray-900 p-3 rounded-lg mb-4"></p>
                <p class="text-sm font-bold text-gray-400">Tiempo restante: <span id="bossTimer" class="text-red-500">60</span>s</p>
                <input id="bossChallengeInput" type="text" class="w-full mt-4 p-3 text-center text-lg font-semibold border-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:border-red-500 text-white">
            </div>
        </div>
    </div>
    
    <!-- Modal de Susurro/Burla del Ladrón -->
    <div id="thiefWhisperModal" class="fixed inset-0 boss-modal-bg flex justify-center items-center p-4 z-[250] hidden opacity-0 transition-opacity duration-200">
        <div class="bg-gray-800 text-white p-8 max-w-md w-full text-center rounded-xl shadow-2xl border-2 border-red-700">
             <div id="thiefWhisperIcon" class="w-12 h-12 mx-auto mb-3 text-red-500"></div>
            <p id="thiefWhisperDialogue" class="text-gray-300 text-lg mb-4 italic h-10"></p>
            <button id="thiefWhisperCloseButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Continuar</button>
        </div>
    </div>

    <!-- Modal for Random Thief Attack -->
    <div id="randomThiefAttackModal" class="fixed inset-0 boss-modal-bg flex justify-center items-center p-4 z-[250] hidden opacity-0 transition-opacity duration-200">
        <div class="bg-gray-800 text-white p-8 max-w-md w-full text-center rounded-xl shadow-2xl border-2 border-red-700">
             <div id="randomThiefIcon" class="w-12 h-12 mx-auto mb-3 text-red-500"></div>
            <h4 class="text-xl font-bold text-red-400 mb-2">El Ladrón de Tildes ataca...</h4>
            <p id="randomThiefDialogue" class="text-gray-300 mb-4 italic h-10"></p>
            <div id="randomThiefEffect" class="hidden bg-gray-900 p-4 rounded-lg">
                <p id="randomThiefEffectText" class="text-lg font-bold text-gray-200"></p>
            </div>
            <button id="randomThiefCloseButton" class="hidden mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Continuar</button>
        </div>
    </div>

     <!-- Modal for Thief's Deal -->
    <div id="thiefDealModal" class="fixed inset-0 boss-modal-bg flex justify-center items-center p-4 z-[260] hidden opacity-0 transition-opacity duration-200">
        <div class="bg-gray-800 text-white p-8 max-w-md w-full text-center rounded-xl shadow-2xl border-2 border-red-700">
             <div id="thiefDealIcon" class="w-12 h-12 mx-auto mb-3 text-red-500"></div>
            <h4 class="text-xl font-bold text-red-400 mb-2">Un Trato Inesperado</h4>
            <p id="thiefDealDialogue" class="text-gray-300 mb-4 h-16"></p>
            <div id="thiefDealButtons" class="hidden justify-center gap-4 mt-6">
                <button id="acceptDealButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Aceptar Trato</button>
                <button id="rejectDealButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Rechazar</button>
            </div>
        </div>
    </div>

    <!-- Modal for Guardian of the Limbo -->
    <div id="guardianModal" class="fixed inset-0 christopher-modal-bg flex justify-center items-center p-4 z-[250] hidden opacity-0 transition-opacity duration-200">
        <div class="bg-white text-gray-800 p-8 max-w-md w-full text-center rounded-xl shadow-2xl rainbow-border">
            <div id="guardianIcon" class="w-12 h-12 mx-auto mb-3 text-indigo-500"></div>
            <h4 class="text-xl font-bold text-indigo-700 mb-2">El Guardián del Limbo</h4>
            <p id="guardianDialogue" class="text-gray-600 mb-4 h-24"></p>
            <div id="guardianButtons" class="hidden justify-center gap-4 mt-6">
                <button id="acceptGiftButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">Aceptar Don</button>
                <button id="rejectGiftButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">Rechazar</button>
            </div>
        </div>
    </div>


    <!-- Modal for Game Over -->
    <div id="gameOverScreen" class="fixed inset-0 bg-red-900/80 backdrop-blur-sm hidden flex flex-col justify-center items-center p-0 z-[300]">
        <div class="bg-red-800 text-white p-8 w-full h-full text-center flex flex-col justify-center items-center">
            <h2 class="text-5xl font-extrabold mb-4">GAME OVER</h2>
            <p id="gameOverMessage" class="text-lg mb-6"></p>
            <button id="backToGameFromGameOver" class="bg-white text-red-800 font-bold py-3 px-6 rounded-full transition duration-150 transform hover:scale-105">
                Volver a intentarlo
            </button>
        </div>
    </div>

    <!-- Pantalla de Victoria -->
    <div id="winScreen" class="fixed inset-0 bg-green-900/80 backdrop-blur-sm hidden flex flex-col justify-center items-center p-0 z-[300]">
        <div class="bg-green-700 text-white p-8 w-full h-full text-center flex flex-col justify-center items-center">
            <h2 class="text-5xl font-extrabold mb-4">¡HAS GANADO!</h2>
            <p id="winMessage" class="text-lg mb-6"></p>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button id="seguirJugandoButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-full transition duration-150 transform hover:scale-105">
                    Seguir jugando (x<span id="nextMultiplier">2</span>)
                </button>
                <button id="reiniciarButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full transition duration-150 transform hover:scale-105">
                    Reiniciar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Prestige Upgrades -->
    <div id="prestigeScreen" class="fixed inset-0 modal-bg hidden items-center justify-center p-4 z-[100]">
        <div class="w-full max-w-2xl bg-white p-6 rounded-2xl shadow-2xl max-h-[90vh] hide-scrollbar overflow-y-auto border-4 border-yellow-400">
            <div class="flex items-center justify-center mb-4">
                <h2 class="text-3xl font-black text-yellow-800">Mejoras de Prestigio</h2>
            </div>
            <p class="text-center text-gray-600 mb-6">Puntos de Prestigio disponibles: <span id="prestigePointsDisplay" class="font-bold text-yellow-600">0</span></p>
            <div id="prestigeUpgradesContainer">
                <!-- Upgrades will be injected here by JS -->
            </div>
            <div class="text-center mt-6">
                <button id="backToGameFromPrestige" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition duration-150 transform hover:scale-105">
                    Cerrar
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- API & User Variables ---
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyqvInhl4qdBpQIpuHofXc2T7tEfBOy544yWJUD1axxosj_zSmF4TSPU9QNNAe9F8G0/exec';
        let playerCredentials = null; // { playerName, playerID }
        let rankingUpdateInterval = null;


        // --- Game State Variables ---
        let playerMoney = 100;
        let playerWords = {};
        let usedChallengeWords = {};
        let currentWord = {};
        let passiveIncome = 0;
        let gameMultiplier = 1;
        let initialCredits = 100;
        let consecutiveFailures = 0;
        let shields = { universal: 0 };
        let prestigePoints = 0;
        let prestigeUpgrades = {
            aumentoGeneracionRiqueza: 0,
            reduccionInflacion: 0,
            recompensasDesafio: 0,
            duracionPotenciadores: 0,
            suerteAumentada: 0,
            descuentoTienda: 0,
            presagioLadron: 0,
            enganoLadron: 0
        };
        let playerStats = {
            wordsBought: 0,
            challengesWon: 0,
            bossesDefeatedCount: 0,
            gameFormats: 0,
        };
        
        // --- Timers and Intervals ---
        let animationFrameId = null;
        let lastUpdateTime = 0;
        let timeSinceLastIncomeUpdate = 0;
        let wordDisplayTimeout;
        let challengeInterval = null;
        let challengeTimerInterval;
        let isChallengeActive = false;
        let randomThiefAttackInterval = null;
        
        // --- Bonus State ---
        let universalShieldEndTime = 0;
        let christopherBoostEndTime = 0;
        let superValueBoosts = {}; 
        let limboGramaticalEndTime = 0;
        let limboGramaticalTriggeredThisPartida = false;
        let dealRejectedForLimboBoost = false;
        let hasHadFirstRandomAttackThisPartida = false;
        let confusionModeEndTime = 0;

        // --- UI & Game Flow ---
        let currentView = 'startup';
        let gameStarted = false;
        let hasBoughtFirstWord = false;
        let gamePausedForFeedback = false;
        let activeChallengeOnLoad = false;
        let visibilityChangeHandler = null;
        let confirmCallback = null;
        let currentChallengeData = {};

        // --- Boss Variables ---
        let bossesDefeated = [], whisperInterval = null;
        const BOSS_MILESTONES = { 1: 35, 2: 80, 3: 120 }; 
        let currentBossLevel = 0, currentBossSentence = {};
        let bossTimerInterval;
        let isBossActive = false;
        let isWhispering = false;
        let activeWhisper = "";
        let corruptedWordsBought = 0;
        
        // --- Game Constants ---
        const PRICE_PER_LETTER = 15;
        const SUPER_VALUE_MULTIPLIER = 2;
        const INFLATION_FACTOR = 100;
        const SHIELD_PRICE_UNIVERSAL = 1000000;
        const LIFE_PRICE = 2000000;
        const CHALLENGE_REWARDS = { base: 50000 };
        
        const CORRUPTED_WORDS = [
            { wrong: "Lapiz", right: "Lápiz", category: "Llanas" }, { wrong: "Arbol", right: "Árbol", category: "Llanas" },
            { wrong: "Cafe", right: "Café", category: "Agudas" }, { wrong: "Sofa", right: "Sofá", category: "Agudas" },
            { wrong: "Musica", right: "Música", category: "Esdrújulas" }, { wrong: "Pagina", right: "Página", category: "Esdrújulas" },
            { wrong: "Compas", right: "Compás", category: "Agudas" }, { wrong: "Dificil", right: "Difícil", category: "Llanas" },
            { wrong: "Celula", right: "Célula", category: "Esdrújulas" }, { wrong: "Jamas", right: "Jamás", category: "Agudas" },
            { wrong: "Marmol", right: "Mármol", category: "Llanas" }, { wrong: "Bebere", right: "Beberé", category: "Agudas" },
            { wrong: "Logico", right: "Lógico", category: "Esdrújulas" }, { wrong: "Angel", right: "Ángel", category: "Llanas" },
            { wrong: "Cancion", right: "Canción", category: "Agudas" }, { wrong: "Boligrafo", right: "Bolígrafo", category: "Esdrújulas" },
            { wrong: "Azucar", right: "Azúcar", category: "Llanas" }, { wrong: "Peru", right: "Perú", category: "Agudas" },
            { wrong: "Oxigeno", right: "Oxígeno", category: "Esdrújulas" }, { wrong: "Facil", right: "Fácil", category: "Llanas" },
            { wrong: "Ademas", right: "Además", category: "Agudas" }, { wrong: "Telefono", right: "Teléfono", category: "Esdrújulas" },
            { wrong: "Mastil", right: "Mástil", category: "Llanas" }, { wrong: "Ingles", right: "Inglés", category: "Agudas" },
            { wrong: "Murcielago", right: "Murciélago", category: "Esdrújulas" }, { wrong: "Trebol", right: "Trébol", category: "Llanas" },
            { wrong: "Acordeon", right: "Acordeón", category: "Agudas" }, { wrong: "Gomez", right: "Gómez", category: "Llanas" },
            { wrong: "Brujula", right: "Brújula", category: "Esdrújulas" }, { wrong: "Avion", right: "Avión", category: "Agudas" }
        ];

        const MINI_CHALLENGE_WORDS = {
            anagram: ["juego", "reto", "libro", "letra", "tilde", "error", "texto", "frase"],
            accent: [{wrong: "logica", right: "lógica"}, {wrong: "arabe", right: "árabe"}, {wrong: "video", right: "vídeo"}, {wrong: "camion", right: "camión"}, {wrong: "carcel", right: "cárcel"}, {wrong: "exito", right: "éxito"}, {wrong: "jamas", right: "jamás"}, {wrong: "ultimo", right: "último"}],
            trueFalse: [
                { word: "Reloj", category: "Agudas", isCorrect: true },
                { word: "Casa", category: "Agudas", isCorrect: false },
                { word: "Fácil", category: "Llanas", isCorrect: true },
                { word: "Libro", category: "Esdrújulas", isCorrect: false },
                { word: "Pájaro", category: "Esdrújulas", isCorrect: true },
                { word: "Resolver", category: "Llanas", isCorrect: false },
                { word: "Cantar", category: "Agudas", isCorrect: true },
                { word: "Lámpara", category: "Llanas", isCorrect: false },
            ]
        };
        
        const BOSS_INITIAL_DIALOGUES = [
            "Veo que has reunido un pequeño tesoro... Demuéstrame que mereces conservarlo.", "Tus palabras acumuladas cantan una melodía que me atrae. ¿Defenderás tu colección?",
            "Huelo el poder de la sintaxis en ti. Pero, ¿conoces la verdadera ortografía?", "Has sido descuidado. Dejaste un rastro de tildes olvidadas, y yo lo he seguido hasta aquí.",
            "Otro coleccionista... Creen que acumular es saber. Te enseñaré la diferencia.", "Las reglas son mis cadenas y tu conocimiento, la llave. No te la dejaré usar.",
            "¿Sientes ese peso en el aire? Son las tildes que has ignorado. Vengo a reclamarlas.", "Tus avances no han pasado desapercibidos. Es hora de una pequeña corrección.",
            "Me llaman ladrón, pero yo me considero un purista. Vengo a limpiar tu colección de errores.", "El conocimiento sin precisión es ruido. Y tú estás haciendo mucho ruido."
        ];
        const BOSS_VICTORY_DIALOGUES = [
            "Impresionante... Por ahora, tu conocimiento es tuyo. Pero volveré a sentir tu poder.", "Has demostrado tu valía, mortal. Disfruta de tu tesoro... mientras puedas.",
            "Me has vencido, sí. Pero recuerda que una sola tilde olvidada puede deshacerlo todo.", "Tu mente es aguda. Una herramienta peligrosa en las manos adecuadas. Hasta la próxima.",
            "Admito mi derrota. La precisión de tus tildes es un arma formidable."
        ];
        const BOSS_DEFEAT_DIALOGUES = [
            "Tu ignorancia es... deliciosa. Estas palabras estarán mejor conmigo.", "Tal como lo esperaba. Un simple acumulador sin verdadero conocimiento. Gracias por el tributo.",
            "Te falta práctica. Vuelve cuando sepas la diferencia entre un 'si' y un 'sí'.", "Un error tan simple... y tan costoso. Tus palabras ahora me pertenecen.",
            "La duda es el óxido del intelecto. Y el tuyo está completamente corroído."
        ];
        const BOSS_MOCKING_LAUGHTER = [ "Jajaja... ¿No te has dado cuenta?", "Tan predecible... Caíste de nuevo.", "Delicioso error. Sigue así.", "Mis trampas son sutiles, ¿no crees? Jaja." ];
        const THIEF_MOCKERY_ON_FAIL = [
            "He oído tu fallo desde las sombras. Patético.", "Incluso sin mi intervención, tropiezas. Divertido.",
            "¿Ves? La acentuación es un arte que no dominas.", "Cada error que cometes... me fortalece.", "Sigue así y no tendré ni que esforzarme en nuestro próximo encuentro."
        ];
        const BOSS_SENTENCES = {
            1: [
                { wrong: "El habil mecanico arreglo el automovil rapido.", right: "El hábil mecánico arregló el automóvil rápido." },
                { wrong: "El pajaro carpintero volaba rapido hacia el arbol.", right: "El pájaro carpintero volaba rápido hacia el árbol." },
                { wrong: "La musica clasica es mi pasion.", right: "La música clásica es mi pasión." },
                { wrong: "El volcan entro en erupcion ayer.", right: "El volcán entró en erupción ayer." },
                { wrong: "Jamas volvere a ese tragico lugar.", right: "Jamás volveré a ese trágico lugar." },
                { wrong: "El sabado por la mañana tomare un cafe.", right: "El sábado por la mañana tomaré un café." },
                { wrong: "El examen de matematicas fue dificil.", right: "El examen de matemáticas fue difícil." },
                { wrong: "La comunicacion es la clave del exito.", right: "La comunicación es la clave del éxito." },
                { wrong: "El agil ladron escapo por el tunel.", right: "El ágil ladrón escapó por el túnel." },
                { wrong: "El oceano Pacifico es inmenso.", right: "El océano Pacífico es inmenso." },
                { wrong: "La lampara ilumino la habitacion.", right: "La lámpara iluminó la habitación." },
                { wrong: "El helicoptero aterrizo con precision.", right: "El helicóptero aterrizó con precisión." }
            ],
            2: [
                { wrong: "Tu no sabes si el quiere te o cafe.", right: "Tú no sabes si él quiere té o café." },
                { wrong: "El me dijo que tu no sabias si el queria mas te.", right: "Él me dijo que tú no sabías si él quería más té." },
                { wrong: "Se que tu tienes mi libro, pero el no lo sabe.", right: "Sé que tú tienes mi libro, pero él no lo sabe." },
                { wrong: "Si tu vienes, el se ira.", right: "Si tú vienes, él se irá." },
                { wrong: "De mas de lo que el te pide.", right: "Dé más de lo que él te pide." },
                { wrong: "Aun no he terminado, aun cuando todos se han ido.", right: "Aún no he terminado, aun cuando todos se han ido." },
                { wrong: "Mi te es mas dulce que el de el.", right: "Mi té es más dulce que el de él." },
                { wrong: "No se si tu sabras la respuesta.", right: "No sé si tú sabrás la respuesta." },
                { wrong: "El solo quiere estar solo un momento.", right: "Él solo quiere estar solo un momento." },
                { wrong: "Tu decides si te quedas o te vas.", right: "Tú decides si te quedas o te vas." },
                { wrong: "El me aseguro que si vendra.", right: "Él me aseguró que sí vendrá." },
                { wrong: "A mi me gusta mas el te que a el.", right: "A mí me gusta más el té que a él." }
            ],
            3: [
                { wrong: "Aun no se como llego, mas le dire que su exito fue fantastico.", right: "Aún no sé cómo llegó, mas le diré que su éxito fue fantástico." },
                { wrong: "Dime que necesitas y cuando lo quieres para saber como ayudarte.", right: "Dime qué necesitas y cuándo lo quieres para saber cómo ayudarte." },
                { wrong: "Quien te dijo que y como lo supiste es un misterio.", right: "Quién te dijo qué y cómo lo supiste es un misterio." },
                { wrong: "No entiendo por que ries, ni cual es el motivo.", right: "No entiendo por qué ríes, ni cuál es el motivo." },
                { wrong: "Donde esta el libro del que te hable cuando te vi.", right: "Dónde está el libro del que te hablé cuando te vi." },
                { wrong: "Cuanto tempo ha pasado desde que el se fue.", right: "Cuánto tiempo ha pasado desde que él se fue." },
                { wrong: "El pregunto que cual era mi opinion sobre el.", right: "Él preguntó que cuál era mi opinión sobre él." },
                { wrong: "Solo se que no se nada, mas tu pareces saberlo todo.", right: "Solo sé que no sé nada, mas tú pareces saberlo todo." },
                { wrong: "El enfasis de su discurso fue sobre etica y moral.", right: "El énfasis de su discurso fue sobre ética y moral." },
                { wrong: "La peninsula iberica tiene un clima fantastico.", right: "La península ibérica tiene un clima fantástico." },
                { wrong: "Explicame por que no viniste y que hiciste.", right: "Explícame por qué no viniste y qué hiciste." },
                { wrong: "No se donde buscar ni a quien preguntar.", right: "No sé dónde buscar ni a quien preguntar." }
            ]
        };
        const BOSS_WHISPERS = ["Siento el peso de tantas palabras...", "Una tilde fuera de lugar... es una invitación.", "¿Crees que las acumulas solo para ti?", "El eco de una sílaba mal acentuada resuena...", "Un tesoro de conocimiento... tan fácil de despojar.", "Tu progreso es un faro en mi oscuridad..."];

        const ICON_LIBRARY = {
            'bossIcon': `<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle><path d="M10.5 14.5c.5.3 1.2.3 1.7 0 M8 9.5s1-1 4-1 4 1 4 1"/></svg>`,
            'christopherIcon': `<svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>`
        };
        
        const HUGE_WORD_DATABASE = {
             "Monosílabos": {
                value: 10,
                words: ["Sol", "Mar", "Luz", "Voz", "Pan", "Sal", "Miel", "Tren", "Flor", "Rey", "Son", "Paz", "Bien", "Mal", "Gas", "No", "Sí", "Yo", "Él", "Tú", "Ve", "Da", "Sé", "Vi", "Di", "Pie", "Fe", "Ley", "Don", "Fin", "Mes", "Mil", "Res", "Ron", "Set", "Sur", "Tal", "Tez", "Zas", "Dar", "Ver", "Mas", "Te", "Mi", "Si", "El", "Un", "La", "Los", "Las"],
                superValueWords: ["Flor", "Voz", "Rey", "Paz", "Luz", "Miel"],
                limit: 30
            },
            "Agudas": {
                value: 100,
                words: ["Acción", "Adicción", "Además", "Andén", "Balón", "Bebé", "Café", "Camión", "Canción", "Colibrí", "Corazón", "Después", "Emoción", "Interés", "Jabalí", "Jamás", "Jardín", "Jazmín", "Menú", "País", "París", "Pasión", "Perfección", "Portugués", "Revolución", "Sofá", "Solución", "También", "Visión", "Volcán", "Comió", "Estudió", "Habló", "Vivió", "Ganará", "Común", "Betún", "Calzón", "Dragón", "Francés", "Inglés", "Japonés", "Maní", "Ratón", "Tiburón", "Vudú", "Bambú", "Jabón", "Melón", "Patín"],
                superValueWords: ["Colibrí", "Jazmín", "Pasión", "Revolución", "Corazón", "Tiburón"],
                limit: 30
            },
            "Llanas": {
                value: 250,
                words: ["Árbol", "Ángel", "Azúcar", "Cáncer", "Cárcel", "Carácter", "Césped", "Clímax", "Cráter", "Día", "Difícil", "Dólar", "Éter", "Fácil", "Fósil", "Fútbol", "Huésped", "Lápiz", "Líder", "Mártir", "Móvil", "Nácar", "Poesía", "Póker", "Río", "Tórax", "Trébol", "Túnel", "Geografía", "Biología", "Filosofía", "Tecnología", "Psicología", "Economía", "Anatomía", "Sandía", "Policía", "Cómics", "Césped", "Fénix", "Hábil", "Inmóvil", "Referí", "Tándem", "Tótem", "Versátil", "Zombis", "Álbum", "Cáliz"],
                superValueWords: ["Carácter", "Cráter", "Poesía", "Geografía", "Fénix", "Filosofía"],
                limit: 30
            },
            "Esdrújulas": {
                value: 500,
                words: ["Análisis", "Antártida", "Atmósfera", "Bolígrafo", "Brújula", "Cálculo", "Catástrofe", "Círculo", "Clínica", "Cómpralo", "Déficit", "Esdrújula", "Estómago", "Éxito", "Fábrica", "Fósforo", "Gramática", "Hígado", "Héroe", "Hipócrita", "Índice", "Lágrima", "Lógico", "Mágico", "Máquina", "Matemáticas", "Médico", "Miércoles", "Murciélago", "Músculo", "Música", "Número", "Oxígeno", "Página", "Pájaro", "Plátano", "Público", "Química", "Rápido", "Sábado", "Semáforo", "Sílaba", "Teléfono", "Término", "Tráfico", "Último", "Vértebra", "Víctima", "Aéreo", "Célula", "Diálogo", "Época", "Gótico", "Jurásico", "Kilómetro", "Óptimo", "Párrafo", "Pirámide", "Sátira", "Técnica", "Vándalo"],
                superValueWords: ["Atmósfera", "Murciélago", "Científico", "Matemáticas", "Pirámide", "Jurásico"],
                limit: 30
            },
            "Sobreesdrújulas": {
                value: 1000000,
                words: ["Agradéceselo", "Apréndetelo", "Averíguamelo", "Búscaselo", "Comprándomelo", "Dígamelo", "Díceselo", "Enciéndemelo", "Entrégaselo", "Explícaselo", "Guárdaselo", "Hágaselo", "Júraselo", "Llévaselo", "Pídemelo", "Pásaselo", "Repíteselo", "Tráigaselo", "Véndeselo", "Dedicándoselo", "Estudiándotelo", "Explicándoselo", "Repitiéndoselo", "Comiéndoselo", "Escribiéndotelo", "Mirándoselo", "Preparándomelo", "Comprándoselo", "Llamándoselo", "Encontrándoselo", "Recibiéndoselo", "Entregándoselo", "Aceptándoselo", "Aconsejándoselo", "Acompañándotelo", "Aprendiéndotelo", "Bendiciéndotelo", "Buscándoselo", "Celebrándoselo", "Comentándoselo"],
                superValueWords: [],
                limit: 1
            }
        };

        let WORD_DATABASE = {}; 

        const categoryColors = { "Monosílabos": "text-gray-800", "Agudas": "text-green-800", "Llanas": "text-yellow-800", "Esdrújulas": "text-blue-800", "Sobreesdrújulas": "text-purple-800" };
        const categoryBackgrounds = { "Monosílabos": "bg-gray-200", "Agudas": "bg-green-200", "Llanas": "bg-yellow-200", "Esdrújulas": "bg-blue-200", "Sobreesdrújulas": "bg-purple-200" };
        
        const prestigeUpgradeInfo = {
            aumentoGeneracionRiqueza: { title: "Aumento de Riqueza", desc: "Aumenta la generación de riqueza pasiva.", effect: level => `+${level}%`, icon: `<svg class="w-6 h-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2.01M12 14v4m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M12 14c1.657 0 3-.895 3-2s-1.343-2-3-2-3-.895-3-2 1.343-2 3-2m0 8c-1.11 0-2.08-.402-2.599 1M12 14v-1m0 1v.01M12 16v-1m0 1V18" /></svg>`, colors: "bg-green-50 border-green-200 text-green-800" },
            reduccionInflacion: { title: "Control de Inflación", desc: "Reduce el efecto de la inflación en el precio de las palabras.", effect: level => `-${(level * 0.5)}%`, icon: `<svg class="w-6 h-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>`, colors: "bg-red-50 border-red-200 text-red-800" },
            recompensasDesafio: { title: "Recompensas de Desafío", desc: "Aumenta el dinero ganado en los retos del diccionario.", effect: level => `+${(level * 2)}%`, icon: `<svg class="w-6 h-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0a3 3 0 110 6H9l-2 2V8a2 2 0 012-2z" /></svg>`, colors: "bg-blue-50 border-blue-200 text-blue-800" },
            duracionPotenciadores: { title: "Duración de Potenciadores", desc: "Aumenta la duración de los bonus Christopher y Super Value.", effect: level => `+${(level * 0.5)}s`, icon: `<svg class="w-6 h-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`, colors: "bg-purple-50 border-purple-200 text-purple-800" },
            suerteAumentada: { title: "Suerte Aumentada", desc: "Aumenta la probabilidad de eventos especiales como el Limbo Gramatical.", effect: level => `+${(level * 0.05)}%`, icon: `<svg class="w-6 h-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`, colors: "bg-yellow-50 border-yellow-200 text-yellow-800" },
            descuentoTienda: { title: "Descuento en Tienda", desc: "Reduce el precio de los artículos de la tienda.", effect: level => `-${(level * 0.25)}%`, icon: `<svg class="w-6 h-6 text-pink-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>`, colors: "bg-pink-50 border-pink-200 text-pink-800" },
            presagioLadron: { title: "Presagio del Ladrón", desc: "El ladrón susurra antes, dándote más tiempo para prepararte.", effect: level => `+${level} palabras`, icon: `<svg class="w-6 h-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`, colors: "bg-gray-50 border-gray-200 text-gray-800" },
            enganoLadron: { title: "Engaño al Ladrón", desc: "Reduce la penalización de tiempo en el reto del Ladrón por cada palabra corrupta comprada.", effect: level => `-${level * 0.5}%/palabra`, icon: `<svg class="w-6 h-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>`, colors: "bg-red-50 border-red-200 text-red-800" }
        };

        function getLeagueInfo(multiplier) {
            if (multiplier >= 250) return { name: "Leyenda Ortográfica", color: "#b71c1c", gradient: "bg-gradient-leyenda", reward: 50, base: 125 };
            if (multiplier >= 150) return { name: "Maestro", color: "#6a1b9a", gradient: "bg-gradient-maestro", reward: 35, base: 100 };
            if (multiplier >= 100) return { name: "Diamante", color: "#0277bd", gradient: "bg-gradient-diamante", reward: 20, base: 75 };
            if (multiplier >= 50) return { name: "Platino", color: "#00838f", gradient: "bg-gradient-platino", reward: 10, base: 50 };
            if (multiplier >= 25) return { name: "Oro", color: "#f9a825", gradient: "bg-gradient-oro", reward: 5, base: 25 };
            if (multiplier >= 10) return { name: "Plata", color: "#616161", gradient: "bg-gradient-plata", reward: 2, base: 10 };
            return { name: "Bronce", color: "#8d6e63", gradient: "bg-gradient-bronze", reward: 0, base: 1 };
        }
        
        function generatePlaythroughWordDatabase() {
            WORD_DATABASE = {};
            for (const category in HUGE_WORD_DATABASE) {
                const baseCategory = HUGE_WORD_DATABASE[category];
                const allWords = [...baseCategory.words];
                const wordsForThisGame = [];
                for(let i=0; i<baseCategory.limit && allWords.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * allWords.length);
                    wordsForThisGame.push(allWords.splice(randomIndex, 1)[0]);
                }
                WORD_DATABASE[category] = { ...baseCategory, words: wordsForThisGame.length > 0 ? wordsForThisGame : baseCategory.words };
            }
            WORD_DATABASE["Sobreesdrújulas"].words = HUGE_WORD_DATABASE["Sobreesdrújulas"].words;
        }

        function applyScalingToWordDatabase(multiplier) {
             Object.keys(WORD_DATABASE).forEach(category => {
                if(HUGE_WORD_DATABASE[category]){
                    WORD_DATABASE[category].value = HUGE_WORD_DATABASE[category].value * multiplier;
                }
            });
        }

        function recalculatePassiveIncome() {
            passiveIncome = 0;
            const now = Date.now();
            Object.keys(playerWords).forEach(category => {
                if (playerWords[category] && WORD_DATABASE[category] && category !== "Sobreesdrújulas") {
                    const count = playerWords[category].count || 0;
                    const baseValue = WORD_DATABASE[category].value;
                    let categoryIncome = count * baseValue;
                    if (superValueBoosts[category] && now < superValueBoosts[category]) categoryIncome *= SUPER_VALUE_MULTIPLIER;
                    passiveIncome += categoryIncome;
                }
            });
            if (prestigeUpgrades.aumentoGeneracionRiqueza > 0) passiveIncome *= (1 + prestigeUpgrades.aumentoGeneracionRiqueza * 0.01);
        }
        
        function resetGameData() {
            let baseCredits = 100;
            for(let i = 1; i < gameMultiplier; i++) baseCredits *= 2;
            initialCredits = baseCredits;
            playerMoney = initialCredits;
            passiveIncome = 0;
            usedChallengeWords = {};
            shields = { universal: 0 };
            christopherBoostEndTime = 0;
            superValueBoosts = {};
            universalShieldEndTime = 0;
            limboGramaticalEndTime = 0;
            hasBoughtFirstWord = false;
            limboGramaticalTriggeredThisPartida = false;
            dealRejectedForLimboBoost = false;
            bossesDefeated = [];
            corruptedWordsBought = 0;
            hasHadFirstRandomAttackThisPartida = false;
            confusionModeEndTime = 0;
            playerStats = { wordsBought: 0, challengesWon: 0, bossesDefeatedCount: 0, gameFormats: gameMultiplier - 1 };
            generatePlaythroughWordDatabase();
            Object.keys(WORD_DATABASE).forEach(category => playerWords[category] = { count: 0, list: [] });
        }
        
        function resetProgressButKeepLives() {
            passiveIncome = 0;
            Object.keys(playerWords).forEach(category => {
                if (playerWords[category]) {
                    playerWords[category].count = 0;
                    playerWords[category].list = [];
                }
            });
        }

        async function formatearJuego() {
            document.getElementById('seguirJugandoButton').disabled = true;
            document.getElementById('reiniciarButton').disabled = true;

            const failuresToKeep = consecutiveFailures;
            gameMultiplier++;
            prestigePoints += gameMultiplier;
            playerStats.gameFormats = gameMultiplier - 1;
            resetGameData(); 
            consecutiveFailures = failuresToKeep;
            applyScalingToWordDatabase(gameMultiplier);
            await updatePlayerScore();
            savePlayerData(); 
            updateUI();
            changeView('game');
            startGameCommon(false);
            showModal(`¡Juego formateado! Multiplicador: ${gameMultiplier}x. Has ganado ${gameMultiplier} Puntos de Prestigio.`);
        }

        async function clearRankingOnGameOver() {
            if (!playerCredentials) return;
            if (gameMultiplier > 1) {
                await apiRequest('POST', 'clearRankingScore', {
                    playerID: playerCredentials.playerID,
                    multiplier: gameMultiplier 
                });
            }
        }
        
        function initializeGameState() {
             playerMoney = 100; playerWords = {}; usedChallengeWords = {}; consecutiveFailures = 0; gameMultiplier = 1;
             shields = { universal: 0 }; prestigePoints = 0;
             prestigeUpgrades = { aumentoGeneracionRiqueza: 0, reduccionInflacion: 0, recompensasDesafio: 0, duracionPotenciadores: 0, suerteAumentada: 0, descuentoTienda: 0, presagioLadron: 0, enganoLadron: 0 };
             bossesDefeated = []; hasBoughtFirstWord = false; isWhispering = false; activeWhisper = ""; corruptedWordsBought = 0;
             hasHadFirstRandomAttackThisPartida = false; confusionModeEndTime = 0; dealRejectedForLimboBoost = false;
             playerStats = { wordsBought: 0, challengesWon: 0, bossesDefeatedCount: 0, gameFormats: 0 };
             generatePlaythroughWordDatabase();
             Object.keys(WORD_DATABASE).forEach(category => playerWords[category] = { count: 0, list: [] });
        }

        function showModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').classList.remove('hidden');
            document.getElementById('messageModal').classList.add('flex');
        }

        function showConfirmationModal(message, onConfirm) {
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('confirmationModal').classList.add('flex');
            document.getElementById('confirmationModal').classList.remove('hidden');
            confirmCallback = onConfirm;
        }

        function hideConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('flex');
            document.getElementById('confirmationModal').classList.add('hidden');
            confirmCallback = null;
        }

        function changeView(view) {
            currentView = view;
            ['gameScreen', 'startupScreen', 'shopScreen', 'gameOverScreen', 'winScreen', 'gameControls', 'tutorialScreen', 'prestigeScreen', 'rankingScreen', 'profileScreen'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
            const screen = document.getElementById(`${view}Screen`);
            if (screen) screen.classList.remove('hidden');
            if (view === 'game') document.getElementById('gameControls')?.classList.remove('hidden');
            else if (['shop', 'prestige', 'tutorial', 'ranking', 'profile'].includes(view)) {
                if (screen) screen.classList.add('flex');
                if (view === 'prestige') updatePrestigeUI();
                else if (view === 'shop') updateShopUI();
            }
        }
        
        async function startNewGame() {
            if(!playerCredentials) {
                showModal("Debes iniciar sesión para reiniciar tu progreso.");
                return;
            }
            showModal("Reiniciando tu cuenta...");
            const result = await apiRequest('POST', 'resetProgress', { playerID: playerCredentials.playerID });
            if (result.success) {
                initializeGameState(); 
                gameStarted = true;
                changeView('game');
                await startGameCommon(false); 
                showModal("Tu progreso ha sido reiniciado.");
            } else {
                showModal(`Error al reiniciar: ${result.error}`);
            }
        }
        
        async function continueGame() {
            if (!playerCredentials) {
                showModal("Por favor, inicia sesión para continuar.");
                return;
            }
            showModal("Cargando partida...");
            const result = await apiRequest('POST', 'loadGame', { playerID: playerCredentials.playerID });
            
            if (result.success) {
                parseSaveData(result.saveData);
                
                if (result.seasonReward) {
                    showModal(`¡Fin de temporada! Alcanzaste la liga ${result.seasonReward.league} y ganaste ${result.seasonReward.points} Puntos de Prestigio. Tu multiplicador se ha reajustado.`);
                    gamePausedForFeedback = true; 
                }

                gameStarted = true;
                changeView('game');
                
                if (!result.seasonReward) {
                    await startGameCommon(false);
                    document.getElementById('messageModal').classList.add('hidden');
                }

            } else {
                showModal(`Error al cargar: ${result.error}`);
            }
        }

        function updateShopUI() {
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            const limboDiscount = isLimboActive ? 0.79 : 1;
            const prestigeDiscount = 1 - (prestigeUpgrades.descuentoTienda * 0.0025);
            const shieldPrice = Math.floor(SHIELD_PRICE_UNIVERSAL * limboDiscount * prestigeDiscount);
            const lifePrice = Math.floor(LIFE_PRICE * limboDiscount * prestigeDiscount);

            const buyUniversalShieldBtn = document.getElementById('buyUniversalShield');
            buyUniversalShieldBtn.innerHTML = `Comprar (${shieldPrice.toLocaleString('es-ES', { useGrouping: true }).replace(/\./g, ',')})`;
            if (prestigeUpgrades.descuentoTienda > 0) {
                const discountValue = (prestigeUpgrades.descuentoTienda * 0.25).toFixed(2).replace('.', ',');
                buyUniversalShieldBtn.innerHTML += ` <span class="text-xs opacity-80">-${discountValue}%</span>`;
            }
            buyUniversalShieldBtn.disabled = playerMoney < shieldPrice;
            buyUniversalShieldBtn.classList.toggle('opacity-50', buyUniversalShieldBtn.disabled);
            buyUniversalShieldBtn.classList.toggle('cursor-not-allowed', buyUniversalShieldBtn.disabled);
            document.getElementById('universalCount').textContent = shields.universal;

            const buyLifeBtn = document.getElementById('buyLifeButton');
            buyLifeBtn.innerHTML = `Comprar (${lifePrice.toLocaleString('es-ES', { useGrouping: true }).replace(/\./g, ',')})`;
            if (prestigeUpgrades.descuentoTienda > 0) {
                const discountValue = (prestigeUpgrades.descuentoTienda * 0.25).toFixed(2).replace('.', ',');
                buyLifeBtn.innerHTML += ` <span class="text-xs opacity-80">-${discountValue}%</span>`;
            }
            buyLifeBtn.disabled = !(playerMoney >= lifePrice && consecutiveFailures > 0);
            buyLifeBtn.classList.toggle('opacity-50', buyLifeBtn.disabled);
            buyLifeBtn.classList.toggle('cursor-not-allowed', buyLifeBtn.disabled);
        }

        function buyShield() {
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            const price = SHIELD_PRICE_UNIVERSAL * (isLimboActive ? 0.79 : 1) * (1 - (prestigeUpgrades.descuentoTienda * 0.0025));
            if (playerMoney >= price) {
                playerMoney -= price;
                shields.universal++;
                updateUI();
                updateShopUI();
                savePlayerData();
                showModal(`¡Escudo Universal comprado! Tienes ${shields.universal}.`);
            } else {
                showModal(`¡No tienes suficiente dinero!`);
            }
        }
        
        function buyLife() {
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            const price = LIFE_PRICE * (isLimboActive ? 0.79 : 1) * (1 - (prestigeUpgrades.descuentoTienda * 0.0025));
            if (consecutiveFailures > 0 && playerMoney >= price) {
                playerMoney -= price;
                consecutiveFailures--;
                updateUI();
                updateShopUI();
                savePlayerData();
                showModal(`¡Has recuperado una vida!`);
            } else if (consecutiveFailures === 0) {
                 showModal(`Tienes todas tus vidas.`);
            } else {
                showModal(`¡No tienes suficiente dinero!`);
            }
        }

        function startWordDisplayTimer(duration) {
            clearTimeout(wordDisplayTimeout);
            wordDisplayTimeout = setTimeout(() => {
                if (!isChallengeActive) generateNewWord(true);
            }, duration);
        }

        function triggerLimboGramatical() {
            stopGameLoops();
            gamePausedForFeedback = true;

            const modal = document.getElementById('guardianModal');
            const dialogueEl = document.getElementById('guardianDialogue');
            const buttons = document.getElementById('guardianButtons');

            document.getElementById('guardianIcon').innerHTML = ICON_LIBRARY.christopherIcon;
            dialogueEl.textContent = '';
            buttons.classList.add('hidden');

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 20);

            typeEffect(dialogueEl, "Soy el Guardián del Limbo. Tu valor al rechazar la oscuridad del Ladrón ha abierto un camino hasta mí.", () => {
                setTimeout(() => {
                    typeEffect(dialogueEl, "Como recompensa por tu entereza, te ofrezco restaurar tus fuerzas y otorgarte protección. ¿Aceptas mi regalo?", null);
                }, 500);
            });
        }


        async function generateNewWord(forceNew = false) {
            if (isChallengeActive) return;
            
            if (hasBoughtFirstWord && !limboGramaticalTriggeredThisPartida && dealRejectedForLimboBoost) {
                dealRejectedForLimboBoost = false; 
                limboGramaticalTriggeredThisPartida = true;
                triggerLimboGramatical();
                return;
            }

            if (forceNew) clearTimeout(wordDisplayTimeout);
            
            const isConfusionActive = Date.now() < confusionModeEndTime;
            if (isConfusionActive && Math.random() < 0.70) { 
                const randomCorrupted = CORRUPTED_WORDS[Math.floor(Math.random() * CORRUPTED_WORDS.length)];
                const category = randomCorrupted.category;
                const inflationReduction = 1 - (prestigeUpgrades.reduccionInflacion * 0.005);
                const inflationMultiplier = 1 + (passiveIncome / INFLATION_FACTOR) * inflationReduction;
                const dynamicValue = Math.floor((HUGE_WORD_DATABASE[category].value * gameMultiplier + (randomCorrupted.wrong.length * PRICE_PER_LETTER)) * inflationMultiplier);
                currentWord = { word: randomCorrupted.wrong, category: category, value: dynamicValue, isCorrupted: true, rightVersion: randomCorrupted.right, startTime: Date.now() };
                updateUI();
                startWordDisplayTimer(3000);
                return;
            }


            if (isWhispering && Math.random() < 0.15) { // Reducido de 0.35 a 0.15
                const randomCorrupted = CORRUPTED_WORDS[Math.floor(Math.random() * CORRUPTED_WORDS.length)];
                const category = randomCorrupted.category;
                const inflationReduction = 1 - (prestigeUpgrades.reduccionInflacion * 0.005);
                const inflationMultiplier = 1 + (passiveIncome / INFLATION_FACTOR) * inflationReduction;
                const dynamicValue = Math.floor((HUGE_WORD_DATABASE[category].value * gameMultiplier + (randomCorrupted.wrong.length * PRICE_PER_LETTER)) * inflationMultiplier);
                currentWord = { word: randomCorrupted.wrong, category: category, value: dynamicValue, isCorrupted: true, rightVersion: randomCorrupted.right, startTime: Date.now() };
                updateUI();
                startWordDisplayTimer(3000);
                return;
            }
            
            const isLimboActive = Date.now() < limboGramaticalEndTime;
            let christopherChance = 0.03 + (prestigeUpgrades.suerteAumentada * 0.0005);

            if (Math.random() < christopherChance) {
                currentWord = { word: "CHRISTOPHER", category: "Bonus", value: 0, isBonus: true, startTime: Date.now() };
                updateUI();
                startWordDisplayTimer(1000 + (prestigeUpgrades.duracionPotenciadores * 500));
                return;
            }

            if (isLimboActive) {
                const allSuperValueWords = [];
                Object.keys(WORD_DATABASE).forEach(category => {
                    if (WORD_DATABASE[category].superValueWords?.length > 0) {
                        const ownedWords = playerWords[category]?.list || [];
                        WORD_DATABASE[category].superValueWords.forEach(svWord => {
                            if (!ownedWords.includes(svWord)) allSuperValueWords.push({ word: svWord, category: category });
                        });
                    }
                });
                if (allSuperValueWords.length > 0) {
                    const randomSV = allSuperValueWords[Math.floor(Math.random() * allSuperValueWords.length)];
                    let dynamicValue = (WORD_DATABASE[randomSV.category].value + (randomSV.word.length * PRICE_PER_LETTER)) * SUPER_VALUE_MULTIPLIER * 0.79;
                    currentWord = { word: randomSV.word, category: randomSV.category, value: dynamicValue, isSuperValue: true, startTime: Date.now() };
                    updateUI();
                    startWordDisplayTimer(3000);
                    return;
                }
            }
            
            const nonFinalCategories = Object.keys(WORD_DATABASE).filter(c => c !== "Sobreesdrújulas");
            const incompleteCategories = nonFinalCategories.filter(cat => playerWords[cat] && playerWords[cat].count < WORD_DATABASE[cat].limit);
            let categoryPool = (incompleteCategories.length > 0) ? incompleteCategories : nonFinalCategories;
            const allCategoriesCompleted = nonFinalCategories.every(cat => playerWords[cat] && playerWords[cat].count >= WORD_DATABASE[cat].limit);
            let randomCategory = allCategoriesCompleted ? "Sobreesdrújulas" : categoryPool[Math.floor(Math.random() * categoryPool.length)];
            let ownedWords = playerWords[randomCategory]?.list || [];
            let availableWords = (WORD_DATABASE[randomCategory]?.words || []).filter(word => !ownedWords.includes(word));
            
            if (availableWords.length === 0 && randomCategory !== "Sobreesdrújulas") { 
                setTimeout(() => generateNewWord(true), 50); 
                return;
            }
            if(availableWords.length === 0 && randomCategory === "Sobreesdrújulas") { }
            
            let randomWord = availableWords[Math.floor(Math.random() * availableWords.length)];
            let isSuperValue = (WORD_DATABASE[randomCategory].superValueWords || []).includes(randomWord);
            let dynamicValue = WORD_DATABASE[randomCategory].value;
            if (randomCategory !== "Sobreesdrújulas") {
                const inflationReduction = 1 - (prestigeUpgrades.reduccionInflacion * 0.005);
                const inflationMultiplier = 1 + (passiveIncome / INFLATION_FACTOR) * inflationReduction;
                dynamicValue = Math.floor((WORD_DATABASE[randomCategory].value + (randomWord.length * PRICE_PER_LETTER)) * inflationMultiplier);
                if (isSuperValue) dynamicValue *= SUPER_VALUE_MULTIPLIER;
            }
            currentWord = { word: randomWord, category: randomCategory, value: dynamicValue, isSuperValue, startTime: Date.now() };
            updateUI();
            startWordDisplayTimer(3000);
        }
        
        function formatNumber(num) {
            let parts = num.toFixed(1).toString().split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }


        function updateUI() {
            document.getElementById('playerMoney').textContent = Math.floor(playerMoney).toLocaleString('es-ES').replace(/\./g, ',');
            recalculatePassiveIncome();
            let finalPassiveIncome = passiveIncome;
            if (Date.now() < christopherBoostEndTime) finalPassiveIncome *= 2;
            if (Date.now() < limboGramaticalEndTime) finalPassiveIncome *= 1.21;
            document.getElementById('passiveIncome').textContent = formatNumber(finalPassiveIncome);

            const incomeBonusSpan = document.getElementById('prestigeIncomeBonus');
            if (prestigeUpgrades.aumentoGeneracionRiqueza > 0) {
                incomeBonusSpan.textContent = `(+${prestigeUpgrades.aumentoGeneracionRiqueza}%)`;
                incomeBonusSpan.classList.remove('hidden');
            } else {
                incomeBonusSpan.classList.add('hidden');
            }

            if (currentWord.word) {
                const currentWordEl = document.getElementById('currentWord');
                const wordCategoryEl = document.getElementById('wordCategory');
                const wordValueEl = document.getElementById('wordValue');
                
                if(currentWordEl && wordCategoryEl && wordValueEl) {
                    let wordClass = "";
                    if (currentWord.isBonus) wordClass = "rainbow-text font-black";
                    else if (currentWord.isSuperValue) wordClass = "super-value-text font-black";
                    else if (currentWord.isCorrupted) wordClass = "text-red-700 font-black";
                    else wordClass = `${categoryColors[currentWord.category] || "text-gray-800"} font-black`;
                    
                    currentWordEl.innerHTML = `<span class="${wordClass}">${currentWord.word}</span>`;
                    wordCategoryEl.textContent = currentWord.category;
                    
                    const buyButton = document.getElementById('buyButton');
                    let canAfford = playerMoney >= currentWord.value;
                    let isOwned = false;
                    let isCategoryComplete = false;

                    if (!currentWord.isBonus && !currentWord.isCorrupted && currentWord.category && playerWords[currentWord.category]) {
                        const categoryData = playerWords[currentWord.category];
                        const limit = WORD_DATABASE[currentWord.category]?.limit;
                        isCategoryComplete = categoryData && limit && categoryData.count >= limit;
                        isOwned = (categoryData.list || []).includes(currentWord.word);
                    }
                    
                     if (currentWord.category === "Sobreesdrújulas") {
                        const inflationReduction = 1 - (prestigeUpgrades.reduccionInflacion * 0.005);
                        currentWord.value = Math.floor(HUGE_WORD_DATABASE["Sobreesdrújulas"].value * inflationReduction);
                        canAfford = playerMoney >= currentWord.value;
                    }
                    
                    buyButton.disabled = !canAfford || isOwned || isCategoryComplete;
                    buyButton.classList.toggle('opacity-50', buyButton.disabled);
                    buyButton.classList.toggle('cursor-not-allowed', buyButton.disabled);

                    if (isCategoryComplete) {
                        wordValueEl.textContent = 'Categoría Completa';
                    } else {
                        let valueHTML = `${Math.floor(currentWord.value).toLocaleString('es-ES').replace(/\./g, ',')}`;
                        if (prestigeUpgrades.reduccionInflacion > 0 && currentWord.category !== "Sobreesdrújulas") {
                            const reductionValue = (prestigeUpgrades.reduccionInflacion * 0.5).toFixed(2).replace('.', ',');
                            valueHTML += ` <span class="text-xs text-green-600">(-${reductionValue}%)</span>`;
                        }
                        wordValueEl.innerHTML = valueHTML;
                    }
                }
            }

            updateShopUI();
            const remainingLives = Math.max(0, 3 - consecutiveFailures);
            const lifeCounter = document.getElementById('lifeCounter');
            lifeCounter.textContent = `${remainingLives}/3`;
            const lifeCounterContainer = document.getElementById('lifeCounterContainer');
            lifeCounterContainer.classList.remove('border-green-300', 'border-yellow-400', 'border-red-500');
            if (remainingLives === 3) lifeCounterContainer.classList.add('border-green-300');
            else if (remainingLives === 2) lifeCounterContainer.classList.add('border-yellow-400');
            else lifeCounterContainer.classList.add('border-red-500');
            
            const prestigeButton = document.getElementById('prestigeButton');
            prestigeButton.disabled = false;
            prestigeButton.classList.add('cursor-pointer');
            prestigeButton.classList.remove('cursor-default');
            if (gameMultiplier > 1) prestigeButton.classList.add('hover:bg-yellow-200', 'border-yellow-400');
            else prestigeButton.classList.remove('hover:bg-yellow-200', 'border-yellow-400');
            prestigeButton.classList.toggle('luck-glow', prestigeUpgrades.suerteAumentada > 0);
            document.getElementById('currentMultiplier').textContent = `${gameMultiplier}x`;
            
            const now = Date.now();
            const shopButton = document.getElementById('shopButton');

            const shieldIsActive = now < universalShieldEndTime;
            lifeCounterContainer.classList.toggle('shield-glow', shieldIsActive);

            const limboIsActive = now < limboGramaticalEndTime;
            shopButton.classList.toggle('limbo-glow', limboIsActive);
            
            const inventoryContainer = document.getElementById('inventoryContainer');
            inventoryContainer.innerHTML = '';
            Object.keys(WORD_DATABASE).forEach(category => {
                const data = playerWords[category] || { count: 0, list: [] };
                const limit = WORD_DATABASE[category].limit;
                const isCompleted = data.count >= limit;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = `relative flex-1 flex-shrink-0 text-center flex flex-col items-center justify-between p-2 rounded-lg shadow-md ${isCompleted ? "bg-gray-300 text-gray-500" : categoryBackgrounds[category]}`;
                
                const isChrisActive = Date.now() < christopherBoostEndTime;
                const isSuperValueActiveForThisCategory = superValueBoosts[category] && Date.now() < superValueBoosts[category];
                let boostIconsHTML = '<div class="absolute top-0 right-1 flex flex-col items-end">';
                if (isChrisActive && category !== "Sobreesdrújulas") boostIconsHTML += `<span class="rainbow-text font-bold text-xs">x2</span>`;
                if (isSuperValueActiveForThisCategory) boostIconsHTML += `<span class="super-value-text font-bold text-xs">x2</span>`;
                boostIconsHTML += '</div>';

                categoryDiv.innerHTML = `
                    ${boostIconsHTML}
                    <p class="font-bold ${categoryColors[category] || 'text-gray-800'}">${category}</p>
                    <p class="text-2xl font-extrabold ${categoryColors[category] || 'text-gray-800'}">${data.count}/${limit}</p>
                `;
                inventoryContainer.appendChild(categoryDiv);
            });
        }

        function buyWord() {
            if (playerMoney < currentWord.value) return;
            if (currentWord.isCorrupted) {
                playerMoney -= currentWord.value;
                corruptedWordsBought++;
                const isConfusionActive = Date.now() < confusionModeEndTime;
                if (isConfusionActive) {
                    showModal("¡Jajaja! Caíste en la trampa. Ese dinero es mío.");
                } else {
                    showWhisperModal(BOSS_MOCKING_LAUGHTER[Math.floor(Math.random() * BOSS_MOCKING_LAUGHTER.length)]);
                }
                savePlayerData();
                updateUI();
                generateNewWord(true);
                return;
            }
            let wordBought = false;
            if (currentWord.isBonus) {
                const now = Date.now();
                const baseDuration = 60000;
                const bonusDuration = prestigeUpgrades.duracionPotenciadores * 500;
                const remainingTime = (christopherBoostEndTime > now) ? (christopherBoostEndTime - now) : 0;
                christopherBoostEndTime = now + remainingTime + baseDuration + bonusDuration;
                wordBought = true;
            } else {
                const categoryData = playerWords[currentWord.category];
                if (categoryData.count < WORD_DATABASE[currentWord.category].limit && !categoryData.list.includes(currentWord.word)) {
                    playerMoney -= currentWord.value;
                    categoryData.count++;
                    categoryData.list.push(currentWord.word);
                    wordBought = true;
                    if (currentWord.isSuperValue) {
                        const now = Date.now();
                        const category = currentWord.category;
                        const baseDuration = 10000;
                        const bonusDuration = prestigeUpgrades.duracionPotenciadores * 500;
                        const remainingTime = (superValueBoosts[category] > now) ? (superValueBoosts[category] - now) : 0;
                        superValueBoosts[category] = now + remainingTime + baseDuration + bonusDuration;
                    }
                }
            }
            if (currentWord.category === "Sobreesdrújulas" && wordBought) {
                document.getElementById('winMessage').textContent = `¡VICTORIA! Has conseguido una palabra sobreesdrújula. Multiplicador actual: ${gameMultiplier}x.`;
                document.getElementById('nextMultiplier').textContent = gameMultiplier + 1;
                document.getElementById('seguirJugandoButton').disabled = false;
                document.getElementById('reiniciarButton').disabled = false;
                stopGameLoops();
                stopRulesRotator();
                savePlayerData();
                changeView('win');
                return;
            }
            if (wordBought) {
                if (!hasBoughtFirstWord) hasBoughtFirstWord = true;
                playerStats.wordsBought++;
                document.getElementById('buyButton').disabled = true;
                checkBossEncounter();
                savePlayerData();
                updateUI();
                clearTimeout(wordDisplayTimeout);
                const elapsedTime = Date.now() - currentWord.startTime;
                const duration = currentWord.isBonus ? 1000 : 3000;
                const newRemainingTime = Math.max(0, (duration - elapsedTime) - 1000);
                startWordDisplayTimer(newRemainingTime);
            }
        }
        
        function startThiefMiniChallenge(forcedType = null) {
            if (currentView !== 'game' || isChallengeActive || isBossActive) return;
            
            if (Date.now() < universalShieldEndTime) {
                showModal(`¡Protegido por el Escudo Universal! Reto evitado.`);
                return;
            }
            if (shields.universal > 0) {
                shields.universal--;
                universalShieldEndTime = Date.now() + 60000;
                savePlayerData();
                showModal("¡Escudo Universal activado por 60 segundos! Reto evitado.");
                return;
            }

            stopGameLoops();
            isChallengeActive = true;
            savePlayerData();

            const type = forcedType;
            currentChallengeData = { type };

            const modal = document.getElementById('thiefMiniChallengeModal');
            const descriptionEl = document.getElementById('challengeDescription');
            const questionEl = document.getElementById('challengeQuestion');
            const inputContainer = document.getElementById('challengeInputContainer');
            const buttonsContainer = document.getElementById('challengeButtonsContainer');
            const inputEl = document.getElementById('challengeInput');
            const timerEl = document.getElementById('challengeTimer');

            document.getElementById('thiefMiniChallengeIcon').innerHTML = ICON_LIBRARY.bossIcon;
            inputEl.value = '';

            let timeLeft;

            switch (type) {
                case 'anagram':
                    timeLeft = 30;
                    descriptionEl.textContent = 'Descifra la palabra:';
                    const wordToScramble = MINI_CHALLENGE_WORDS.anagram[Math.floor(Math.random() * MINI_CHALLENGE_WORDS.anagram.length)];
                    currentChallengeData.answer = wordToScramble;
                    questionEl.textContent = wordToScramble.split('').sort(() => 0.5 - Math.random()).join('');
                    inputContainer.classList.remove('hidden');
                    buttonsContainer.classList.add('hidden');
                    inputEl.focus();
                    break;
                case 'accent':
                    timeLeft = 20;
                    descriptionEl.textContent = 'Escribe la palabra con la tilde correcta:';
                    const accentChallenge = MINI_CHALLENGE_WORDS.accent[Math.floor(Math.random() * MINI_CHALLENGE_WORDS.accent.length)];
                    currentChallengeData.answer = accentChallenge.right;
                    questionEl.textContent = accentChallenge.wrong;
                    inputContainer.classList.remove('hidden');
                    buttonsContainer.classList.add('hidden');
                    inputEl.focus();
                    break;
                case 'trueFalse':
                    timeLeft = 20;
                    descriptionEl.textContent = '¿La clasificación es correcta?';
                    const tfChallenge = MINI_CHALLENGE_WORDS.trueFalse[Math.floor(Math.random() * MINI_CHALLENGE_WORDS.trueFalse.length)];
                    currentChallengeData.answer = tfChallenge.isCorrect;
                    questionEl.textContent = `"${tfChallenge.word}" - ${tfChallenge.category}`;
                    inputContainer.classList.add('hidden');
                    buttonsContainer.classList.remove('hidden');
                    buttonsContainer.classList.add('flex');
                    break;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            timerEl.textContent = timeLeft;
            challengeTimerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) endThiefMiniChallenge(null);
            }, 1000);
        }

        function endThiefMiniChallenge(playerAnswer) {
            clearInterval(challengeTimerInterval);
            isChallengeActive = false;
            gamePausedForFeedback = true;
            
            const modal = document.getElementById('thiefMiniChallengeModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            let isCorrect = false;
            let failureReason = "Respuesta incorrecta.";
            
            switch (currentChallengeData.type) {
                case 'anagram':
                case 'accent':
                    if (playerAnswer && playerAnswer.trim().toLowerCase() === currentChallengeData.answer.toLowerCase()) {
                        isCorrect = true;
                    }
                    if(!playerAnswer) failureReason = "No se introdujo ninguna palabra.";
                    else failureReason = `Incorrecto. La respuesta era "${currentChallengeData.answer}".`;
                    break;
                case 'trueFalse':
                    if (playerAnswer === currentChallengeData.answer) {
                        isCorrect = true;
                    }
                    failureReason = `Incorrecto. La clasificación era ${currentChallengeData.answer ? 'Verdadera' : 'Falsa'}.`;
                    break;
            }

            if(playerAnswer === null) failureReason = "Se acabó el tiempo.";

            if (isCorrect) {
                const rewardBonus = 1 + (prestigeUpgrades.recompensasDesafio * 0.02);
                const reward = CHALLENGE_REWARDS.base * rewardBonus;
                playerMoney += reward;
                showModal(`¡Correcto! Ganas ${reward.toLocaleString('es-ES', { useGrouping: true }).replace(/\./g, ',')}.`);
            } else {
                handleChallengeFailure(failureReason);
            }
        }
        
        function handleChallengeFailure(reason) {
            consecutiveFailures++;
            checkForThiefDeal(() => {
                showWhisperModal(THIEF_MOCKERY_ON_FAIL[Math.floor(Math.random() * THIEF_MOCKERY_ON_FAIL.length)], () => showFailureMessage(reason));
            });
        }
        
        function showFailureMessage(reason) {
            if (consecutiveFailures >= 3) {
                clearRankingOnGameOver();
                document.getElementById('gameOverMessage').textContent = `Fallaste 3 veces. Razón final: ${reason}`;
                stopGameLoops();
                stopRulesRotator();
                changeView('gameOver');
            } else {
                resetProgressButKeepLives();
                showModal(`¡Fallo! ${reason}. Has perdido tus palabras. Te quedan ${3 - consecutiveFailures} intentos.`);
            }
        }
       
        function showBossModal() {
            const modal = document.getElementById('bossModal');
            const modalContent = document.getElementById('bossModalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('opacity-0', 'scale-95');
            }, 20);
        }

        function hideBossModal(callback) {
            const modal = document.getElementById('bossModal');
            const modalContent = document.getElementById('bossModalContent');
            modal.classList.add('opacity-0');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                if (callback) callback();
            }, 300);
        }

        function checkBossEncounter() {
            if (isBossActive || isChallengeActive || currentView !== 'game') return;
            const totalWords = Object.values(playerWords).reduce((sum, cat) => sum + cat.count, 0);
            const nextBossLevel = bossesDefeated.length + 1;
            const milestone = BOSS_MILESTONES[nextBossLevel];
            if (!milestone || bossesDefeated.includes(nextBossLevel)) return;
            const whisperThreshold = milestone - 5 - (prestigeUpgrades.presagioLadron || 0);
            if (totalWords >= milestone) startBossChallenge(nextBossLevel);
            else if (totalWords >= whisperThreshold && !isWhispering) triggerWhisper();
        }

        function triggerWhisper() {
            isWhispering = true;
            activeWhisper = BOSS_WHISPERS[Math.floor(Math.random() * BOSS_WHISPERS.length)];
            displayActiveWhisper();
            savePlayerData();
        }

        function displayActiveWhisper() {
            if (!isWhispering) return;
            stopRulesRotator();
            showWhisperModal(activeWhisper);
        }

        function startBossChallenge(level) {
            isWhispering = false;
            activeWhisper = "";
            isBossActive = true;
            stopGameLoops();
            currentBossLevel = level;
            currentBossSentence = BOSS_SENTENCES[level][Math.floor(Math.random() * BOSS_SENTENCES[level].length)];
            const dialogueEl = document.getElementById('bossDialogue');
            const challengeContent = document.getElementById('bossChallengeContent');
            const sentenceEl = document.getElementById('bossChallengeSentence');
            const inputEl = document.getElementById('bossChallengeInput');
            const timerEl = document.getElementById('bossTimer');
            document.getElementById('bossIconContainer').innerHTML = ICON_LIBRARY.bossIcon;
            challengeContent.classList.add('hidden');
            inputEl.value = '';
            dialogueEl.textContent = '';
            showBossModal();
            const dialogueText = BOSS_INITIAL_DIALOGUES[Math.floor(Math.random() * BOSS_INITIAL_DIALOGUES.length)];
            typeEffect(dialogueEl, dialogueText, () => {
                challengeContent.classList.remove('hidden');
                sentenceEl.textContent = currentBossSentence.wrong;
                inputEl.focus();
                const totalTime = 60;
                const timeDebuffPerWord = 0.03 * (1 - ((prestigeUpgrades.enganoLadron || 0) * 0.005));
                const timeDebuff = totalTime * timeDebuffPerWord * corruptedWordsBought;
                let timeLeft = Math.max(15, Math.floor(totalTime - timeDebuff));
                timerEl.textContent = timeLeft;
                bossTimerInterval = setInterval(() => {
                    timeLeft--;
                    timerEl.textContent = timeLeft;
                    if (timeLeft <= 0) endBossChallenge(false);
                }, 1000);
            });
            inputEl.onkeyup = (event) => {
                if (event.key === 'Enter') endBossChallenge(inputEl.value.trim() === currentBossSentence.right);
            };
        }

        function typeEffect(element, text, callback) {
            let i = 0;
            element.textContent = '';
            const modalContent = element.closest('.bg-gray-800, .bg-white');
            const dealButtons = modalContent?.querySelector('#thiefDealButtons');
            const giftButtons = modalContent?.querySelector('#guardianButtons');
            const closeButton = modalContent?.querySelector('#thiefWhisperCloseButton, #randomThiefCloseButton, #christopherFissureCloseButton');

            if (dealButtons) dealButtons.classList.add('hidden');
            if (giftButtons) giftButtons.classList.add('hidden');
            if (closeButton) closeButton.classList.add('hidden');

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, 50); // Slower speed
                } else {
                    if (dealButtons) {
                        dealButtons.classList.remove('hidden');
                        dealButtons.classList.add('flex');
                    }
                    if (giftButtons) {
                        giftButtons.classList.remove('hidden');
                        giftButtons.classList.add('flex');
                    }
                    if (closeButton) closeButton.classList.remove('hidden');
                    
                    if (callback) setTimeout(callback, 500); 
                }
            }
            type();
        }

        async function endBossChallenge(isCorrect) {
            clearInterval(bossTimerInterval);
            isBossActive = false;
            gamePausedForFeedback = true;
            document.getElementById('bossChallengeContent').classList.add('hidden');
            const dialogueEl = document.getElementById('bossDialogue');
            dialogueEl.textContent = '';

            if (isCorrect) {
                bossesDefeated.push(currentBossLevel);
                playerStats.bossesDefeatedCount = bossesDefeated.length;
                let prestigeReward = { 1: 3, 2: 5, 3: 8 }[currentBossLevel] || 0;
                prestigePoints += prestigeReward;
                const finalDialogue = BOSS_VICTORY_DIALOGUES[Math.floor(Math.random() * BOSS_VICTORY_DIALOGUES.length)];
                const resultMessage = `¡VICTORIA! Ganas ${prestigeReward} Puntos de Prestigio.`;
                typeEffect(dialogueEl, finalDialogue, () => hideBossModal(() => {
                    showModal(resultMessage);
                    updatePlayerScore();
                    if (consecutiveFailures < 3) changeView('game');
                }));
            } else {
                consecutiveFailures++;
                checkForThiefDeal(() => {
                    let moneyLost = playerMoney * ({ 1: 0.10, 2: 0.20, 3: 0.30 }[currentBossLevel] || 0);
                    playerMoney = Math.max(0, playerMoney - Math.floor(moneyLost));
                    const finalDialogue = BOSS_DEFEAT_DIALOGUES[Math.floor(Math.random() * BOSS_DEFEAT_DIALOGUES.length)];
                    const resultMessage = `¡DERROTA! El Ladrón te roba ${Math.floor(moneyLost).toLocaleString('es-ES', { useGrouping: true }).replace(/\./g, ',')}. Pierdes 1 vida.`;
                    typeEffect(dialogueEl, finalDialogue, () => hideBossModal(() => {
                        if (consecutiveFailures >= 3) {
                            clearRankingOnGameOver(); 
                            document.getElementById('gameOverMessage').textContent = `Fallaste 3 veces. El Ladrón de Tildes fue tu perdición.`;
                            stopGameLoops();
                            changeView('gameOver');
                            gamePausedForFeedback = false;
                        } else {
                            showModal(resultMessage);
                            if (consecutiveFailures < 3) changeView('game');
                        }
                    }));
                });
            }
        }

        function triggerRandomThiefAttack() {
            if (!gameStarted || isBossActive || isChallengeActive || currentView !== 'game' || !hasBoughtFirstWord) return;
            
            const rand = Math.random();
            if (rand < 0.01) { startThiefMiniChallenge('anagram'); }
            else if (rand < 0.11) { startThiefMiniChallenge('accent'); }
            else if (rand < 0.26) { startThiefMiniChallenge('trueFalse'); }
        }

        function showRandomThiefAttackModal(dialogue, getAttackDetailsCallback) {
            const modal = document.getElementById('randomThiefAttackModal');
            const dialogueEl = document.getElementById('randomThiefDialogue');
            const effectDiv = document.getElementById('randomThiefEffect');
            const effectTextEl = document.getElementById('randomThiefEffectText');
            const closeButton = document.getElementById('randomThiefCloseButton');

            document.getElementById('randomThiefIcon').innerHTML = ICON_LIBRARY.bossIcon;
            
            dialogueEl.textContent = '';
            effectDiv.classList.add('hidden');
            closeButton.classList.add('hidden');

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 20);

            typeEffect(dialogueEl, dialogue, () => {
                const { title, effectText, onComplete } = getAttackDetailsCallback();
                modal.querySelector('h4').textContent = `El Ladrón de Tildes ataca: ${title}`;
                effectTextEl.textContent = effectText;
                effectDiv.classList.remove('hidden');
                onComplete(); 
                setTimeout(() => {
                    closeButton.classList.remove('hidden');
                    gamePausedForFeedback = true; 
                }, 1500);
            });
        }

        function showWhisperModal(dialogue, onclose) {
            const modal = document.getElementById('thiefWhisperModal');
            const dialogueEl = document.getElementById('thiefWhisperDialogue');
            
            document.getElementById('thiefWhisperIcon').innerHTML = ICON_LIBRARY.bossIcon;
            
            modal.classList.remove('hidden', 'opacity-0');
            
            typeEffect(dialogueEl, dialogue, () => {
                 document.getElementById('thiefWhisperCloseButton').onclick = () => {
                    modal.classList.add('hidden', 'opacity-0');
                    if (onclose) onclose();
                };
            });
        }

        function checkForThiefDeal(callbackOnNoDeal) {
            if ( (3 - consecutiveFailures) === 1 ) {
                stopGameLoops();
                gamePausedForFeedback = true;

                let bestCategory = null;
                let maxIncome = -1;

                Object.keys(playerWords).forEach(category => {
                    if (playerWords[category] && WORD_DATABASE[category] && category !== "Sobreesdrújulas" && playerWords[category].count > 0) {
                        const count = playerWords[category].count;
                        const baseValue = WORD_DATABASE[category].value;
                        const categoryIncome = count * baseValue;
                        if (categoryIncome > maxIncome) {
                            maxIncome = categoryIncome;
                            bestCategory = category;
                        }
                    }
                });

                if (bestCategory) {
                    const modal = document.getElementById('thiefDealModal');
                    const dialogueEl = document.getElementById('thiefDealDialogue');
                    const buttons = document.getElementById('thiefDealButtons');
                    buttons.classList.add('hidden');
                    document.getElementById('thiefDealIcon').innerHTML = ICON_LIBRARY.bossIcon;
                    
                    modal.classList.remove('hidden', 'opacity-0');
                    
                    typeEffect(dialogueEl, `Veo que estás al límite... Te ofrezco un trato. Te devuelvo una vida, pero a cambio me quedaré con todas tus palabras de la categoría "${bestCategory}". ¿Aceptas?`, () => {
                        buttons.classList.remove('hidden');
                        buttons.classList.add('flex');
                    });
                    
                    document.getElementById('acceptDealButton').onclick = () => {
                        consecutiveFailures--;
                        playerWords[bestCategory] = { count: 0, list: [] };
                        modal.classList.add('hidden', 'opacity-0');
                        showModal("Trato aceptado. Has recuperado una vida, pero tus palabras han desaparecido.");
                    };
                    document.getElementById('rejectDealButton').onclick = () => {
                        dealRejectedForLimboBoost = true;
                        modal.classList.add('hidden', 'opacity-0');
                        if (callbackOnNoDeal) callbackOnNoDeal();
                    };
                } else {
                    if (callbackOnNoDeal) callbackOnNoDeal();
                }

            } else {
                if (callbackOnNoDeal) callbackOnNoDeal();
            }
        }
        
        async function deletePlayerFromRanking() {
            const nameToDelete = prompt("Introduce el nombre exacto del jugador que deseas eliminar del ranking:");
            if (nameToDelete) {
                showModal(`Eliminando a ${nameToDelete}...`);
                const result = await apiRequest('POST', 'deletePlayer', { playerName: nameToDelete });
                if (result.success) {
                    showModal(`${nameToDelete} ha sido eliminado del ranking.`);
                    if (currentView === 'ranking') {
                        fetchRanking();
                    }
                } else {
                    showModal(`Error al eliminar: ${result.error}`);
                }
            }
        }

        async function savePlayerData() {
            if (!playerCredentials || !gameStarted) return;
            try {
                const data = {
                    money: playerMoney, words: playerWords, used: usedChallengeWords, failures: consecutiveFailures, 
                    multiplier: gameMultiplier, credits: initialCredits, shields: shields, shieldEnd: universalShieldEndTime,
                    chrisEnd: christopherBoostEndTime, svBoosts: superValueBoosts, limboTriggered: limboGramaticalTriggeredThisPartida,
                    dealRejected: dealRejectedForLimboBoost,
                    prestigePoints: prestigePoints, prestigeUpgrades: prestigeUpgrades,
                    isChallengeActive: isChallengeActive, bossesDefeated: bossesDefeated, hasBoughtFirstWord: hasBoughtFirstWord,
                    isWhispering: isWhispering, activeWhisper: activeWhisper, corruptedWordsBought: corruptedWordsBought,
                    playerStats: playerStats, wordDatabaseVersion: 2.6, // Updated version
                    hasHadFirstRandomAttack: hasHadFirstRandomAttackThisPartida,
                    confusionEnd: confusionModeEndTime,
                };
                await apiRequest('POST', 'saveGame', { playerID: playerCredentials.playerID, saveDataJSON: JSON.stringify(data) });
            } catch (e) { console.error('Error saving data:', e); }
        }

        function parseSaveData(saveDataJSON) {
            try {
                const data = JSON.parse(saveDataJSON || "{}");
                 if (!data.wordDatabaseVersion || data.wordDatabaseVersion < 2.6) { initializeGameState(); return; }
                playerMoney = data.money || 100;
                playerWords = data.words || {};
                usedChallengeWords = data.used || {};
                consecutiveFailures = data.failures || 0;
                gameMultiplier = data.multiplier || 1;
                shields = data.shields || { universal: 0 };
                universalShieldEndTime = data.shieldEnd || 0;
                christopherBoostEndTime = data.chrisEnd || 0;
                superValueBoosts = data.svBoosts || {};
                limboGramaticalTriggeredThisPartida = data.limboTriggered || false;
                dealRejectedForLimboBoost = data.dealRejected || false;
                prestigePoints = data.prestigePoints || 0;
                prestigeUpgrades = data.prestigeUpgrades || { aumentoGeneracionRiqueza: 0, reduccionInflacion: 0, recompensasDesafio: 0, duracionPotenciadores: 0, suerteAumentada: 0, descuentoTienda: 0, presagioLadron: 0, enganoLadron: 0 };
                bossesDefeated = data.bossesDefeated || [];
                hasBoughtFirstWord = data.hasBoughtFirstWord || false;
                isWhispering = data.isWhispering || false;
                activeWhisper = data.activeWhisper || "";
                corruptedWordsBought = data.corruptedWordsBought || 0;
                playerStats = data.playerStats || { wordsBought: 0, challengesWon: 0, bossesDefeatedCount: 0, gameFormats: 0 };
                hasHadFirstRandomAttackThisPartida = data.hasHadFirstRandomAttack || false;
                confusionModeEndTime = data.confusionEnd || 0;
                if (data.isChallengeActive) activeChallengeOnLoad = true;
                let baseCredits = 100;
                for(let i = 1; i < gameMultiplier; i++) baseCredits *= 2;
                initialCredits = baseCredits;
                generatePlaythroughWordDatabase();
                if (gameMultiplier > 1) applyScalingToWordDatabase(gameMultiplier);
                Object.keys(WORD_DATABASE).forEach(category => { if (!playerWords[category]) playerWords[category] = { count: 0, list: [] }; });
            } catch (e) {
                console.error('Error parsing save data:', e);
                initializeGameState();
            }
        }
        
        function mainGameLoop(timestamp) {
            if (!lastUpdateTime) lastUpdateTime = timestamp;
            const deltaTime = timestamp - lastUpdateTime;
            lastUpdateTime = timestamp;
            timeSinceLastIncomeUpdate += deltaTime;
            if (timeSinceLastIncomeUpdate >= 1000) {
                let incomeThisSecond = passiveIncome;
                if (Date.now() < christopherBoostEndTime) incomeThisSecond *= 2;
                if(Date.now() < limboGramaticalEndTime) incomeThisSecond *= 1.21;
                playerMoney += incomeThisSecond;
                timeSinceLastIncomeUpdate = 0;
                updateUI();
            }
            updateTimerBarUI();
            animationFrameId = requestAnimationFrame(mainGameLoop);
        }
        
        function updateTimerBarUI() {
            if (!gameStarted || currentView !== 'game' || !currentWord.startTime) return;
            const bar = document.getElementById('wordTimerBar');
            if (!bar) return;
            const now = Date.now();
            const duration = currentWord.isBonus ? 1000 : 3000;
            const elapsedTime = now - currentWord.startTime;
            const timeLeft = Math.max(0, duration - elapsedTime);
            const percentage = (timeLeft / duration) * 100;
            bar.style.width = `${percentage}%`;
            if (timeLeft > (duration * 2/3)) bar.style.backgroundColor = '#ef4444'; 
            else if (timeLeft > (duration * 1/3)) bar.style.backgroundColor = '#eab308';
            else bar.style.backgroundColor = '#22c55e';
        }

        const accentuationRules = [
            { title: "Monosílabos", text: "Por regla general, no llevan tilde, salvo en casos de tilde diacrítica.", color: "text-gray-800"},
            { title: "Palabras Agudas", text: "Llevan tilde cuando terminan en 'n', 's' o vocal. La sílaba tónica es la última.", color: "text-green-700" },
            { title: "Palabras Llanas (o Graves)", text: "Llevan tilde cuando NO terminan en 'n', 's' o vocal. La sílaba tónica es la penúltima.", color: "text-yellow-700" },
            { title: "Palabras Esdrújulas", text: "Siempre llevan tilde. La sílaba tónica es la antepenúltima.", color: "text-blue-700" },
            { title: "Palabras Sobreesdrújulas", text: "Siempre llevan tilde. La sílaba tónica es anterior a la antepenúltima.", color: "text-purple-700" }
        ];
        let currentRuleIndex = 0;
        let rulesInterval = null;

        function startRulesRotator() {
            stopRulesRotator(); 
            const rulesContainer = document.getElementById('rulesContainer');
            if (rulesContainer) rulesContainer.classList.remove('hidden');
            const updateRule = () => {
                const rulesDisplay = document.getElementById('rulesDisplay');
                if (!rulesDisplay) return;
                rulesDisplay.style.opacity = 0;
                setTimeout(() => {
                    const rule = accentuationRules[currentRuleIndex];
                    rulesDisplay.innerHTML = `<h3 class="text-lg font-bold ${rule.color}">${rule.title}</h3><p class="text-gray-700">${rule.text}</p>`;
                    rulesDisplay.style.opacity = 1;
                    currentRuleIndex = (currentRuleIndex + 1) % accentuationRules.length;
                }, 200); 
            };
            updateRule(); 
            rulesInterval = setInterval(updateRule, 15000);
        }

        function stopRulesRotator() {
            if (rulesInterval) clearInterval(rulesInterval);
            rulesInterval = null;
            const rulesContainer = document.getElementById('rulesContainer');
            if(rulesContainer) rulesContainer.classList.add('hidden');
        }

        function startGameLoops() {
            if (animationFrameId || isBossActive) return;
            stopGameLoops();
            
            if (!isWhispering) {
                startRulesRotator();
            }
            animationFrameId = requestAnimationFrame(mainGameLoop);
            
            challengeInterval = setInterval(() => {
                if (hasBoughtFirstWord && !isChallengeActive && gameStarted && !isBossActive && currentView === 'game') {
                    const rand = Math.random();
                    if (rand < 0.01) { startThiefMiniChallenge('anagram'); }
                    else if (rand < 0.11) { startThiefMiniChallenge('accent'); }
                    else if (rand < 0.26) { startThiefMiniChallenge('trueFalse'); }
                }
            }, 5000);

            randomThiefAttackInterval = setInterval(() => {
                if (hasBoughtFirstWord && !isChallengeActive && gameStarted && !isBossActive && currentView === 'game' && Math.random() < 0.15) {
                    // triggerRandomThiefAttack is now integrated into a cinematic sequence
                }
            }, 5000);
        }
        
        function stopGameLoops() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            clearInterval(challengeInterval);
            clearInterval(rankingUpdateInterval);
            clearInterval(randomThiefAttackInterval);
            clearTimeout(wordDisplayTimeout);
            challengeInterval = null; rankingUpdateInterval = null; lastUpdateTime = 0;
            randomThiefAttackInterval = null;
        }
        
        async function startGameCommon(shouldLoad = true) {
             if (shouldLoad && playerCredentials) {
                 await continueGame();
             } else {
                 if (activeChallengeOnLoad) {
                    handleChallengeFailure("Reto abandonado al recargar la página.");
                    activeChallengeOnLoad = false;
                    isChallengeActive = false;
                 }
                startGameLoops();
                if(playerCredentials) rankingUpdateInterval = setInterval(updatePlayerScore, 30000);
                generateNewWord(true);
                setInterval(savePlayerData, 10000);
            }
        }
        
        async function apiRequest(method, action, params = {}) {
            if (APPS_SCRIPT_URL === 'PASTE_YOUR_NEW_GOOGLE_APPS_SCRIPT_URL_HERE') {
                console.error("API URL is not set. Please deploy the Google Apps Script and paste the URL.");
                return { success: false, error: "La URL de la API no ha sido configurada." };
            }
            
            try {
                // All requests go through POST to simplify server logic and CORS handling.
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, ...params, originalMethod: method })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API request failed for action "${action}":`, error);
                // Return a success false to avoid breaking the game flow
                return { success: false, error: "Error de red o del servidor. El guardado podría no funcionar." };
            }
        }
        
        async function fetchRanking() {
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = `<div class="flex justify-center items-center p-4"><div class="loading-spinner"></div><p class="ml-4">Cargando ranking...</p></div>`;
            
            const result = await apiRequest('POST', 'getRanking');

            if (result.success) {
                renderRanking(result.data);
            } else {
                rankingList.innerHTML = `<p class="text-center text-red-500 p-4">Error de conexión con el ranking: ${result.error}</p>`;
            }
        }
        
        function showRanking() {
            changeView('ranking');
            if (playerCredentials?.playerName) {
                fetchRanking();
            } else {
                 document.getElementById('rankingList').innerHTML = `<p class="text-center text-gray-500 p-4">Debes iniciar sesión para ver el ranking.</p>`;
            }
        }

        function renderRanking(rankingData) {
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';

            const christopherElement = document.createElement('div');
            christopherElement.className = 'p-3 rounded-lg flex items-center justify-between rainbow-border';
            christopherElement.innerHTML = `
                <div class="flex items-center">
                    <span class="font-bold text-lg text-yellow-500 w-8 text-center">#0</span>
                    <div class="ml-3">
                        <p class="font-bold rainbow-text">CHRISTOPHER</p>
                        <p class="text-xs font-semibold rainbow-text">El Guardián del Limbo</p>
                    </div>
                </div>
                <span class="font-bold text-lg text-yellow-500">∞</span>
            `;
            rankingList.appendChild(christopherElement);

            if (!rankingData || rankingData.length === 0) {
                rankingList.innerHTML += `<p class="text-center text-gray-500 p-4">El ranking está vacío. ¡Sé el primero!</p>`;
                return;
            }

            rankingData.forEach((player, index) => {
                const isCurrentUser = playerCredentials && player.name === playerCredentials.playerName;
                const leagueInfo = getLeagueInfo(player.multiplier);
                
                const playerElement = document.createElement('div');
                playerElement.className = `p-3 rounded-lg flex items-center justify-between transition duration-200 ${isCurrentUser ? 'bg-yellow-100 border-2 border-yellow-300' : 'bg-gray-50 hover:bg-gray-100'}`;

                playerElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-bold text-lg text-gray-400 w-8 text-center">${index + 1}</span>
                        <div class="ml-3">
                            <p class="font-bold text-gray-800">${player.name}</p>
                            <p class="text-xs font-semibold" style="color: ${leagueInfo.color};">${leagueInfo.name}</p>
                        </div>
                    </div>
                    <span class="font-bold text-lg text-gray-700">${player.multiplier}x</span>
                `;
                rankingList.appendChild(playerElement);
            });
        }

        async function updatePlayerScore() {
            if (!playerCredentials || !gameStarted) return;
            await apiRequest('POST', 'updateRanking', {
                playerID: playerCredentials.playerID,
                name: playerCredentials.playerName,
                multiplier: gameMultiplier,
                stats: playerStats
            });
        }

        async function handleLogin() {
            const nameInput = document.getElementById('playerNameInput');
            const playerName = nameInput.value.trim();
            if (playerName.length < 3 || playerName.length > 15) { showModal("Tu nombre debe tener entre 3 y 15 caracteres."); return; }
            if (!/^[a-zA-Z0-9_]+$/.test(playerName)) { showModal("El nombre solo puede contener letras, números y guiones bajos."); return; }

            showModal("Registrando y creando partida...");
            const result = await apiRequest('POST', 'registerUser', { playerName });

            if(result.success) {
                playerCredentials = { playerName: result.playerName, playerID: result.playerID };
                localStorage.setItem('dl_player_credentials', JSON.stringify(playerCredentials));
                document.getElementById('playerNameDisplay').textContent = result.playerName;
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('loggedInView').classList.remove('hidden');
                document.getElementById('messageModal').classList.add('hidden');
                initializeGameState(); 
                if (playerCredentials.playerName === 'Didac') {
                    document.getElementById('adminDeleteButton').classList.remove('hidden');
                }
            } else {
                showModal(result.error);
            }
        }

        function handleLogout() {
            playerCredentials = null;
            localStorage.removeItem('dl_player_credentials');
            window.location.reload();
        }
        
        async function handleNameChange() {
            if (!playerCredentials) return;
            const newName = prompt("Introduce tu nuevo nombre:", playerCredentials.playerName);
            if (!newName || newName.trim() === playerCredentials.playerName) return;

            const trimmedName = newName.trim();
            if (trimmedName.length < 3 || trimmedName.length > 15) { showModal("Tu nombre debe tener entre 3 y 15 caracteres."); return; }
            if (!/^[a-zA-Z0-9_]+$/.test(trimmedName)) { showModal("El nombre solo puede contener letras, números y guiones bajos."); return; }

            showModal("Actualizando nombre...");
            const result = await apiRequest('POST', 'updatePlayerName', {
                playerID: playerCredentials.playerID,
                newName: trimmedName
            });

            if (result.success) {
                playerCredentials.playerName = trimmedName;
                localStorage.setItem('dl_player_credentials', JSON.stringify(playerCredentials));
                document.getElementById('playerNameDisplay').textContent = trimmedName;
                document.getElementById('profilePlayerName').textContent = trimmedName;
                showModal("¡Nombre actualizado con éxito!");
            } else {
                showModal(`Error: ${result.error}`);
            }
        }

        function updatePrestigeUI() {
            document.getElementById('prestigePointsDisplay').textContent = prestigePoints;
            const container = document.getElementById('prestigeUpgradesContainer');
            container.innerHTML = ''; 
            
            const list = document.createElement('ul');
            list.className = 'space-y-2';

            Object.keys(prestigeUpgrades).forEach(key => {
                const info = prestigeUpgradeInfo[key];
                const level = prestigeUpgrades[key] || 0;
                
                const listItem = document.createElement('li');
                listItem.className = `bg-gray-50 p-3 rounded-lg flex items-center justify-between transition duration-200 hover:bg-gray-100`;

                listItem.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="font-bold text-gray-800" title="${info.desc}">${info.title}</h3>
                        <p class="text-xs text-gray-600">Nivel <span class="font-semibold text-blue-600">${level}</span> | Efecto: <span class="font-semibold text-green-600">${info.effect(level)}</span></p>
                    </div>
                    <div class="flex-shrink-0 ml-4">
                        <button id="upgrade-${key}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-4 text-sm rounded-full transition duration-150 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            Mejorar
                        </button>
                    </div>
                `;
                list.appendChild(listItem);
            });
            
            container.appendChild(list);

            Object.keys(prestigeUpgrades).forEach(key => {
                const button = document.getElementById(`upgrade-${key}`);
                if(button) {
                    button.disabled = prestigePoints < 1;
                    button.onclick = () => upgradePrestige(key);
                }
            });
        }
        
        function upgradePrestige(key) {
            if (prestigePoints > 0) {
                prestigePoints--;
                if (!prestigeUpgrades[key]) prestigeUpgrades[key] = 0;
                prestigeUpgrades[key]++;
                updatePrestigeUI();
                savePlayerData();
            }
        }

        function copyPlayerID() {
            const input = document.getElementById('playerIDCopyInput');
            input.select();
            input.setSelectionRange(0, 99999); 
            try {
                navigator.clipboard.writeText(input.value).then(() => {
                    showModal("¡ID copiado al portapapeles!");
                }).catch(() => {
                    document.execCommand('copy');
                    showModal("¡ID copiado al portapapeles!");
                });
            } catch (err) {
                 showModal("No se pudo copiar el ID. Por favor, cópialo manualmente.");
            }
        }

        async function showProfile() {
            changeView('profile');
            const profileDataEl = document.getElementById('profileData');
            const profileLoadingEl = document.getElementById('profileLoading');
            profileLoadingEl.classList.remove('hidden');
            profileDataEl.classList.add('hidden');

            if (!playerCredentials) {
                showModal("Debes iniciar sesión para ver tu perfil.");
                changeView('startup');
                return;
            }

            document.getElementById('profilePlayerName').textContent = playerCredentials.playerName;
            document.getElementById('profileMultiplier').textContent = `${gameMultiplier}x`;
            document.getElementById('playerIDCopyInput').value = playerCredentials.playerID;
            
            const leagueInfo = getLeagueInfo(gameMultiplier);
            const profileCard = document.getElementById('profileCard');
            const profileLeagueEl = document.getElementById('profileLeague');
            
            profileLeagueEl.textContent = leagueInfo.name;
            profileLeagueEl.style.color = leagueInfo.color;
            
            profileCard.classList.remove('bg-gradient-bronze', 'bg-gradient-plata', 'bg-gradient-oro', 'bg-gradient-platino', 'bg-gradient-diamante', 'bg-gradient-maestro', 'bg-gradient-leyenda');
            profileCard.classList.add(leagueInfo.gradient);

            const result = await apiRequest('POST', 'getPlayerProfileData', { playerName: playerCredentials.playerName });

            if(result.success) {
                document.getElementById('profileRank').textContent = result.rank ? `#${result.rank}` : 'N/A';
            } else {
                document.getElementById('profileRank').textContent = '#?';
            }

            profileLoadingEl.classList.add('hidden');
            profileDataEl.classList.remove('hidden');
        }


        async function handleLoginWithID() {
            const idInput = document.getElementById('playerIDInput');
            const playerID = idInput.value.trim();
            if (!playerID) {
                showModal("Por favor, introduce un ID de jugador.");
                return;
            }
            showModal("Cargando partida con ID...");
            
            const result = await apiRequest('POST', 'loadGame', { playerID });
            
            if (result.success && result.playerName) {
                playerCredentials = { playerName: result.playerName, playerID: playerID };
                localStorage.setItem('dl_player_credentials', JSON.stringify(playerCredentials));
                
                document.getElementById('playerNameDisplay').textContent = result.playerName;
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('loggedInView').classList.remove('hidden');
                
                parseSaveData(result.saveData);
                gameStarted = true;
                changeView('game');
                await startGameCommon(false); 
                document.getElementById('messageModal').classList.add('hidden');
                if (playerCredentials.playerName === 'Didac') {
                    document.getElementById('adminDeleteButton').classList.remove('hidden');
                }
            } else {
                showModal(result.error || "No se pudo encontrar la partida. Verifica el ID.");
                idInput.value = '';
            }
        }

        function setupEventListeners() {
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            document.getElementById('playGameButton').addEventListener('click', continueGame);
            document.getElementById('tutorialButton').addEventListener('click', () => changeView('tutorial'));
            document.getElementById('buyButton').addEventListener('click', buyWord);
            document.getElementById('shopButton').addEventListener('click', () => changeView('shop'));
            document.getElementById('prestigeButton').addEventListener('click', () => changeView('prestige'));
            document.getElementById('homeButton').addEventListener('click', () => {
                stopGameLoops();
                if(gameStarted) savePlayerData();
                changeView('startup');
            });

            document.getElementById('backToGameFromTutorial').addEventListener('click', () => changeView('startup'));
            document.getElementById('backToGameFromShop').addEventListener('click', () => changeView('game'));
            document.getElementById('backToGameFromPrestige').addEventListener('click', () => changeView('game'));
            
            document.getElementById('buyUniversalShield').addEventListener('click', buyShield);
            document.getElementById('buyLifeButton').addEventListener('click', buyLife);
            
            document.getElementById('profileButton').addEventListener('click', showProfile);
            document.getElementById('backToHomeFromProfile').addEventListener('click', () => changeView('startup'));
            document.getElementById('copyPlayerIDButton').addEventListener('click', copyPlayerID);
            document.getElementById('editPlayerNameButton').addEventListener('click', handleNameChange);
            document.getElementById('profileResetProgressButton').addEventListener('click', () => showConfirmationModal("¿Estás seguro? Perderás todo tu progreso permanentemente.", startNewGame));
            document.getElementById('profileLogoutButton').addEventListener('click', () => showConfirmationModal("¿Estás seguro de que quieres cerrar sesión?", handleLogout));

            document.getElementById('showLoginWithId').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('registerSection').classList.add('hidden');
                document.getElementById('loginWithIdSection').classList.remove('hidden');
            });
            document.getElementById('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loginWithIdSection').classList.add('hidden');
                document.getElementById('registerSection').classList.remove('hidden');
            });
            document.getElementById('loginWithIdButton').addEventListener('click', handleLoginWithID);
            
            document.getElementById('adminDeleteButton').addEventListener('click', deletePlayerFromRanking);

            document.getElementById('modalCloseButton').addEventListener('click', () => {
                document.getElementById('messageModal').classList.add('hidden');
                if (gamePausedForFeedback) {
                    gamePausedForFeedback = false;
                    if (consecutiveFailures < 3 && !isBossActive) {
                       startGameLoops();
                       generateNewWord(true);
                       savePlayerData();
                    }
                }
            });
            
             document.getElementById('confirmYesButton').addEventListener('click', () => { 
                if (confirmCallback) confirmCallback(); 
                hideConfirmationModal(); 
            });
            document.getElementById('confirmNoButton').addEventListener('click', hideConfirmationModal);

            document.getElementById('thiefWhisperCloseButton').addEventListener('click', (e) => {
                e.target.closest('.boss-modal-bg').classList.add('hidden', 'opacity-0');
            });

             document.getElementById('randomThiefCloseButton').addEventListener('click', () => {
                const modal = document.getElementById('randomThiefAttackModal');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);

                if (gamePausedForFeedback) {
                    gamePausedForFeedback = false;
                    if (consecutiveFailures < 3 && !isBossActive) {
                       startGameLoops();
                       generateNewWord(true);
                       savePlayerData();
                    }
                }
            });
            document.getElementById('wordsModalCloseButton').addEventListener('click', () => document.getElementById('wordsModal').classList.add('hidden'));
            
            document.getElementById('backToGameFromGameOver').addEventListener('click', async () => {
                await startNewGame();
            });
            document.getElementById('seguirJugandoButton').addEventListener('click', formatearJuego);
            document.getElementById('reiniciarButton').addEventListener('click', async () => {
                await startNewGame();
            });

            document.getElementById('acceptGiftButton').addEventListener('click', () => {
                const modal = document.getElementById('guardianModal');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);

                consecutiveFailures = 0;
                shields.universal += 3;
                limboGramaticalEndTime = Date.now() + 120000;
                
                showModal("¡Don aceptado! Tus vidas han sido restauradas, has recibido 3 escudos y el LIMBO GRAMATICAL ha comenzado.");

                if (gamePausedForFeedback) {
                    gamePausedForFeedback = false;
                    startGameLoops();
                    generateNewWord(true);
                }
            });

            document.getElementById('rejectGiftButton').addEventListener('click', () => {
                const modal = document.getElementById('guardianModal');
                const dialogueEl = document.getElementById('guardianDialogue');
                const buttons = document.getElementById('guardianButtons');
                buttons.classList.add('hidden');

                typeEffect(dialogueEl, "Comprendo tu decisión. Que tu camino sea firme.", () => {
                    setTimeout(() => {
                        modal.classList.add('opacity-0');
                        setTimeout(() => modal.classList.add('hidden'), 300);

                        if (gamePausedForFeedback) {
                            gamePausedForFeedback = false;
                            startGameLoops();
                            generateNewWord(true);
                        }
                    }, 1500);
                });
            });

            document.getElementById('rankingButton').addEventListener('click', showRanking);
            document.getElementById('backToHomeFromRanking').addEventListener('click', () => changeView('startup'));

            document.getElementById('challengeInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') endThiefMiniChallenge(e.target.value);
            });
            document.getElementById('trueButton').addEventListener('click', () => endThiefMiniChallenge(true));
            document.getElementById('falseButton').addEventListener('click', () => endThiefMiniChallenge(false));

            window.addEventListener('beforeunload', () => {
                if(gameStarted) savePlayerData();
            });
        }

        async function initGame() {
            const savedCredentials = localStorage.getItem('dl_player_credentials');
            if (savedCredentials) {
                try {
                    playerCredentials = JSON.parse(savedCredentials);
                    document.getElementById('playerNameDisplay').textContent = playerCredentials.playerName;
                    document.getElementById('loginView').classList.add('hidden');
                    document.getElementById('loggedInView').classList.remove('hidden');

                    if (playerCredentials.playerName === 'Didac') {
                        document.getElementById('adminDeleteButton').classList.remove('hidden');
                    }
                } catch(e) {
                    console.error("Failed to parse credentials", e);
                    localStorage.removeItem('dl_player_credentials');
                    playerCredentials = null;
                }
            }
            changeView('startup');
            setupEventListeners();
        }
        
        window.onload = initGame;
    </script>
</body>
</html>
